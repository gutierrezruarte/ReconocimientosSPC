<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Control Médico de Ausentismos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js para métricas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Configuración de Tailwind para Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#1f2937',
                        darkcard: '#374151',
                        darkinput: '#4b5563',
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos de impresión unificados de ambos archivos */
        @media print {
            /* 1. Resetear márgenes y paddings del cuerpo para ocupar toda la hoja */
            body {
                padding: 0 !important;
                margin: 0 !important;
                background-color: white !important;
            }
            body * { visibility: hidden; }
            
            /* 2. Hacemos visible solo el contenedor imprimible y su contenido */
            #printable-form, #printable-form * { visibility: visible; }
            #printable-form { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100% !important; 
                height: 100%; /* Opcional, pero ayuda a controlar el flujo */
                padding: 0.5cm 1cm !important; /* Márgenes del documento A4 (ajustar según necesidad, 0.5cm arriba/abajo, 1cm a los lados) */
                background-color: white !important; 
                color: black !important; 
                border: none !important; 
                box-shadow: none !important; 
                /* Forzar que la hoja A4 se use al 100% */
                max-width: none !important; 
                max-height: none !important;
            }

            /* Asegurar que los contenedores del formulario no introduzcan padding/margen */
            #printable-form form,
            #printable-form .border-2,
            #printable-form .border-2 div {
                box-sizing: border-box !important;
            }

            .no-print { display: none !important; }
            canvas { visibility: visible; }
            textarea { resize: none; border: none; }
            /* Ocultar botón de tema en impresión */
            #theme-toggle { display: none !important; }
        }

        /* Estilos de interfaz y animaciones */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .pagination-controls { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; }
        .pagination-controls button { background-color: #d1d5db; padding: 0.25rem 0.75rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        .pagination-controls button:hover:not(:disabled) { background-color: #9ca3af; }
        .dark .pagination-controls button { background-color: #4b5563; color: #e5e7eb; }
        .dark .pagination-controls button:hover:not(:disabled) { background-color: #6b7280; }
        .pagination-controls button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-controls span { font-size: 0.875rem; color: #4b5563; }
        .dark .pagination-controls span { color: #9ca3af; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        .toast { animation: toastIn 0.5s ease-out forwards; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500; display: flex; align-items: center; gap: 0.75rem; }
        .toast.fade-out { animation: toastOut 0.5s ease-in forwards; }
        .toast-success { background-color: #d1fae5; color: #065f46; }
        .toast-error { background-color: #fee2e2; color: #991b1b; }
        .toast-warning { background-color: #fef3c7; color: #92400e; }
        /* Estilos de Dark Mode para scrollbar */
        .dark ::-webkit-scrollbar { width: 10px; height: 10px; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 5px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 font-sans dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- Botón de Modo Oscuro Global -->
    <button id="theme-toggle" onclick="toggleDarkMode()" class="fixed top-4 right-4 z-50 p-2 rounded-lg bg-white dark:bg-gray-800 text-gray-500 dark:text-yellow-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors focus:outline-none shadow-lg border border-gray-200 dark:border-gray-700" title="Alternar Modo Oscuro">
        <i class="fas fa-sun hidden dark:inline"></i><i class="fas fa-moon inline dark:hidden"></i>
    </button>

    <!-- Pantalla de Login -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">
        <div class="w-full max-w-sm p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg text-center border border-gray-200 dark:border-gray-700">
            <img src="https://raw.githubusercontent.com/gutierrezruarte/BibliotecaSPC/main/Escudo-1-279x300-removebg-preview.png" alt="Escudo Institucional" class="w-24 h-auto mx-auto mb-4">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Portal de Gestión Médica</h1>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Ingrese sus credenciales</p>
            <form id="login-form">
                <div class="space-y-4">
                    <input type="text" id="login-afiliado" placeholder="Número de Afiliado" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" required>
                    <input type="password" id="login-password" placeholder="Contraseña" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" required>
                     <p id="login-error" class="text-red-500 text-sm hidden"></p>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">
                        Ingresar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Pantalla de Selección de Rol -->
    <div id="role-selection-screen" class="hidden items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">
        <div class="w-full max-w-sm p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg text-center border border-gray-200 dark:border-gray-700">
             <i class="fas fa-user-shield text-5xl text-amber-500 mb-4"></i>
             <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Seleccionar Rol</h1>
             <p class="text-gray-600 dark:text-gray-400 mb-6">Usted tiene múltiples roles. Por favor, elija con cuál desea ingresar.</p>
             <div id="role-buttons-container" class="space-y-3"></div>
             <button onclick="goBackToLogin()" class="w-full text-gray-600 dark:text-gray-300 py-2 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-300 mt-4">Volver</button>
        </div>
    </div>

    <!-- Pantalla de Selección de Unidad -->
    <div id="unidad-selection-screen" class="hidden items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">
        <div class="w-full max-w-sm p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-lg text-center border border-gray-200 dark:border-gray-700">
             <i class="fas fa-building text-5xl text-green-600 mb-4"></i>
             <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Seleccionar Unidad</h1>
             <div class="space-y-4">
                <select id="login-unidad-select" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                <button onclick="continueLoginPersonal()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg">Continuar</button>
                <button onclick="goBackToLogin()" class="w-full text-gray-600 dark:text-gray-300 py-2 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-300">Volver</button>
             </div>
        </div>
    </div>

    <!-- Portal Principal -->
    <div id="main-portal" class="hidden">
        <div class="flex h-screen bg-gray-200 dark:bg-gray-900 transition-colors duration-300">
            <!-- Sidebar -->
            <div id="sidebar" class="w-64 bg-gray-800 dark:bg-gray-950 text-white flex flex-col no-print shadow-xl transition-colors duration-300">
                <div class="px-8 py-6 border-b border-gray-700">
                    <h2 class="text-2xl font-semibold">Control de Ausentismo</h2>
                    <p id="user-role" class="text-sm text-gray-400 capitalize"></p>
                </div>
                <nav class="flex-1 px-6 py-4 space-y-2 overflow-y-auto">
                    <!-- Links para Administrador -->
                    <div id="admin-links" class="hidden">
                        <a href="#" onclick="showView('inicio')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-home w-6"></i> Inicio</a>
                        <a href="#" onclick="showView('usuarios')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-users-cog w-6"></i> Gestionar Usuarios</a>
                        <a href="#" onclick="showView('importar')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-file-excel w-6"></i> Importar Personal</a>
                        <a href="#" onclick="showView('avisos-pendientes')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-folder-open w-6"></i> Avisos Pendientes</a>
                        <a href="#" onclick="showView('avisos-visados')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-folder-check w-6"></i> Avisos Visados</a>
                        <a href="#" onclick="showView('presentarse')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-calendar-check w-6"></i> Presentarse a Trabajar</a>
                        <a href="#" onclick="showView('registro')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-clipboard-list w-6"></i> Registro de Actividad</a>
                        <a href="#" onclick="showView('antecedentes')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-search-plus w-6"></i> Buscar Antecedentes</a>
                    </div>
                    <!-- Links para Personal -->
                    <div id="personal-links" class="hidden">
                         <a href="#" onclick="showView('inicio')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-home w-6"></i> Inicio</a>
                         <a href="#" onclick="showView('avisos-pendientes')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-folder-open w-6"></i> Avisos Pendientes</a>
                         <a href="#" onclick="showView('avisos-visados')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-folder-check w-6"></i> Avisos Visados</a>
                         <a href="#" onclick="showView('presentarse')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-calendar-check w-6"></i> Presentarse a Trabajar</a>
                         <a href="#" onclick="showView('antecedentes')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-search-plus w-6"></i> Buscar Antecedentes</a>
                    </div>
                    <!-- Links para Reconocimientos Médicos -->
                    <div id="reconocimientos-links" class="hidden">
                        <a href="#" onclick="showView('inicio')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-home w-6"></i> Inicio</a>
                        <a href="#" onclick="showView('pendientes')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-hourglass-half w-6"></i> Pendientes</a>
                        <a href="#" onclick="showView('completados')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-check-double w-6"></i> Completados</a>
                        <a href="#" onclick="showView('evaluados')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-history w-6"></i> Evaluados por Fecha</a>
                        <a href="#" onclick="showView('antecedentes')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-search-plus w-6"></i> Buscar Antecedentes</a>
                        <a href="#" onclick="showView('profesionales')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-user-md w-6"></i> Profesionales</a>
                        <a href="#" onclick="showView('presentarse')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-calendar-check w-6"></i> Presentarse a Trabajar</a>
                    </div>
                </nav>
                 <div class="px-6 py-4 mt-auto border-t border-gray-700">
                    <div class="flex gap-3 mb-3">
                        <button id="change-role-btn" onclick="goBackToRoleSelection()" class="hidden flex-grow bg-amber-600 text-white py-3 px-4 rounded-xl hover:bg-amber-700 transition duration-300 flex items-center justify-center space-x-2 shadow-md">
                            <i class="fas fa-exchange-alt"></i><span class="text-sm font-medium whitespace-nowrap">Cambiar Rol</span>
                        </button>
                        <button id="metrics-sidebar-btn" onclick="showView('metrics')" class="w-14 flex-shrink-0 bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 transition duration-300 flex items-center justify-center shadow-md" title="Métricas"><i class="fas fa-chart-pie text-lg"></i></button>
                    </div>
                    <button onclick="openChangePasswordModal()" class="w-full bg-slate-600 text-white py-3 px-4 rounded-xl hover:bg-slate-700 transition duration-300 flex items-center justify-center space-x-2 mb-3 shadow-md">
                        <i class="fas fa-lock"></i><span class="text-sm font-medium">Cambiar Contraseña</span>
                    </button>
                    <button onclick="logout()" class="w-full bg-red-700 text-white py-3 px-4 rounded-xl hover:bg-red-800 transition duration-300 flex items-center justify-center space-x-2 shadow-md">
                        <i class="fas fa-sign-out-alt"></i><span class="text-sm font-medium">Cerrar Sesión</span>
                    </button>
                </div>
            </div>

            <!-- Contenido Principal -->
            <div class="flex-1 flex flex-col overflow-hidden bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
                <header class="flex justify-between items-center p-6 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 no-print shadow-sm">
                    <h1 id="view-title" class="text-2xl font-semibold text-gray-800 dark:text-white transition-colors">Bienvenido</h1>
                </header>
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900 p-6 transition-colors duration-300">
                     <div id="inicio-view" class="view-content hidden fade-in"></div>
                    
                     <!-- NUEVO: VISTA DE MÉTRICAS -->
                    <div id="metrics-view" class="view-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6">
                             <div><h2 class="text-3xl font-bold text-gray-700 dark:text-white">Métricas Anuales</h2><p class="text-gray-500 dark:text-gray-400" id="metrics-subtitle">Estadísticas del año calendario en curso.</p></div>
                             <button onclick="calculateAndRenderMetrics()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition shadow"><i class="fas fa-sync-alt mr-2"></i>Actualizar Datos</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 flex items-center border dark:border-gray-700"><div class="p-4 bg-yellow-100 dark:bg-yellow-900/30 rounded-full text-yellow-600 dark:text-yellow-400 mr-4"><i class="fas fa-folder-open text-2xl"></i></div><div><p class="text-gray-500 dark:text-gray-400 text-sm">Total Carpetas (Año)</p><h3 id="metric-total-year" class="text-2xl font-bold text-gray-800 dark:text-white">...</h3></div></div>
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 flex items-center border dark:border-gray-700"><div class="p-4 bg-green-100 dark:bg-green-900/30 rounded-full text-green-600 dark:text-green-400 mr-4"><i class="fas fa-check-circle text-2xl"></i></div><div><p class="text-gray-500 dark:text-gray-400 text-sm">Visados Completos</p><h3 id="metric-completed-count" class="text-2xl font-bold text-gray-800 dark:text-white">...</h3></div></div>
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 flex items-center border dark:border-gray-700"><div class="p-4 bg-blue-100 dark:bg-blue-900/30 rounded-full text-blue-600 dark:text-blue-400 mr-4"><i class="fas fa-procedures text-2xl"></i></div><div><p class="text-gray-500 dark:text-gray-400 text-sm">Licencias Vigentes Hoy</p><h3 id="metric-active-count" class="text-2xl font-bold text-gray-800 dark:text-white">...</h3></div></div>
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 flex items-center border dark:border-gray-700"><div class="p-4 bg-purple-100 dark:bg-purple-900/30 rounded-full text-purple-600 dark:text-purple-400 mr-4"><i class="fas fa-calendar-day text-2xl"></i></div><div><p class="text-gray-500 dark:text-gray-400 text-sm">Día con Más Avisos</p><h3 id="metric-busy-day" class="text-lg font-bold text-gray-800 dark:text-white">...</h3></div></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border dark:border-gray-700"><h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-4 border-b dark:border-gray-600 pb-2">Encuadres (Diagnósticos) del Año</h3><div class="relative h-64 w-full"><canvas id="chart-encuadres"></canvas></div></div>
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border dark:border-gray-700"><h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-4 border-b dark:border-gray-600 pb-2">Frecuencia por Día de la Semana</h3><div class="relative h-64 w-full"><canvas id="chart-days"></canvas></div></div>
                        </div>
                        <div id="container-chart-units" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8 hidden border dark:border-gray-700"><h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-4 border-b dark:border-gray-600 pb-2">Comparativa Anual por Establecimiento</h3><div class="relative h-72 w-full"><canvas id="chart-units"></canvas></div></div>
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border dark:border-gray-700"><h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-4 border-b dark:border-gray-600 pb-2">Ranking Anual: Agentes con más días de licencia acumulados</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr><th class="px-6 py-3">#</th><th class="px-6 py-3">Afiliado</th><th class="px-6 py-3">Nombre</th><th class="px-6 py-3">Unidad</th><th class="px-6 py-3 text-center">Total Días Licencia</th><th class="px-6 py-3 text-center">Cant. Carpetas</th></tr></thead><tbody id="ranking-table-body"><tr><td colspan="6" class="text-center py-4">Calculando...</td></tr></tbody></table></div></div>
                    </div>

                    <div id="usuarios-view" class="view-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-700 dark:text-white">Gestión de Usuarios</h2><button onclick="openUsuarioModal()" class="bg-blue-600 text-white py-2 px-5 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center space-x-2 shadow"><i class="fas fa-user-plus"></i><span>Nuevo Usuario</span></button></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700"><div class="mb-4"><input type="text" id="search-usuarios" onkeyup="filterTable('usuarios-table')" placeholder="Buscar por Afiliado o Nombre..." class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('usuarios-table', 0)">Afiliado <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('usuarios-table', 1)">Nombre <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('usuarios-table', 2)">Roles <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3">Acciones</th></tr></thead><tbody id="usuarios-table"></tbody></table></div><div id="usuarios-table-pagination" class="pagination-controls mt-4"></div></div>
                    </div>

                    <div id="importar-view" class="view-content hidden fade-in">
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700"><p class="mb-4 text-gray-600 dark:text-gray-300">Seleccione un archivo Excel (.xlsx, .xls) con los datos del personal.</p><div class="flex items-center space-x-4"><input type="file" id="excel-file-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-700 focus:outline-none"><button onclick="handleFileUpload()" class="bg-green-600 text-white py-2 px-5 rounded-lg hover:bg-green-700 transition duration-300 flex-shrink-0 shadow"><i class="fas fa-upload mr-2"></i>Cargar</button></div><div id="import-status" class="mt-4"></div></div>
                    </div>
                    
                    <div id="avisos-pendientes-view" class="view-content hidden fade-in">
                         <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-700 dark:text-white">Avisos de Carpetas Pendientes</h2><div class="flex items-center space-x-2"><button onclick="openAvisosFechaModal()" class="bg-teal-500 text-white py-2 px-5 rounded-lg hover:bg-teal-600 transition duration-300 flex items-center space-x-2 shadow"><i class="fas fa-calendar-day"></i><span>Avisos por Período</span></button><button id="nuevo-aviso-btn" onclick="openAvisoModal()" class="bg-blue-600 text-white py-2 px-5 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center space-x-2 shadow"><i class="fas fa-plus"></i><span>Nuevo Aviso</span></button></div></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700"><div class="mb-4"><input type="text" id="search-avisos-pendientes" onkeyup="filterTable('avisos-pendientes-table')" placeholder="Buscar por Afiliado, Empleado o Unidad..." class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('avisos-pendientes-table', 0)">Afiliado <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('avisos-pendientes-table', 1)">Empleado <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('avisos-pendientes-table', 2)">Unidad <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('avisos-pendientes-table', 3)">Fecha Aviso <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('avisos-pendientes-table', 4)">Tipo Solicitud <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3" id="avisos-pendientes-actions-header">Acciones</th>
                        </tr></thead><tbody id="avisos-pendientes-table"></tbody></table></div><div id="avisos-pendientes-table-pagination" class="pagination-controls mt-4"></div></div>
                    </div>

                    <div id="avisos-visados-view" class="view-content hidden fade-in">
                         <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-700 dark:text-white">Avisos de Carpetas Visados</h2><button onclick="openAvisosFechaModal()" class="bg-teal-500 text-white py-2 px-5 rounded-lg hover:bg-teal-600 transition duration-300 flex items-center space-x-2 shadow"><i class="fas fa-calendar-day"></i><span>Avisos por Período</span></button></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="search-avisos-visados" onkeyup="filterTable('avisos-visados-table')" placeholder="Buscar..." class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"><select id="filtro-encuadra" onchange="showView('avisos-visados')" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"><option value="TODOS">Filtrar por Encuadre</option><option value="ART. 14">ART. 14</option><option value="ART. 19">ART. 19</option><option value="ART. 20">ART. 20</option><option value="ART. 29">ART. 29</option><option value="ART. 30">ART. 30</option><option value="ART. 30 BIS">ART. 30 BIS</option><option value="SIN JUSTIFICAR">SIN JUSTIFICAR</option></select></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('avisos-visados-table', 0)">Afiliado <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('avisos-visados-table', 1)">Empleado <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('avisos-visados-table', 2)">Unidad <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('avisos-visados-table', 3)">Fecha Aviso <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('avisos-visados-table', 4)">Diagnóstico <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('avisos-visados-table', 5)">Encuadre <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3">Acciones</th>
                        </tr></thead><tbody id="avisos-visados-table"></tbody></table></div><div id="avisos-visados-table-pagination" class="pagination-controls mt-4"></div></div>
                    </div>

                    <div id="pendientes-view" class="view-content hidden fade-in">
                         <h2 class="text-3xl font-bold mb-6 text-gray-700 dark:text-white">Incidentes Pendientes</h2>
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700"><div class="mb-4"><input type="text" id="search-pendientes" onkeyup="filterTable('pendientes-table')" placeholder="Buscar..." class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('pendientes-table', 0)">N° Incidente <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('pendientes-table', 1)">Afiliado <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('pendientes-table', 2)">Empleado <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('pendientes-table', 3)">Unidad <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('pendientes-table', 4)">Fecha Solicitud <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3">Acción</th></tr></thead><tbody id="pendientes-table"></tbody></table></div><div id="pendientes-table-pagination" class="pagination-controls mt-4"></div></div>
                    </div>

                    <div id="completados-view" class="view-content hidden fade-in">
                         <h2 class="text-3xl font-bold mb-6 text-gray-700 dark:text-white">Incidentes Completados</h2>
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700"><div class="mb-4"><input type="text" id="search-completados" onkeyup="filterTable('completados-table')" placeholder="Buscar..." class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('completados-table', 0)">N° Incidente <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('completados-table', 1)">Afiliado <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('completados-table', 2)">Empleado <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('completados-table', 3)">Unidad <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('completados-table', 4)">Fecha Evaluación <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3">Acción</th></tr></thead><tbody id="completados-table"></tbody></table></div><div id="completados-table-pagination" class="pagination-controls mt-4"></div></div>
                    </div>

                    <div id="evaluados-view" class="view-content hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-700 dark:text-white">Consultar Evaluados por Fecha</h2>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg mb-6 border dark:border-gray-700"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Fecha</label><input type="date" id="fecha-evaluados" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block w-full p-2.5"></div><button onclick="filtrarEvaluadosPorFecha()" class="bg-blue-600 text-white py-2.5 px-5 rounded-lg hover:bg-blue-700 transition duration-300 shadow">Buscar</button></div></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700"><div class="mb-4"><input type="text" id="search-evaluados" onkeyup="filterTable('evaluados-table')" placeholder="Buscar..." class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('evaluados-table', 0)">N° Incidente <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('evaluados-table', 1)">Afiliado <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('evaluados-table', 2)">Empleado <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('evaluados-table', 3)">Unidad <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('evaluados-table', 4)">Fecha Evaluación <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('evaluados-table', 5)">Encuadra <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3">Acción</th></tr></thead><tbody id="evaluados-table"></tbody></table></div><div id="evaluados-table-pagination" class="pagination-controls mt-4"></div></div>
                    </div>

                    <div id="antecedentes-view" class="view-content hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-700 dark:text-white">Buscar Antecedentes Médicos</h2>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg mb-6 border dark:border-gray-700">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">N° de Afiliado</label><input type="text" id="search-antecedentes-afiliado" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block w-full p-2.5"></div>
                                <div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Matrícula Profesional</label><input type="text" id="search-antecedentes-matricula" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block w-full p-2.5"></div>
                                <div class="flex space-x-2">
                                    <button onclick="searchAntecedentes()" class="bg-blue-600 text-white py-2.5 px-5 rounded-lg hover:bg-blue-700 transition duration-300 shadow flex-grow">Buscar</button>
                                    <button id="btn-print-history" onclick="generateAntecedentesReport()" class="hidden bg-gray-600 text-white py-2.5 px-5 rounded-lg hover:bg-gray-700 transition duration-300 shadow" title="Imprimir Reporte Histórico"><i class="fas fa-print"></i> Reporte</button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700"><div class="mb-4"><input type="text" id="search-antecedentes" onkeyup="filterTable('antecedentes-table')" placeholder="Filtrar resultados..." class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"></div><div id="antecedentes-table-container"></div><div id="antecedentes-table-pagination" class="pagination-controls mt-4"></div></div>
                    </div>

                    <div id="profesionales-view" class="view-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-700 dark:text-white">Gestión de Profesionales</h2></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700"><div class="mb-4"><input type="text" id="search-profesionales" onkeyup="filterTable('profesionales-table')" placeholder="Buscar..." class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('profesionales-table', 0)">Matrícula <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('profesionales-table', 1)">Nombre y Apellido <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('profesionales-table', 2)">Verificado <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('profesionales-table', 3)">Observaciones <i class="fas fa-sort"></i></th></tr></thead><tbody id="profesionales-table"></tbody></table></div><div id="profesionales-table-pagination" class="pagination-controls mt-4"></div></div>
                    </div>

                    <div id="registro-view" class="view-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-700 dark:text-white">Registro de Actividad</h2></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700"><div class="mb-4"><input type="text" id="search-registro" onkeyup="filterTable('registro-table')" placeholder="Buscar..." class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('registro-table', 0)">Fecha <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('registro-table', 1)">Afiliado <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('registro-table', 2)">Usuario <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('registro-table', 3)">Acción <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('registro-table', 4)">Rol <i class="fas fa-sort"></i></th><th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('registro-table', 5)">Descripción <i class="fas fa-sort"></i></th></tr></thead><tbody id="registro-table"></tbody></table></div><div id="registro-table-pagination" class="pagination-controls mt-4"></div></div>
                    </div>

                    <div id="form-view" class="view-content hidden fade-in">
                        <!-- Aquí se renderiza la Carta Médica o el Reporte Histórico. -->
                    </div>

                    <div id="presentarse-view" class="view-content hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-700 dark:text-white">Consultar Personal a Presentarse</h2>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg mb-6 border dark:border-gray-700"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Fecha</label><input type="date" id="fecha-presentarse" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block w-full p-2.5"></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Unidad</label><select id="unidad-presentarse" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block w-full p-2.5"><option value="TODAS">TODAS</option><option>CC1</option><option>CC2</option><option>EP3</option><option>EP4</option><option>EP5</option><option>EP6</option><option>EP7</option><option>EP8</option><option>EP9</option><option>JEFATURA</option><option>EDIFICIO LAPRIDA</option><option>ESCUELA DE CADETES</option><option>ESCUELA DE SUBOFICIALES</option></select></div><button onclick="filtrarPresentarse()" class="bg-blue-600 text-white py-2.5 px-5 rounded-lg hover:bg-blue-700 transition duration-300 shadow">Filtrar</button></div></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700"><div class="mb-4"><input type="text" id="search-presentarse" onkeyup="filterTable('presentarse-table')" placeholder="Buscar..." class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('presentarse-table', 0)">Afiliado <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('presentarse-table', 1)">Empleado <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('presentarse-table', 2)">Unidad <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('presentarse-table', 3)">Fin Licencia <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('presentarse-table', 4)">Debe Presentarse <i class="fas fa-sort"></i></th>
                            <th scope="col" class="px-6 py-3">Se Presentó</th>
                            <th scope="col" class="px-6 py-3">Se Comunicó</th>
                            <th scope="col" class="px-6 py-3">Observaciones</th>
                        </tr></thead><tbody id="presentarse-table"></tbody></table></div><div id="presentarse-table-pagination" class="pagination-controls mt-4"></div></div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- Modals (Omitidos para brevedad, pero presentes en el código completo) -->
    <!-- [aviso-modal, avisos-fecha-modal, usuario-modal, change-password-modal, confirm-modal, toast-container] -->
    <div id="aviso-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print z-40"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl p-8 max-h-[95vh] overflow-y-auto border dark:border-gray-700"><h2 id="aviso-modal-title" class="text-2xl font-bold mb-6 text-gray-800 dark:text-white"></h2><form id="aviso-form"><input type="hidden" id="aviso-mode" value="create"><input type="hidden" id="aviso-id"><input type="hidden" id="incidente-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"><div class="md:col-span-2"><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Número de Afiliado</label><input type="text" id="empleado-afiliado" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" onblur="precargarDatosAfiliado()" required></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Grado</label><input type="text" id="empleado-grado" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Función</label><input type="text" id="empleado-funcion" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required></div><div class="md:col-span-2"><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nombre</label><input type="text" id="empleado-nombre" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required></div><div class="md:col-span-2"><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Dirección</label><input type="text" id="empleado-direccion" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Fecha Solicitud</label><input type="date" id="solicitud-fecha" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" onblur="checkAvisoSuperposicion()" required></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Hora</label><input type="time" id="solicitud-hora" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Unidad</label><select id="empleado-unidad" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required></select></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tipo</label><select id="solicitud-tipo" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required><option>CONSULTORIO</option><option>A DOMICILIO</option></select></div><div class="md:col-span-2"><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Motivo</label><select id="solicitud-motivo" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required><option value="" disabled selected>-- Seleccione --</option><option value="ENFERMEDAD DEL AGENTE">ENFERMEDAD DEL AGENTE</option><option value="PERSONA A CARGO / FAMILIAR">PERSONA A CARGO / FAMILIAR</option></select></div><div class="md:col-span-2"><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Observaciones</label><textarea id="solicitud-observaciones" rows="3" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"></textarea></div></div><p id="aviso-error" class="text-red-500 text-sm text-center hidden mt-4"></p><div class="flex justify-end space-x-4 pt-6 mt-4 border-t border-gray-200 dark:border-gray-700"><button type="button" onclick="closeAvisoModal()" class="py-2 px-4 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition">Cancelar</button><button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Guardar Aviso</button></div></form></div></div>
    <div id="avisos-fecha-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print z-50"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-5xl p-8 max-h-[95vh] flex flex-col border dark:border-gray-700"><h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Buscar Avisos por Período</h2><div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4"><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Desde</label><input type="date" id="search-fecha-aviso-desde" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Hasta</label><input type="date" id="search-fecha-aviso-hasta" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Encuadre</label><select id="search-encuadra-aviso" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"><option value="TODOS">Todos</option><option value="ART. 14">ART. 14</option><option value="ART. 19">ART. 19</option><option value="ART. 20">ART. 20</option><option value="ART. 29">ART. 29</option><option value="ART. 30">ART. 30</option><option value="ART. 30 BIS">ART. 30 BIS</option><option value="SIN JUSTIFICAR">SIN JUSTIFICAR</option></select></div><button onclick="searchAvisosPorFecha()" class="bg-blue-600 text-white py-2.5 px-6 rounded-lg hover:bg-blue-700 transition">Buscar</button></div><div id="avisos-fecha-results" class="flex-grow overflow-y-auto border-t border-gray-200 dark:border-gray-700 pt-4"><div class="overflow-x-auto"><table class="w-full text-sm"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr><th class="px-4 py-2 cursor-pointer" onclick="sortTable('avisos-fecha-table', 0)">Afiliado <i class="fas fa-sort"></i></th><th class="px-4 py-2 cursor-pointer" onclick="sortTable('avisos-fecha-table', 1)">Empleado <i class="fas fa-sort"></i></th><th class="px-4 py-2 cursor-pointer" onclick="sortTable('avisos-fecha-table', 2)">Unidad <i class="fas fa-sort"></i></th><th class="px-4 py-2 cursor-pointer" onclick="sortTable('avisos-fecha-table', 3)">Fecha <i class="fas fa-sort"></i></th><th class="px-4 py-2 cursor-pointer" onclick="sortTable('avisos-fecha-table', 4)">Estado <i class="fas fa-sort"></i></th><th class="px-4 py-2 cursor-pointer" onclick="sortTable('avisos-fecha-table', 5)">Encuadre <i class="fas fa-sort"></i></th><th class="px-4 py-2">Acción</th></tr></thead><tbody id="avisos-fecha-table"></tbody></table></div></div><div id="avisos-fecha-table-pagination" class="pagination-controls mt-4 flex-shrink-0"></div><div class="flex justify-between items-center mt-6 flex-shrink-0"><button type="button" onclick="exportAvisosToXLS()" class="py-2 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center space-x-2"><i class="fas fa-file-excel"></i><span>Exportar a XLS</span></button><button type="button" onclick="closeAvisosFechaModal()" class="py-2 px-6 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition">Cerrar</button></div></div></div>
    <div id="usuario-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print z-50"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl p-8 max-h-[95vh] overflow-y-auto border dark:border-gray-700"><h2 id="usuario-modal-title" class="text-2xl font-bold mb-6 text-gray-800 dark:text-white"></h2><form id="usuario-form"><input type="hidden" id="usuario-mode"><div class="space-y-4"><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Afiliado</label><input type="text" id="usuario-afiliado" onblur="precargarDatosUsuario()" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nombre</label><input type="text" id="usuario-nombre" class="bg-gray-200 dark:bg-gray-600 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block w-full p-2.5" readonly></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Contraseña</label><input type="password" id="usuario-password" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5"></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Roles</label><div id="usuario-roles-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-4 border border-gray-200 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200"></div></div><div id="usuario-unidades-container" class="hidden"><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Establecimientos</label><div id="usuario-unidades-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-4 border border-gray-200 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200"></div></div></div><div class="flex justify-end space-x-4 pt-6 mt-4 border-t border-gray-200 dark:border-gray-700"><button type="button" onclick="closeUsuarioModal()" class="py-2 px-4 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition">Cancelar</button><button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Guardar</button></div></form></div></div>
    <div id="change-password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print z-50"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-8 border dark:border-gray-700"><h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Cambiar Contraseña</h2><form id="change-password-form"><div class="space-y-4"><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Actual</label><input type="password" id="current-password" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nueva</label><input type="password" id="new-password" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required></div><div><label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Confirmar</label><input type="password" id="confirm-password" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5" required></div><p id="password-error" class="text-red-500 text-sm hidden"></p></div><div class="flex justify-end space-x-4 pt-6 mt-4 border-t border-gray-200 dark:border-gray-700"><button type="button" onclick="closeChangePasswordModal()" class="py-2 px-4 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition">Cancelar</button><button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Guardar</button></div></form></div></div>
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print z-50"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-8 text-center border dark:border-gray-700"><i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i><h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Confirmar Acción</h2><p id="confirm-modal-message" class="text-gray-600 dark:text-gray-400 mb-6">¿Está seguro?</p><div class="flex justify-center space-x-4"><button id="confirm-modal-cancel-btn" class="py-2 px-6 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition">Cancelar</button><button id="confirm-modal-confirm-btn" class="py-2 px-6 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirmar</button></div></div></div>
    <div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-2"></div>


    <!-- Scripts de Firebase y Lógica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, onSnapshot, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

        // Configuración de Firebase (de RECONOCIMIENTOS.html)
        const firebaseConfig = { apiKey: "AIzaSyAKLAIAtWhsV0CfWVv5ntcpx2Sj1e2_XLA", authDomain: "reconocimientosspc.firebaseapp.com", projectId: "reconocimientosspc", storageBucket: "reconocimientosspc.appspot.com", messagingSenderId: "500258238765", appId: "1:500258238765:web:d48fbe6c10818d0def23a4", measurementId: "G-X33KN1HCS8" };
        let db;
        try { if (!firebaseConfig.projectId) throw new Error("Configuración de Firebase no proporcionada."); const app = initializeApp(firebaseConfig); db = getFirestore(app); } catch (error) { console.error(error.message); document.getElementById('login-screen').innerHTML = `<div class="text-red-500 p-4">Error: ${error.message}</div>`; }

        // --- ESTADO GLOBAL ---
        let currentUser = null;
        let selectedRole = null;
        let currentUserUnidad = null;
        let currentAvisosSearchResult = [];
        const unidadesDisponibles = ['TODAS', 'CC1', 'CC2', 'EP3', 'EP4', 'EP5', 'EP6', 'EP7', 'EP8', 'EP9', 'JEFATURA', 'EDIFICIO LAPRIDA', 'ESCUELA DE CADETES', 'ESCUELA DE SUBOFICIALES'];
        let sortState = {};
        let isSyncingProfesionales = false;
        let _onConfirmCallback = null;
        let paginationState = {};
        let allDataCache = {};
        const ROWS_PER_PAGE = 100;
        let charts = {};
        let unsubscribeAvisosPendientes = null, unsubscribeAvisosVisados = null, unsubscribePendientes = null, unsubscribeCompletados = null, unsubscribeUsers = null, unsubscribeRegistro = null, unsubscribeProfesionales = null;

        // --- Funciones de Utilidad ---
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            if (document.getElementById('metrics-view') && !document.getElementById('metrics-view').classList.contains('hidden')) {
                calculateAndRenderMetrics();
            }
        }

        function formatDate(dateString) {
            if (!dateString || !dateString.includes('-')) return dateString || 'N/A';
            const parts = dateString.split('-');
            if (parts.length !== 3) return dateString;
            const [year, month, day] = parts;
            return `${day}/${month}/${year}`;
        }

        async function logActivity(action, description) {
            if (!currentUser) return; 
            try {
                await addDoc(collection(db, "activityLog"), {
                    timestamp: new Date(),
                    userAfiliado: currentUser.afiliado,
                    userName: currentUser.nombreCompleto,
                    userRole: selectedRole,
                    action: action,
                    description: description
                });
            } catch (error) { console.error("Error logging activity: ", error); }
        }

        function getUnidadTag(unidad) {
            if (!unidad) return '';
            const abreviaturas = { 'JEFATURA': 'JEF.', 'EDIFICIO LAPRIDA': 'LAPRID.', 'ESCUELA DE CADETES': 'ESC. CAD.', 'ESCUELA DE SUBOFICIALES': 'ESC. SUBOF' };
            const colores = { 'CC1': 'green', 'CC2': 'red', 'EP3': 'green', 'EP4': 'green', 'EP5': 'red', 'EP6': 'red', 'EP7': 'red', 'EP8': 'red', 'EP9': 'green', 'JEFATURA': 'green', 'EDIFICIO LAPRIDA': 'green', 'ESCUELA DE CADETES': 'green', 'ESCUELA DE SUBOFICIALES': 'green' };
            const color = colores[unidad] || 'gray';
            const colorClasses = { 
                green: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300', 
                red: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300', 
                gray: 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300' 
            }[color];
            const text = abreviaturas[unidad] || unidad;
            return `<span class="px-2 py-1 text-xs font-medium rounded-full ${colorClasses}">${text}</span>`;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container'), toast = document.createElement('div');
            let iconClass = 'fas fa-check-circle', typeClass = 'toast-success';
            if (type === 'error') { iconClass = 'fas fa-times-circle'; typeClass = 'toast-error'; } 
            else if (type === 'warning') { iconClass = 'fas fa-exclamation-triangle'; typeClass = 'toast-warning'; }
            toast.className = `toast ${typeClass}`; toast.innerHTML = `<i class="${iconClass}"></i> ${message}`; container.appendChild(toast);
            setTimeout(() => { toast.classList.add('fade-out'); toast.addEventListener('animationend', () => toast.remove()); }, 3000);
        }

        function openConfirmModal(message, onConfirmCallback) { document.getElementById('confirm-modal-message').textContent = message; _onConfirmCallback = onConfirmCallback; document.getElementById('confirm-modal').classList.add('flex'); document.getElementById('confirm-modal').classList.remove('hidden'); }
        function closeConfirmModal() { document.getElementById('confirm-modal').classList.add('hidden'); document.getElementById('confirm-modal').classList.remove('flex'); _onConfirmCallback = null; }

        // --- LOGIN & AUTH ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const afiliado = document.getElementById('login-afiliado').value, password = document.getElementById('login-password').value, errorP = document.getElementById('login-error');
            errorP.classList.add('hidden');
            if (afiliado === '136219951' && password === 'Marquitos123') {
                currentUser = { afiliado: '136219951', nombreCompleto: 'Superusuario', roles: ['administrador', 'personal', 'reconocimientos'], unidades: unidadesDisponibles };
                showRoleSelection(currentUser.roles);
                return;
            }
            const userDocRef = doc(db, "users", afiliado), userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists() && userDocSnap.data().password === password) {
                currentUser = userDocSnap.data();
                const userRoles = Array.isArray(currentUser.roles) ? currentUser.roles : (currentUser.role ? [currentUser.role] : []);
                if (userRoles.length > 1) showRoleSelection(userRoles); else if (userRoles.length === 1) selectRole(userRoles[0]); else { errorP.textContent = 'El usuario no tiene roles asignados.'; errorP.classList.remove('hidden'); }
            } else { errorP.textContent = 'Afiliado o contraseña incorrectos.'; errorP.classList.remove('hidden'); }
        });
        
        function showRoleSelection(roles) {
            const buttonsContainer = document.getElementById('role-buttons-container');
            buttonsContainer.innerHTML = '';
            roles.forEach(role => { buttonsContainer.innerHTML += `<button onclick="selectRole('${role}')" class="w-full bg-amber-500 text-white py-3 px-4 rounded-lg hover:bg-amber-600 transition duration-300 capitalize shadow">${role.replace('reconocimientos', 'Reconocimientos Médicos')}</button>`; });
            document.getElementById('login-screen').classList.add('hidden'); document.getElementById('role-selection-screen').classList.remove('hidden'); document.getElementById('role-selection-screen').classList.add('flex');
        }

        async function selectRole(role) {
            selectedRole = role;
            await logActivity('LOGIN', `Inició sesión con el rol: ${role}.`);
            document.getElementById('role-selection-screen').classList.add('hidden'); document.getElementById('role-selection-screen').classList.remove('flex');
            if (selectedRole === 'personal') {
                if (currentUser.unidades && currentUser.unidades.length > 0) showUnidadSelection(currentUser.unidades); else { logout(); showToast('No tiene unidades asignadas para el rol de Personal.', 'error'); }
            } else showPortal();
        }

        function showUnidadSelection(unidades) {
            const select = document.getElementById('login-unidad-select'); select.innerHTML = '<option value="" disabled selected>-- Elija una unidad --</option>';
            unidades.forEach(u => { select.innerHTML += `<option value="${u}">${u}</option>`; });
            document.getElementById('login-screen').classList.add('hidden'); document.getElementById('role-selection-screen').classList.add('hidden'); document.getElementById('unidad-selection-screen').classList.remove('hidden'); document.getElementById('unidad-selection-screen').classList.add('flex');
        }

        async function continueLoginPersonal(){
            const selectedUnidad = document.getElementById('login-unidad-select').value;
            if(!selectedUnidad) { showToast('Por favor, seleccione una unidad.', 'warning'); return; }
            currentUserUnidad = selectedUnidad; await logActivity('SELECT_UNIDAD', `Seleccionó la unidad: ${selectedUnidad}.`); showPortal();
        }

        function showPortal() {
            document.getElementById('login-screen').classList.add('hidden'); document.getElementById('role-selection-screen').classList.add('hidden'); document.getElementById('unidad-selection-screen').classList.add('hidden'); document.getElementById('main-portal').classList.remove('hidden');
            setupPortalForRole();
        }

        function goBackToLogin(){ document.getElementById('unidad-selection-screen').classList.add('hidden'); document.getElementById('role-selection-screen').classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden'); }
        async function logout() { await logActivity('LOGOUT', 'Cerró sesión.'); currentUser = null; selectedRole = null; currentUserUnidad = null; document.getElementById('main-portal').classList.add('hidden'); goBackToLogin(); document.getElementById('login-form').reset(); }
        function goBackToRoleSelection() { document.getElementById('main-portal').classList.add('hidden'); selectedRole = null; currentUserUnidad = null; showRoleSelection(currentUser.roles); }

        function setupPortalForRole() {
            document.getElementById('user-role').textContent = `${currentUser.nombreCompleto} (${selectedRole})`;
            ['admin-links', 'personal-links', 'reconocimientos-links'].forEach(id => { document.getElementById(id).classList.add('hidden'); });
            const userRoles = Array.isArray(currentUser.roles) ? currentUser.roles : [];
            const hasMultipleRoles = userRoles.length > 1;
            const roleBtn = document.getElementById('change-role-btn');
            const metricsBtn = document.getElementById('metrics-sidebar-btn');
            if (hasMultipleRoles) { roleBtn.classList.remove('hidden'); roleBtn.classList.add('flex-grow'); metricsBtn.classList.remove('flex-grow'); metricsBtn.classList.add('w-14', 'flex-shrink-0'); } else { roleBtn.classList.add('hidden'); metricsBtn.classList.remove('w-14', 'flex-shrink-0'); metricsBtn.classList.add('w-full'); }
            if (selectedRole === 'administrador') document.getElementById('admin-links').classList.remove('hidden'); else if (selectedRole === 'personal') document.getElementById('personal-links').classList.remove('hidden'); else if (selectedRole === 'reconocimientos') document.getElementById('reconocimientos-links').classList.remove('hidden');
            showView('inicio');
        }

        function showView(viewId) {
            if (unsubscribeAvisosPendientes) unsubscribeAvisosPendientes(); if (unsubscribeAvisosVisados) unsubscribeAvisosVisados(); if (unsubscribePendientes) unsubscribePendientes(); if (unsubscribeCompletados) unsubscribeCompletados(); if (unsubscribeUsers) unsubscribeUsers(); if (unsubscribeRegistro) unsubscribeRegistro(); if (unsubscribeProfesionales) unsubscribeProfesionales();
            document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
            document.getElementById(`${viewId}-view`).classList.remove('hidden');
            const titles = { 'inicio': 'Inicio', 'metrics': 'Tablero de Métricas', 'usuarios': 'Gestión de Usuarios', 'importar': 'Importar Personal', 'avisos-pendientes': 'Avisos de Carpetas Pendientes', 'avisos-visados': 'Avisos de Carpetas Visados', 'pendientes': 'Incidentes Pendientes', 'completados': 'Incidentes Completados', 'form': 'Formulario de Reconocimiento Médico', 'presentarse': 'Consultar Personal a Presentarse', 'evaluados': 'Consultar Evaluados por Fecha', 'antecedentes': 'Buscar Antecedentes', 'registro': 'Registro de Actividad', 'profesionales': 'Gestión de Profesionales' };
            document.getElementById('view-title').textContent = titles[viewId] || 'Bienvenido';
            const tableId = getTableIdForView(viewId);
            if (tableId) { paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE }; allDataCache[tableId] = []; const tableBody = document.getElementById(tableId); const paginationControls = document.getElementById(`${tableId}-pagination`); if(tableBody) tableBody.innerHTML = ''; if(paginationControls) paginationControls.innerHTML = ''; }
            if (viewId === 'inicio') renderInicioView(); if (viewId === 'metrics') calculateAndRenderMetrics(); if (viewId === 'avisos-pendientes') listenToAvisos('Pendiente'); if (viewId === 'avisos-visados') listenToAvisos('Completado'); if (viewId === 'pendientes') listenToIncidentes('Pendiente'); if (viewId === 'completados') listenToIncidentes('Completado'); if (viewId === 'usuarios') listenToUsers(); if (viewId === 'registro') listenToActivityLog(); if (viewId === 'profesionales') synchronizeAndListenProfesionales();
            if (viewId === 'presentarse') { const unidadSelect = document.getElementById('unidad-presentarse'); unidadSelect.innerHTML = unidadesDisponibles.map(u => `<option value="${u}">${u}</option>`).join(''); unidadSelect.disabled = selectedRole === 'personal'; if (selectedRole === 'personal') unidadSelect.value = currentUserUnidad; document.getElementById('presentarse-table').innerHTML = '<tr><td colspan="9" class="text-center p-4">Seleccione una fecha y unidad para buscar.</td></tr>'; }
        }
        
        function getTableIdForView(viewId) { const map = { 'usuarios': 'usuarios-table', 'avisos-pendientes': 'avisos-pendientes-table', 'avisos-visados': 'avisos-visados-table', 'pendientes': 'pendientes-table', 'completados': 'completados-table', 'evaluados': 'evaluados-table', 'antecedentes': 'antecedentes-table', 'profesionales': 'profesionales-table', 'registro': 'registro-table', 'presentarse': 'presentarse-table' }; return map[viewId] || null; }

        function renderInicioView() {
            const container = document.getElementById('inicio-view');
            let content = `<h2 class="text-3xl font-bold mb-6 text-gray-700 dark:text-white">Bienvenido, ${currentUser.nombreCompleto}</h2>`;
            function createInfoCard(icon, title, text) { return `<div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg flex items-start space-x-4 border dark:border-gray-700"><div class="bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 p-3 rounded-full flex-shrink-0"><i class="${icon} text-xl w-6 text-center"></i></div><div><h3 class="font-bold text-lg text-gray-800 dark:text-white mb-1">${title}</h3><p class="text-gray-600 dark:text-gray-400 text-sm">${text}</p></div></div>`; }
            const metricsCard = createInfoCard('fas fa-chart-pie', 'Métricas y Estadísticas', 'Visualice gráficos sobre avisos pendientes, encuadres, ausentismo por día y rankings.');
            switch(selectedRole) {
                case 'administrador': content += `<p class="text-gray-600 dark:text-gray-400 mb-8">Desde este panel de administrador, tiene acceso completo al sistema.</p><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">` + metricsCard + createInfoCard('fas fa-users-cog', 'Gestionar Usuarios', 'ABM de usuarios y roles.') + createInfoCard('fas fa-file-excel', 'Importar Personal', 'Cargue la base de datos mediante Excel.') + createInfoCard('fas fa-folder-open', 'Avisos Pendientes', 'Gestione avisos pendientes.') + createInfoCard('fas fa-folder-check', 'Avisos Visados', 'Historial de avisos completados.') + createInfoCard('fas fa-user-md', 'Profesionales', 'Gestione profesionales médicos.') + createInfoCard('fas fa-calendar-check', 'Presentarse', 'Filtre personal que debe reintegrarse.') + createInfoCard('fas fa-clipboard-list', 'Registro Actividad', 'Audite acciones del sistema.') + `</div>`; break;
                case 'personal': content += `<p class="text-gray-600 dark:text-gray-400 mb-8">Bienvenido al portal de su unidad.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-6">` + metricsCard + createInfoCard('fas fa-folder-open', 'Avisos Pendientes', 'Cree y edite avisos pendientes.') + createInfoCard('fas fa-folder-check', 'Avisos Visados', 'Consulte historial de avisos.') + createInfoCard('fas fa-calendar-check', 'Presentarse', 'Verifique agentes a presentarse.') + `</div>`; break;
                case 'reconocimientos': content += `<p class="text-gray-600 dark:text-gray-400 mb-8">Panel de gestión médica.</p><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">` + metricsCard + createInfoCard('fas fa-hourglass-half', 'Pendientes', 'Evalúe incidentes médicos.') + createInfoCard('fas fa-check-double', 'Completados', 'Revise reconocimientos completados.') + createInfoCard('fas fa-history', 'Evaluados por Fecha', 'Filtre por fecha.') + createInfoCard('fas fa-search-plus', 'Buscar Antecedentes', 'Historial médico completo.') + createInfoCard('fas fa-user-md', 'Profesionales', 'Gestione profesionales.') + createInfoCard('fas fa-calendar-check', 'Presentarse', 'Consulte personal a reintegrarse.') + `</div>`; break;
            }
            container.innerHTML = content;
        }

        // --- MÉTRICAS ---
        async function calculateAndRenderMetrics() {
            const currentYear = new Date().getFullYear(); document.getElementById('metrics-subtitle').textContent = `Estadísticas del año calendario ${currentYear} (1 Ene - 31 Dic)`; const startOfYear = `${currentYear}-01-01`; const endOfYear = `${currentYear}-12-31`; const isRestricted = selectedRole === 'personal' && currentUserUnidad !== 'TODAS';
            const unitChartContainer = document.getElementById('container-chart-units'); if (!isRestricted && (selectedRole === 'administrador' || selectedRole === 'reconocimientos')) { unitChartContainer.classList.remove('hidden'); } else { unitChartContainer.classList.add('hidden'); }
            let qAvisos = collection(db, "avisos"), qIncidentes = collection(db, "incidentes"); if (isRestricted) { qAvisos = query(collection(db, "avisos"), where("unidad", "==", currentUserUnidad)); }
            const [avisosSnap, incidentesSnap] = await Promise.all([ getDocs(qAvisos), getDocs(qIncidentes) ]);
            const avisos = avisosSnap.docs.map(d => d.data()).filter(a => a.fecha >= startOfYear && a.fecha <= endOfYear);
            const incidentes = incidentesSnap.docs.map(d => d.data()).filter(inc => { if (isRestricted && inc.unidad !== currentUserUnidad) return false; const fecha = inc.solicitudFecha || (inc.reconocimiento && inc.reconocimiento.fechaEvaluacion); return fecha >= startOfYear && fecha <= endOfYear; });
            const totalYearCount = incidentes.length; const completedIncidentes = incidentes.filter(i => i.estado === 'Completado'); const completedCount = completedIncidentes.length; const today = new Date().toISOString().slice(0, 10); const allCompletedIncidentes = incidentesSnap.docs.map(d => d.data()).filter(inc => { if (isRestricted && inc.unidad !== currentUserUnidad) return false; return inc.estado === 'Completado'; }); const vigentes = allCompletedIncidentes.filter(i => i.reconocimiento && i.reconocimiento.altaDesde >= today); const activeCount = vigentes.length;
            const daysCount = {0:0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0}; avisos.forEach(a => { if(a.fecha) { let dayIndex = new Date(a.fecha + 'T00:00:00').getDay(); let adjustedIndex = dayIndex === 0 ? 6 : dayIndex - 1; daysCount[adjustedIndex]++; } }); const daysLabels = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo']; const maxDayVal = Math.max(...Object.values(daysCount)); const maxDayIndex = Object.keys(daysCount).find(key => daysCount[key] === maxDayVal); const busyDayName = daysLabels[maxDayIndex] || 'N/A';
            const encuadresMap = {}; completedIncidentes.forEach(i => { const enc = i.reconocimiento?.encuadra || 'Sin Definir'; encuadresMap[enc] = (encuadresMap[enc] || 0) + 1; });
            const rankingMap = {}; completedIncidentes.forEach(i => { const fechaEv = i.reconocimiento?.fechaEvaluacion; if (fechaEv >= startOfYear && fechaEv <= endOfYear) { const dias = parseInt(i.reconocimiento?.dias || 0, 10); const key = i.afiliado; if (!rankingMap[key]) rankingMap[key] = { afiliado: i.afiliado, nombre: i.empleado, unidad: i.unidad, totalDias: 0, count: 0 }; rankingMap[key].totalDias += dias; rankingMap[key].count += 1; } }); const rankingArray = Object.values(rankingMap).sort((a, b) => b.totalDias - a.totalDias).slice(0, 10);
            const unitsMap = {}; if (!isRestricted) { incidentes.forEach(i => { unitsMap[i.unidad] = (unitsMap[i.unidad] || 0) + 1; }); }
            document.getElementById('metric-total-year').textContent = totalYearCount; document.getElementById('metric-completed-count').textContent = completedCount; document.getElementById('metric-active-count').textContent = activeCount; document.getElementById('metric-busy-day').textContent = busyDayName;
            const rankingBody = document.getElementById('ranking-table-body'); rankingBody.innerHTML = ''; if(rankingArray.length === 0) { rankingBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No hay datos suficientes en el año actual.</td></tr>'; } else { rankingArray.forEach((r, idx) => { rankingBody.innerHTML += `<tr class="border-b hover:bg-gray-50 dark:border-gray-700 dark:hover:bg-gray-700"><td class="px-6 py-3 font-bold text-gray-900 dark:text-white">${idx + 1}</td><td class="px-6 py-3 text-gray-900 dark:text-white">${r.afiliado}</td><td class="px-6 py-3 text-gray-900 dark:text-white">${r.nombre}</td><td class="px-6 py-3">${getUnidadTag(r.unidad)}</td><td class="px-6 py-3 text-center font-bold text-red-600 dark:text-red-400">${r.totalDias}</td><td class="px-6 py-3 text-center text-gray-900 dark:text-white">${r.count}</td></tr>`; }); }
            renderChart('chart-encuadres', 'doughnut', Object.keys(encuadresMap), Object.values(encuadresMap), 'Encuadres'); renderChart('chart-days', 'bar', daysLabels, Object.values(daysCount), 'Avisos por Día'); if(!isRestricted) { renderChart('chart-units', 'bar', Object.keys(unitsMap), Object.values(unitsMap), 'Total Carpetas por Unidad'); }
        }

        function renderChart(canvasId, type, labels, data, label) {
            const ctx = document.getElementById(canvasId).getContext('2d'); if (charts[canvasId]) { charts[canvasId].destroy(); }
            const satColors = ['#FF0000', '#0000FF', '#00FF00', '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#800080', '#008000', '#000080', '#808000', '#808000']; const isDark = document.documentElement.classList.contains('dark'); const textColor = isDark ? '#e5e7eb' : '#374151';
            charts[canvasId] = new Chart(ctx, { type: type, data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: satColors, borderColor: isDark ? '#1f2937' : '#fff', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: textColor } }, title: { display: false, color: textColor } }, scales: (type === 'bar') ? { y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: isDark ? '#4b5563' : '#e5e7eb' } }, x: { ticks: { color: textColor }, grid: { color: isDark ? '#4b5563' : '#e5e7eb' } } } : {} } });
        }

        // --- GESTIÓN DE USUARIOS ---
        function listenToUsers() { const tableId = 'usuarios-table', baseTitle = 'Gestión de Usuarios', viewHeader = document.querySelector('#usuarios-view h2'); unsubscribeUsers = onSnapshot(collection(db, "users"), (snapshot) => { const totalCount = snapshot.size; const titleWithCount = `${baseTitle} (${totalCount})`; viewHeader.textContent = titleWithCount; if (!document.getElementById('usuarios-view').classList.contains('hidden')) document.getElementById('view-title').textContent = titleWithCount; allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (!paginationState[tableId]) paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE }; renderPaginatedTable(tableId); }); }
        async function openUsuarioModal(afiliado = null) {
            const form = document.getElementById('usuario-form'); form.reset(); document.getElementById('usuario-unidades-container').classList.add('hidden');
            const mode = afiliado ? 'edit' : 'create'; document.getElementById('usuario-mode').value = mode; document.getElementById('usuario-modal-title').textContent = mode === 'create' ? 'Crear Nuevo Usuario' : 'Editar Usuario';
            document.getElementById('usuario-afiliado').readOnly = (mode === 'edit'); document.getElementById('usuario-password').required = (mode === 'create');
            const rolesContainer = document.getElementById('usuario-roles-checkboxes'); rolesContainer.innerHTML = ['administrador', 'personal', 'reconocimientos'].map(role => `<label class="flex items-center space-x-2"><input type="checkbox" name="roles" value="${role}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span class="capitalize">${role.replace('reconocimientos', 'Rec. Médicos')}</span></label>`).join('');
            rolesContainer.querySelectorAll('input[name="roles"]').forEach(cb => cb.addEventListener('change', () => document.getElementById('usuario-unidades-container').classList.toggle('hidden', !rolesContainer.querySelector('input[value="personal"]').checked)));
            const unidadesContainer = document.getElementById('usuario-unidades-checkboxes'); unidadesContainer.innerHTML = unidadesDisponibles.filter(u => u !== 'TODAS').map(u => `<label class="flex items-center space-x-2"><input type="checkbox" name="unidades" value="${u}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>${u}</span></label>`).join('');
            if (mode === 'edit') { const userDoc = await getDoc(doc(db, "users", afiliado)); if (userDoc.exists()) { const data = userDoc.data(); document.getElementById('usuario-afiliado').value = data.afiliado; document.getElementById('usuario-nombre').value = data.nombreCompleto; const userRoles = Array.isArray(data.roles) ? data.roles : (data.role ? [data.role] : []); form.querySelectorAll('input[name="roles"]').forEach(check => { if (userRoles.includes(check.value)) check.checked = true; }); const personalIsChecked = userRoles.includes('personal'); document.getElementById('usuario-unidades-container').classList.toggle('hidden', !personalIsChecked); if (personalIsChecked && data.unidades) { form.querySelectorAll('input[name="unidades"]').forEach(check => { if (data.unidades.includes(check.value)) check.checked = true; }); } } }
            document.getElementById('usuario-modal').classList.add('flex'); document.getElementById('usuario-modal').classList.remove('hidden');
        }
        function closeUsuarioModal() { document.getElementById('usuario-modal').classList.add('hidden'); document.getElementById('usuario-modal').classList.remove('flex'); }
        async function precargarDatosUsuario() { const afiliado = document.getElementById('usuario-afiliado').value; if (document.getElementById('usuario-mode').value === 'edit' || !afiliado) return; const personalDoc = await getDoc(doc(db, "personal", afiliado)); document.getElementById('usuario-nombre').value = personalDoc.exists() ? personalDoc.data().nombreCompleto : 'Afiliado no encontrado.'; }
        async function resetPassword(afiliado) { const newPassword = prompt(`Ingrese la nueva contraseña para el afiliado ${afiliado}:`); if (newPassword) { await updateDoc(doc(db, "users", afiliado), { password: newPassword.trim() }); await logActivity('RESET_PASSWORD', `Contraseña blanqueada para usuario ${afiliado}.`); showToast("Contraseña actualizada.", 'success'); } }
        async function deleteUser(afiliado) { openConfirmModal('¿Seguro que desea eliminar este usuario?', async () => { await deleteDoc(doc(db, "users", afiliado)); await logActivity('DELETE_USER', `Usuario eliminado: ${afiliado}.`); showToast("Usuario eliminado.", 'success'); }); }
        document.getElementById('usuario-form').addEventListener('submit', async function(e) { e.preventDefault(); const mode = document.getElementById('usuario-mode').value, afiliado = document.getElementById('usuario-afiliado').value, nombre = document.getElementById('usuario-nombre').value, password = document.getElementById('usuario-password').value; const roles = Array.from(document.querySelectorAll('input[name="roles"]:checked')).map(cb => cb.value); if (roles.length === 0 || nombre === 'Afiliado no encontrado.') { showToast('Complete todos los campos correctamente.', 'error'); return; } const userData = { afiliado, nombreCompleto: nombre, roles }; if (password) userData.password = password; if (roles.includes('personal')) { userData.unidades = Array.from(document.querySelectorAll('input[name="unidades"]:checked')).map(cb => cb.value); if (userData.unidades.length === 0) { showToast('Seleccione al menos un establecimiento para Personal.', 'error'); return; } } else { userData.unidades = []; } try { await setDoc(doc(db, "users", afiliado), userData, { merge: true }); await logActivity(mode === 'create' ? 'CREATE_USER' : 'UPDATE_USER', `Usuario: ${nombre} (${afiliado})`); closeUsuarioModal(); showToast('Usuario guardado.', 'success'); } catch(error) { console.error("Error guardando usuario: ", error); showToast('Error al guardar usuario.', 'error'); } });
        
        // --- IMPORTAR ---
        async function handleFileUpload() { const fileInput = document.getElementById('excel-file-input'), statusDiv = document.getElementById('import-status'); if (fileInput.files.length === 0) { statusDiv.innerHTML = `<p class="text-red-500">Seleccione un archivo.</p>`; return; } const file = fileInput.files[0], reader = new FileReader(); statusDiv.innerHTML = `<p class="text-blue-500">Procesando...</p>`; reader.onload = async function(e) { try { const data = new Uint8Array(e.target.result), workbook = XLSX.read(data, {type: 'array'}), ws = workbook.Sheets[workbook.SheetNames[0]], json_data = XLSX.utils.sheet_to_json(ws, {header: 1}); if (json_data.length < 2) throw new Error("Excel vacío."); const headers = json_data[0].map(h => String(h).trim()); if (['Matricula', 'Apellido y Nombre', 'Funcion'].some(rh => !headers.includes(rh))) throw new Error(`Faltan columnas requeridas.`); const batch = writeBatch(db), personalData = json_data.slice(1); personalData.forEach(row => { const matricula = String(row[headers.indexOf('Matricula')]).trim(); if (matricula) { const record = { afiliado: matricula, nombreCompleto: row[headers.indexOf('Apellido y Nombre')], grado: row[headers.indexOf('Jerarquia')] || '', direccion: row[headers.indexOf('Dom_actua')] || '', funcion: row[headers.indexOf('Funcion')] || '' }; batch.set(doc(db, "personal", matricula), record, { merge: true }); } }); await batch.commit(); await logActivity('IMPORT_PERSONNEL', `Importó/Actualizó ${personalData.length} registros.`); statusDiv.innerHTML = `<p class="text-green-500">Éxito: ${personalData.length} registros procesados.</p>`; } catch (error) { statusDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`; } }; reader.readAsArrayBuffer(file); }

        // --- AVISOS ---
        function listenToAvisos(status) {
            const isPending = status === 'Pendiente'; const tableId = isPending ? 'avisos-pendientes-table' : 'avisos-visados-table'; const viewId = isPending ? 'avisos-pendientes-view' : 'avisos-visados-view'; const viewHeader = document.querySelector(`#${viewId} h2`); const baseTitle = isPending ? 'Avisos de Carpetas Pendientes' : 'Avisos de Carpetas Visados'; let baseConditions = [where("status", "==", status)]; if (selectedRole === 'personal' && currentUserUnidad !== 'TODAS') baseConditions.push(where("unidad", "==", currentUserUnidad)); if (status === 'Completado') { const encuadraFiltro = document.getElementById('filtro-encuadra').value; if (encuadraFiltro && encuadraFiltro !== 'TODOS') baseConditions.push(where("encuadra", "==", encuadraFiltro)); } const q = query(collection(db, "avisos"), ...baseConditions);
            const listener = onSnapshot(q, (snapshot) => { const totalCount = snapshot.size; const titleWithCount = `${baseTitle} (${totalCount})`; viewHeader.textContent = titleWithCount; if (!document.getElementById(viewId).classList.contains('hidden')) document.getElementById('view-title').textContent = titleWithCount; allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (!paginationState[tableId]) paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE }; renderPaginatedTable(tableId); }); if(isPending) unsubscribeAvisosPendientes = listener; else unsubscribeAvisosVisados = listener;
        }
        async function openAvisoModal(avisoId = null) {
            const form = document.getElementById('aviso-form'); form.reset(); const mode = avisoId ? 'edit' : 'create'; document.getElementById('aviso-modal-title').textContent = mode === 'create' ? 'Agregar Aviso' : 'Editar Aviso'; document.getElementById('aviso-mode').value = mode; document.getElementById('aviso-id').value = avisoId || ''; document.getElementById('incidente-id').value = ''; const canEditUnidad = selectedRole === 'administrador' || (selectedRole === 'personal' && currentUserUnidad === 'TODAS'); const unidadSelect = document.getElementById('empleado-unidad'); unidadSelect.innerHTML = ''; unidadesDisponibles.filter(u => u !== 'TODAS').forEach(u => { const option = document.createElement('option'); option.value = u; option.textContent = u; unidadSelect.appendChild(option); });
            if (mode === 'edit') { const q = query(collection(db, "incidentes"), where("avisoId", "==", avisoId)); const snap = await getDocs(q); if (!snap.empty) { const incidenteDoc = snap.docs[0], incidente = incidenteDoc.data(); document.getElementById('incidente-id').value = incidenteDoc.id; document.getElementById('empleado-afiliado').value = incidente.afiliado; document.getElementById('empleado-grado').value = incidente.grado; document.getElementById('empleado-funcion').value = incidente.funcion || ''; document.getElementById('empleado-nombre').value = incidente.empleado; document.getElementById('empleado-direccion').value = incidente.direccion; document.getElementById('solicitud-fecha').value = incidente.solicitudFecha; document.getElementById('solicitud-hora').value = incidente.solicitudHora; unidadSelect.value = incidente.unidad; document.getElementById('solicitud-tipo').value = incidente.solicitudTipo; document.getElementById('solicitud-motivo').value = incidente.motivo; document.getElementById('solicitud-observaciones').value = incidente.observacionesAviso; } } else { if (canEditUnidad) { unidadSelect.insertAdjacentHTML('afterbegin', '<option value="" disabled selected>-- Seleccione una unidad --</option>'); unidadSelect.value = ''; } else { unidadSelect.value = currentUserUnidad; } } unidadSelect.disabled = !canEditUnidad; unidadSelect.classList.toggle('bg-gray-200', !canEditUnidad); unidadSelect.classList.toggle('bg-gray-50', canEditUnidad); document.getElementById('aviso-modal').classList.add('flex'); document.getElementById('aviso-modal').classList.remove('hidden');
        }
        function closeAvisoModal() { document.getElementById('aviso-modal').classList.add('hidden'); document.getElementById('aviso-modal').classList.remove('flex'); document.getElementById('aviso-form').reset(); const errorP = document.getElementById('aviso-error'); if (errorP) { errorP.classList.add('hidden'); } }
        async function precargarDatosAfiliado() { 
            const afiliadoNumero = document.getElementById('empleado-afiliado').value.trim(); const errorP = document.getElementById('aviso-error'); const modo = document.getElementById('aviso-mode').value;
            if (errorP.textContent.startsWith('Advertencia: Este afiliado ya tiene un aviso pendiente')) { errorP.classList.add('hidden'); errorP.textContent = ''; }
            if (!afiliadoNumero) return;
            const docSnap = await getDoc(doc(db, "personal", afiliadoNumero)); 
            if (docSnap.exists()) { const e = docSnap.data(); document.getElementById('empleado-nombre').value = e.nombreCompleto || ''; document.getElementById('empleado-grado').value = e.grado || ''; document.getElementById('empleado-direccion').value = e.direccion || ''; document.getElementById('empleado-funcion').value = e.funcion || ''; } else { document.getElementById('empleado-nombre').value = ''; document.getElementById('empleado-grado').value = ''; document.getElementById('empleado-direccion').value = ''; document.getElementById('empleado-funcion').value = ''; }
            if (modo === 'create') { try { const q = query(collection(db, "avisos"), where("afiliado", "==", afiliadoNumero), where("status", "==", "Pendiente")); const snapshot = await getDocs(q); if (!snapshot.empty) { const avisoPendiente = snapshot.docs[0].data(); errorP.textContent = `Advertencia: Este afiliado ya tiene un aviso pendiente del ${formatDate(avisoPendiente.fecha)}.`; errorP.classList.remove('hidden'); } } catch (error) { console.error(error); } }
        }
        async function checkAvisoSuperposicion() { const afiliado = document.getElementById('empleado-afiliado').value, empleado = document.getElementById('empleado-nombre').value, fechaAviso = document.getElementById('solicitud-fecha').value, errorP = document.getElementById('aviso-error'); if (!afiliado || !empleado || !fechaAviso || document.getElementById('aviso-mode').value === 'edit') return; if (errorP.textContent.includes('ya se encuentra de licencia')) { errorP.classList.add('hidden'); errorP.textContent = ''; } try { const qIncidentes = query(collection(db, "incidentes"), where("empleado", "==", empleado), where("estado", "==", "Completado")); const incidentesSnap = await getDocs(qIncidentes); let overlappingIncident = null; if (!incidentesSnap.empty) { for (const doc of incidentesSnap.docs) { const inc = doc.data(), rec = inc.reconocimiento; if (rec && rec.licenciaDesde && rec.altaDesde) { if (fechaAviso >= rec.licenciaDesde && fechaAviso <= rec.altaDesde) { overlappingIncident = inc; break; } } } } if (overlappingIncident) { const rec = overlappingIncident.reconocimiento; errorP.textContent = `Advertencia: Este empleado ya se encuentra de licencia por "${rec.diagnostico || 'N/A'}" hasta el ${formatDate(rec.altaDesde)}.`; errorP.classList.remove('hidden'); } } catch (error) { console.error(error); } }
        function deleteAviso(avisoId) { openConfirmModal('¿Seguro que desea eliminar este aviso y su incidente asociado?', () => { __internalDeleteAviso(avisoId); }); }
        async function __internalDeleteAviso(avisoId) { try { const q = query(collection(db, "incidentes"), where("avisoId", "==", avisoId)); const snap = await getDocs(q); const batch = writeBatch(db); snap.forEach(d => batch.delete(d.ref)); batch.delete(doc(db, "avisos", avisoId)); await batch.commit(); await logActivity('DELETE_AVISO', `Aviso ID: ${avisoId}`); showToast('Aviso eliminado.', 'success'); } catch (error) { console.error(error); showToast('Error al eliminar.', 'error'); } }
        document.getElementById('aviso-form').addEventListener('submit', async function(e) { e.preventDefault(); const errorP = document.getElementById('aviso-error'); errorP.classList.add('hidden'); if (!document.getElementById('empleado-unidad').value) { errorP.textContent = "Debe seleccionar una unidad."; errorP.classList.remove('hidden'); return; } const mode = document.getElementById('aviso-mode').value, avisoId = document.getElementById('aviso-id').value, incidenteId = document.getElementById('incidente-id').value; const avisoData = { afiliado: document.getElementById('empleado-afiliado').value, empleado: document.getElementById('empleado-nombre').value, fecha: document.getElementById('solicitud-fecha').value, unidad: document.getElementById('empleado-unidad').value }; 
        if (mode === 'create') { try { const q = query(collection(db, "avisos"), where("empleado", "==", avisoData.empleado), where("fecha", "==", avisoData.fecha)); const snapshot = await getDocs(q); if (!snapshot.empty) { errorP.textContent = "El preaviso ya fue cargado para este empleado en esta fecha."; errorP.classList.remove('hidden'); return; } } catch (error) { console.error(error); errorP.textContent = "Error al verificar."; errorP.classList.remove('hidden'); return; } }
        const incidenteData = { empleado: avisoData.empleado, afiliado: avisoData.afiliado, grado: document.getElementById('empleado-grado').value, funcion: document.getElementById('empleado-funcion').value, direccion: document.getElementById('empleado-direccion').value, solicitudFecha: document.getElementById('solicitud-fecha').value, solicitudHora: document.getElementById('solicitud-hora').value, solicitudTipo: document.getElementById('solicitud-tipo').value, motivo: document.getElementById('solicitud-motivo').value, observacionesAviso: document.getElementById('solicitud-observaciones').value, unidad: avisoData.unidad }; 
        try { if (mode === 'edit') { await updateDoc(doc(db, "avisos", avisoId), avisoData); await updateDoc(doc(db, "incidentes", incidenteId), incidenteData); await logActivity('UPDATE_AVISO', `Aviso para ${avisoData.empleado}`); } else { avisoData.status = 'Pendiente'; const avisoDocRef = await addDoc(collection(db, "avisos"), avisoData); incidenteData.avisoId = avisoDocRef.id; incidenteData.estado = 'Pendiente'; incidenteData.reconocimiento = null; incidenteData.asistencia = { sePresento: false, seComunico: false, observaciones: '' }; const incidenteDocRef = await addDoc(collection(db, "incidentes"), incidenteData); await updateDoc(incidenteDocRef, { id: incidenteDocRef.id }); await logActivity('CREATE_AVISO', `Aviso para ${avisoData.empleado}`); } closeAvisoModal(); showToast('Aviso guardado.', 'success'); } catch (error) { console.error(error); errorP.textContent = `Error: ${error.message}`; errorP.classList.remove('hidden'); } });

        // --- INCIDENTES & FORMULARIOS ---
        function listenToIncidentes(status) { const isPending = status === 'Pendiente'; const tableId = isPending ? 'pendientes-table' : 'completados-table'; const viewId = isPending ? 'pendientes-view' : 'completados-view'; const viewHeader = document.querySelector(`#${viewId} h2`); const baseTitle = isPending ? 'Incidentes Pendientes' : 'Incidentes Completados'; const q = query(collection(db, "incidentes"), where("estado", "==", status)); const listener = onSnapshot(q, (snapshot) => { const totalCount = snapshot.size; const titleWithCount = `${baseTitle} (${totalCount})`; viewHeader.textContent = titleWithCount; if (!document.getElementById(viewId).classList.contains('hidden')) document.getElementById('view-title').textContent = titleWithCount; allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (!paginationState[tableId]) paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE }; renderPaginatedTable(tableId); }); if (isPending) unsubscribePendientes = listener; else unsubscribeCompletados = listener; }
        
        // Función openFormulario (Carta Médica) - UNIFICADA
        async function openFormulario(incidenteId, originView, isReadOnly = false) {
            const docRef = doc(db, "incidentes", incidenteId), docSnap = await getDoc(docRef); 
            if (!docSnap.exists()) { showToast("Incidente no encontrado.", 'error'); return; } 
            const incidente = docSnap.data(); 
            const formContainer = document.getElementById('form-view'); 
            const isEditable = (selectedRole === 'reconocimientos' || selectedRole === 'administrador') && !isReadOnly;
            const isCompleted = incidente.estado === 'Completado';

            // ATENCIÓN: Se eliminó el padding p-4 sm:p-6 de este contenedor para que el #printable-form se expanda
            formContainer.innerHTML = `
                <div class="flex justify-end mb-4 space-x-2 no-print">
                    <button onclick="window.print()" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600"><i class="fas fa-print mr-2"></i>Imprimir</button>
                    <button onclick="showView('${originView}')" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">Volver</button>
                </div>
                <!-- ATENCIÓN: Se eliminó el padding 'p-4 sm:p-6' de este div para que el CSS de impresión lo controle -->
                <div id="printable-form" class="bg-white border-2 border-black text-black"> 
                    <form id="reconocimiento-form" data-incidente-id="${incidenteId}" data-aviso-id="${incidente.avisoId}">
                        <div class="flex items-center justify-between mb-2 p-1">
                            <img src="https://raw.githubusercontent.com/gutierrezruarte/BibliotecaSPC/main/Escudo-1-279x300-removebg-preview.png" alt="Escudo" class="w-16 h-auto">
                            <div class="text-center">
                                <h2 class="font-bold text-base">CARTA MÉDICA</h2>
                                <p class="text-xs">SERVICIO PENITENCIARIO DE CÓRDOBA</p>
                            </div>
                            <div class="w-16"></div>
                        </div>
                        
                        <div class="border-2 border-black p-2 mb-2">
                            <h3 class="font-bold text-center text-sm mb-2 bg-gray-200 p-1">DIVISIÓN PERSONAL</h3>
                            <div class="flex justify-between text-xs break-words px-1">
                                <div class="w-1/3">
                                    <p><span class="font-semibold">UNIDAD:</span> ${incidente.unidad}</p>
                                    <p><span class="font-semibold">AFILIADO N°:</span> ${incidente.afiliado}</p>
                                    <p><span class="font-semibold">GRADO:</span> ${incidente.grado}</p>
                                    <p><span class="font-semibold">FUNCIÓN:</span> ${incidente.funcion || 'N/A'}</p> 
                                </div>
                                <div class="w-1/3">
                                    <p><span class="font-semibold">TIPO:</span> ${incidente.solicitudTipo}</p>
                                </div>
                                <div class="w-1/3 text-right">
                                     <p><span class="font-semibold">APELLIDO Y NOMBRES:</span> <span class="text-base font-bold">${incidente.empleado}</span></p>
                                     <p><span class="font-semibold">DIRECCIÓN:</span> ${incidente.direccion}</p>
                                </div>
                            </div>
                             <div class="flex justify-between text-xs break-words px-1 mt-2 border-t pt-1">
                                <div class="flex items-center space-x-4">
                                ${isEditable ? `
                                    <label class="flex items-center"><input type="radio" name="motivo_reconocimiento" value="ENFERMEDAD DEL AGENTE" ${incidente.motivo === 'ENFERMEDAD DEL AGENTE' ? 'checked' : ''}>ENF. AGENTE</label>
                                    <label class="flex items-center"><input type="radio" name="motivo_reconocimiento" value="PERSONA A CARGO / FAMILIAR" ${incidente.motivo === 'PERSONA A CARGO / FAMILIAR' ? 'checked' : ''}>PERS. A CARGO / FAM.</label>
                                ` : `<p>${incidente.motivo}</p>`}
                                </div>
                                <div><span class="font-semibold">SOLICITUD:</span> ${formatDate(incidente.solicitudFecha)}, ${incidente.solicitudHora}</div>
                            </div>
                        </div>

                        <div class="border-2 border-black p-2">
                            <h3 class="font-bold text-center text-sm mb-2 bg-gray-200 p-1">DEPARTAMENTO RECONOCIMIENTO MÉDICO</h3>
                            <div class="grid grid-cols-1 gap-y-2 text-xs">
                                <div><label class="font-semibold">SÍNTOMAS Y SIGNOS:</label><textarea name="sintomas" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 h-12 bg-gray-50 text-xs dark:bg-gray-700 dark:text-white dark:border-gray-600">${incidente.reconocimiento?.sintomas || ''}</textarea></div>
                                <div><label class="font-semibold">DIAGNÓSTICO:</label><textarea name="diagnostico" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 h-12 bg-gray-50 text-xs dark:bg-gray-700 dark:text-white dark:border-gray-600">${incidente.reconocimiento?.diagnostico || ''}</textarea></div>
                                
                                <div class="flex justify-between items-center border-t border-b py-2 my-1">
                                    <div class="flex items-center space-x-4">
                                        <span class="font-semibold">Cumple tratamiento:</span>
                                        <label><input type="radio" name="cumpleTratamiento" value="SI" ${!isEditable ? 'disabled' : ''} ${incidente.reconocimiento?.cumpleTratamiento === 'SI' ? 'checked' : ''}>SI</label>
                                        <label><input type="radio" name="cumpleTratamiento" value="NO" ${!isEditable ? 'disabled' : ''} ${incidente.reconocimiento?.cumpleTratamiento === 'NO' ? 'checked' : ''}>NO</label>
                                    </div>
                                    <div class="font-bold text-center text-sm">MÉDICO TRATANTE</div>
                                    <div></div>
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    <div>
                                        <label class="font-semibold">MATRÍCULA:</label>
                                        <input type="text" name="medicoMatricula" value="${incidente.reconocimiento?.medicoMatricula || ''}" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 bg-gray-50 text-xs dark:bg-gray-700 dark:text-white dark:border-gray-600" onblur="if(this.value && ${isEditable}) fetchMedicoInfo(this.value)">
                                        <div id="medico-status-container" class="h-4 mt-1"></div>
                                    </div>
                                    <div><label class="font-semibold">NOMBRE Y APELLIDO:</label><input type="text" name="medicoNombre" value="${incidente.reconocimiento?.medicoNombre || ''}" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 bg-gray-50 text-xs dark:bg-gray-700 dark:text-white dark:border-gray-600"></div>
                                </div>
                                
                                <div class="border-t pt-2 mt-2">
                                     <p class="font-bold text-center text-sm mb-1">LICENCIA OTORGADA</p>
                                    <div class="grid grid-cols-4 gap-2 items-end">
                                        <div><label class="font-semibold">DESDE:</label><input type="date" name="licenciaDesde" value="${incidente.reconocimiento?.licenciaDesde || ''}" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 bg-gray-50 text-xs dark:bg-gray-700 dark:text-white dark:border-gray-600" required></div>
                                        <div><label class="font-semibold">DÍAS:</label><input type="number" name="dias" value="${incidente.reconocimiento?.dias || ''}" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 bg-gray-50 text-xs dark:bg-gray-700 dark:text-white dark:border-gray-600" required></div>
                                        <div><label class="font-semibold">HASTA:</label><input type="date" name="altaDesde" value="${incidente.reconocimiento?.altaDesde || ''}" readonly class="w-full border p-1 mt-1 bg-gray-200 text-xs dark:bg-gray-600 dark:text-gray-200"></div>
                                        <div><label class="font-semibold">ENCUADRA:</label><select name="encuadra" ${!isEditable ? 'disabled' : ''} class="w-full border p-1 mt-1 bg-gray-50 text-xs dark:bg-gray-700 dark:text-white dark:border-gray-600" required>
                                            <option value="" disabled selected>-- Sel --</option>
                                            <option value="ART. 14" ${incidente.reconocimiento?.encuadra === 'ART. 14' ? 'selected' : ''}>ART. 14</option>
                                            <option value="ART. 19" ${incidente.reconocimiento?.encuadra === 'ART. 19' ? 'selected' : ''}>ART. 19</option>
                                            <option value="ART. 20" ${incidente.reconocimiento?.encuadra === 'ART. 20' ? 'selected' : ''}>ART. 20</option>
                                            <option value="ART. 29" ${incidente.reconocimiento?.encuadra === 'ART. 29' ? 'selected' : ''}>ART. 29</option>
                                            <option value="ART. 30" ${incidente.reconocimiento?.encuadra === 'ART. 30' ? 'selected' : ''}>ART. 30</option>
                                            <option value="ART. 30 BIS" ${incidente.reconocimiento?.encuadra === 'ART. 30 BIS' ? 'selected' : ''}>ART. 30 BIS</option>
                                            <option value="SIN JUSTIFICAR" ${incidente.reconocimiento?.encuadra === 'SIN JUSTIFICAR' ? 'selected' : ''}>SIN JUSTIFICAR</option>
                                        </select></div>
                                    </div>
                                    <div class="mt-2"><label class="font-semibold">OBSERVACIONES:</label><textarea name="observaciones" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 h-12 bg-gray-50 text-xs dark:bg-gray-700 dark:text-white dark:border-gray-600">${incidente.reconocimiento?.observaciones || ''}</textarea></div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-12 text-right text-xs">
                             <input name="firma_linea_1" ${!isEditable ? 'readonly' : ''} class="w-1/2 ml-auto text-center border-b-2 border-black p-1 ${!isEditable ? 'border-transparent bg-transparent' : 'bg-gray-50 dark:bg-gray-700 dark:text-white'}" value="${incidente.reconocimiento?.firma_linea_1 || 'ALC. MY. DRA. MARÍA LAURA BARRERA'}">
                             <input name="firma_linea_2" ${!isEditable ? 'readonly' : ''} class="w-1/2 ml-auto text-center p-1 ${!isEditable ? 'border-transparent bg-transparent' : 'bg-gray-50 dark:bg-gray-700 dark:text-white'}" value="${incidente.reconocimiento?.firma_linea_2 || 'JEFA DPTO. REC. MÉDICOS'}">
                        </div>

                        ${isEditable ? `<div class="flex justify-end mt-4 no-print"><button type="submit" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700">${isCompleted ? 'Guardar Cambios' : 'Completar'}</button></div>` : ''}
                    </form>
                </div>`;
            showView('form');
            const form = document.getElementById('reconocimiento-form');
            if (isEditable) {
                const licenciaDesdeInput = form.querySelector('input[name="licenciaDesde"]'), diasInput = form.querySelector('input[name="dias"]'), altaDesdeInput = form.querySelector('input[name="altaDesde"]');
                function calcularAlta() { if (licenciaDesdeInput.value && diasInput.value) { const startDate = new Date(licenciaDesdeInput.value + 'T00:00:00'), days = parseInt(diasInput.value, 10); if (!isNaN(days) && days > 0) { startDate.setDate(startDate.getDate() + days - 1); altaDesdeInput.value = startDate.toISOString().slice(0, 10); } else { altaDesdeInput.value = ''; } } }
                licenciaDesdeInput.addEventListener('change', calcularAlta); diasInput.addEventListener('input', calcularAlta);
                form.addEventListener('submit', async function(e) { e.preventDefault(); if (!this.elements.licenciaDesde.value || !this.elements.dias.value || !this.elements.encuadra.value) { showToast('Complete los campos de Licencia.', 'error'); return; } const medicoMatricula = this.elements.medicoMatricula.value.trim().replace(/\//g, '_'), medicoNombre = this.elements.medicoNombre.value.trim(); const incidenteDocRef = doc(db, "incidentes", this.dataset.incidenteId), avisoDocRef = doc(db, "avisos", this.dataset.avisoId); const updatedData = { motivo: this.elements.motivo_reconocimiento.value, estado: 'Completado', reconocimiento: { observaciones: this.elements.observaciones.value, licenciaDesde: this.elements.licenciaDesde.value, dias: this.elements.dias.value, altaDesde: this.elements.altaDesde.value, encuadra: this.elements.encuadra.value, fechaEvaluacion: new Date().toISOString().slice(0, 10), sintomas: this.elements.sintomas.value, diagnostico: this.elements.diagnostico.value, cumpleTratamiento: this.elements.cumpleTratamiento.value, medicoMatricula: medicoMatricula, medicoNombre: medicoNombre, firma_linea_1: this.elements.firma_linea_1.value, firma_linea_2: this.elements.firma_linea_2.value } }; try { if (medicoMatricula && medicoNombre) { const profDocRef = doc(db, "profesionales", medicoMatricula), profDocSnap = await getDoc(profDocRef); const profData = { matricula: medicoMatricula, nombre: medicoNombre }; if (!profDocSnap.exists()) profData.verificado = false; await setDoc(profDocRef, profData, { merge: true }); } await updateDoc(incidenteDocRef, updatedData); await updateDoc(avisoDocRef, { status: 'Completado', diagnostico: this.elements.diagnostico.value, incidenteId: this.dataset.incidenteId, encuadra: this.elements.encuadra.value }); await logActivity(isCompleted ? 'UPDATE_INCIDENTE' : 'COMPLETE_INCIDENTE', `Incidente de ${incidente.empleado}`); showToast('Guardado.', 'success'); showView('completados'); } catch (error) { console.error(error); showToast('Error al guardar.', 'error'); } });
            }
        }
        
        async function updateAsistencia(incidenteId, field, value) { try { await updateDoc(doc(db, "incidentes", incidenteId), { [`asistencia.${field}`]: value }); } catch (error) { console.error(error); } }
        
        // --- PROFESIONALES & BÚSQUEDAS ---
        async function fetchMedicoInfo(matricula) { const nombreInput = document.querySelector('input[name="medicoNombre"]'), statusContainer = document.getElementById('medico-status-container'); if (!nombreInput || !statusContainer) return; statusContainer.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i>'; nombreInput.value = ''; const proxyUrl = 'https://api.allorigins.win/raw?url=', targetUrl = `http://181.13.90.212:8080/consulta_matriculados.php?documento=&matricula=${matricula}`; try { const response = await fetch(`${proxyUrl}${encodeURIComponent(targetUrl)}`); if (!response.ok) throw new Error('Error'); const html = await response.text(), doc = new DOMParser().parseFromString(html, "text/html"), elements = doc.querySelectorAll('p, h2, h3, h4, strong, b, font, div, span'); let nombre = null, status = null; for (let el of elements) { const text = el.textContent.trim(); if (!status && text.toLowerCase().startsWith("matrícula") && text.length < 50) status = text; if (!nombre && (text.startsWith("Dr. ") || text.startsWith("Dra. "))) nombre = text; if (nombre && status) break; } if (nombre) nombreInput.value = nombre; if (status) { const isHabilitada = status.includes('Habilitada') && !status.includes('NO Habilitada'); statusContainer.innerHTML = isHabilitada ? `<span class="text-green-600 dark:text-green-400"><i class="fas fa-check-circle"></i></span>` : `<span class="text-red-600 dark:text-red-400"><i class="fas fa-exclamation-triangle"></i></span>`; } else statusContainer.innerHTML = `<p class="text-xs text-yellow-600 dark:text-yellow-400">No verificado.</p>`; } catch (error) { statusContainer.innerHTML = '<p class="text-xs text-orange-500 dark:text-orange-400">Manual.</p>'; } }
        function openChangePasswordModal() { if (currentUser.afiliado === '136219951') { showToast('Superusuario no modificable.', 'warning'); return; } document.getElementById('change-password-modal').classList.add('flex'); document.getElementById('change-password-modal').classList.remove('hidden'); }
        function closeChangePasswordModal() { document.getElementById('change-password-form').reset(); document.getElementById('change-password-modal').classList.add('hidden'); document.getElementById('change-password-modal').classList.remove('flex'); }
        document.getElementById('change-password-form').addEventListener('submit', async function(e) { e.preventDefault(); const currentPass = document.getElementById('current-password').value, newPass = document.getElementById('new-password').value, confirmPass = document.getElementById('confirm-password').value, errorP = document.getElementById('password-error'); errorP.classList.add('hidden'); if (newPass !== confirmPass) { errorP.textContent = 'No coinciden.'; errorP.classList.remove('hidden'); return; } const userDocRef = doc(db, "users", currentUser.afiliado), userDocSnap = await getDoc(userDocRef); if (userDocSnap.exists() && userDocSnap.data().password === currentPass) { await updateDoc(userDocRef, { password: newPass }); showToast('Contraseña actualizada.', 'success'); closeChangePasswordModal(); } else { errorP.textContent = 'Contraseña incorrecta.'; errorP.classList.remove('hidden'); } });
        
        async function filtrarEvaluadosPorFecha() { const tableId = 'evaluados-table', fecha = document.getElementById('fecha-evaluados').value; if (!fecha) return; const q = query(collection(db, "incidentes"), where("estado", "==", "Completado"), where("reconocimiento.fechaEvaluacion", "==", fecha)); const snapshot = await getDocs(q); allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE }; renderPaginatedTable(tableId); }
        async function filtrarPresentarse() { const tableId = 'presentarse-table', fecha = document.getElementById('fecha-presentarse').value, unidad = document.getElementById('unidad-presentarse').value; if (!fecha) return; const fechaPresentarse = new Date(fecha + 'T00:00:00'); fechaPresentarse.setDate(fechaPresentarse.getDate() - 1); const fechaAltaQuery = fechaPresentarse.toISOString().slice(0, 10); let conditions = [where("reconocimiento.altaDesde", "==", fechaAltaQuery)]; if (unidad !== 'TODAS') conditions.push(where("unidad", "==", unidad)); const q = query(collection(db, "incidentes"), ...conditions), snapshot = await getDocs(q); allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE }; renderPaginatedTable(tableId); }
        
        async function searchAntecedentes() { 
            const tableId = 'antecedentes-table', afiliado = document.getElementById('search-antecedentes-afiliado').value.trim(), matricula = document.getElementById('search-antecedentes-matricula').value.trim(); 
            const printBtn = document.getElementById('btn-print-history');
            printBtn.classList.add('hidden'); 
            if (!afiliado && !matricula) return; 
            let conditions = [where("estado", "==", "Completado")]; 
            if (afiliado) conditions.push(where("afiliado", "==", afiliado)); 
            if (matricula) conditions.push(where("reconocimiento.medicoMatricula", "==", matricula.replace(/\//g, '_'))); 
            const q = query(collection(db, "incidentes"), ...conditions), snapshot = await getDocs(q); 
            
            document.getElementById('antecedentes-table-container').innerHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700"><tr>
            <th class="px-6 py-3 cursor-pointer" onclick="sortTable('antecedentes-table', 0)">Afiliado</th>
            <th class="px-6 py-3 cursor-pointer" onclick="sortTable('antecedentes-table', 1)">Empleado</th>
            <th class="px-6 py-3 cursor-pointer" onclick="sortTable('antecedentes-table', 2)">Unidad</th>
            <th class="px-6 py-3 cursor-pointer" onclick="sortTable('antecedentes-table', 3)">Fecha Ev.</th>
            <th class="px-6 py-3 cursor-pointer" onclick="sortTable('antecedentes-table', 4)">Diagnóstico</th>
            <th class="px-6 py-3 cursor-pointer" onclick="sortTable('antecedentes-table', 5)">Médico</th>
            <th class="px-6 py-3">Acción</th>
            </tr></thead><tbody id="antecedentes-table"></tbody></table></div>`; 
            const results = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            allDataCache[tableId] = results; 
            paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE }; 
            renderPaginatedTable(tableId);
            
            if (afiliado && results.length > 0) {
                printBtn.classList.remove('hidden');
            }
        }

        function generateAntecedentesReport() {
            const data = allDataCache['antecedentes-table'];
            if (!data || data.length === 0) return;
            
            data.sort((a, b) => {
                const dateA = a.solicitudFecha || a.reconocimiento?.fechaEvaluacion || '';
                const dateB = b.solicitudFecha || b.reconocimiento?.fechaEvaluacion || '';
                return dateB.localeCompare(dateA);
            });

            const employee = data[0]; 
            const formContainer = document.getElementById('form-view');
            
            let rowsHtml = '';
            data.forEach(item => {
                const rec = item.reconocimiento || {};
                rowsHtml += `
                    <tr class="border-b text-xs">
                        <td class="p-2">${formatDate(item.solicitudFecha || rec.fechaEvaluacion)}</td>
                        <td class="p-2">${item.unidad || '-'}</td>
                        <td class="p-2">${rec.diagnostico || 'N/A'}</td>
                        <td class="p-2 text-center">${rec.dias || '0'}</td>
                        <td class="p-2 text-center">${formatDate(rec.licenciaDesde) || '-'} al ${formatDate(rec.altaDesde) || '-'}</td>
                        <td class="p-2 text-center">${rec.encuadra || '-'}</td>
                        <td class="p-2 text-xs break-words max-w-xs">${rec.observaciones || ''}</td>
                    </tr>
                `;
            });

            formContainer.innerHTML = `
                <div class="flex justify-end mb-4 space-x-2 no-print">
                    <button onclick="window.print()" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600"><i class="fas fa-print mr-2"></i>Imprimir</button>
                    <button onclick="showView('antecedentes')" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">Volver</button>
                </div>
                <!-- ATENCIÓN: Se eliminó el padding 'p-8' de este div para que el CSS de impresión lo controle -->
                <div id="printable-form" class="bg-white border-2 border-black text-black"> 
                    <div class="flex items-center justify-between mb-6 border-b-2 border-black pb-4 p-1">
                        <img src="https://raw.githubusercontent.com/gutierrezruarte/BibliotecaSPC/main/Escudo-1-279x300-removebg-preview.png" alt="Escudo" class="w-16 h-auto">
                        <div class="text-center">
                            <h2 class="font-bold text-xl uppercase">Historial de Ausentismo Médico</h2>
                            <p class="text-sm">SERVICIO PENITENCIARIO DE CÓRDOBA</p>
                        </div>
                        <div class="w-16"></div>
                    </div>
                    
                    <div class="mb-6 bg-gray-100 p-4 border border-gray-300 rounded mx-1">
                        <h3 class="font-bold text-lg mb-2">Datos del Agente</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <p><span class="font-semibold">Afiliado:</span> ${employee.afiliado}</p>
                            <p><span class="font-semibold">Nombre:</span> ${employee.empleado}</p>
                            <p><span class="font-semibold">Grado:</span> ${employee.grado || '-'}</p>
                            <p><span class="font-semibold">Unidad Actual:</span> ${employee.unidad || '-'}</p>
                        </div>
                    </div>

                    <table class="w-full text-left border-collapse mx-1">
                        <thead>
                            <tr class="bg-gray-200 text-xs uppercase border-b-2 border-black">
                                <th class="p-2">Fecha Aviso</th>
                                <th class="p-2">Unidad</th>
                                <th class="p-2">Diagnóstico</th>
                                <th class="p-2 text-center">Días</th>
                                <th class="p-2 text-center">Período (Desde - Hasta)</th>
                                <th class="p-2 text-center">Encuadre</th>
                                <th class="p-2">Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHtml}
                        </tbody>
                    </table>
                    
                    <div class="mt-8 text-xs text-gray-500 text-right p-1">
                        Generado el: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}
                    </div>
                </div>
            `;
            
            document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
            document.getElementById('form-view').classList.remove('hidden');
        }

        function openAvisosFechaModal() { document.getElementById('avisos-fecha-modal').classList.add('flex'); document.getElementById('avisos-fecha-modal').classList.remove('hidden'); }
        function closeAvisosFechaModal() { document.getElementById('avisos-fecha-modal').classList.add('hidden'); document.getElementById('avisos-fecha-modal').classList.remove('flex'); }
        async function searchAvisosPorFecha() { const tableId = 'avisos-fecha-table', fechaDesde = document.getElementById('search-fecha-aviso-desde').value, fechaHasta = document.getElementById('search-fecha-aviso-hasta').value, encuadraFiltro = document.getElementById('search-encuadra-aviso').value; if (!fechaDesde || !fechaHasta) return; let conditions = []; if (selectedRole === 'personal' && currentUserUnidad !== 'TODAS') conditions.push(where("unidad", "==", currentUserUnidad)); else { conditions.push(where("fecha", ">=", fechaDesde)); conditions.push(where("fecha", "<=", fechaHasta)); } const q = query(collection(db, "avisos"), ...conditions), snapshot = await getDocs(q); const filteredDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(aviso => { const isPersonal = selectedRole === 'personal' && currentUserUnidad !== 'TODAS'; if (isPersonal && (aviso.fecha < fechaDesde || aviso.fecha > fechaHasta)) return false; if (encuadraFiltro && encuadraFiltro !== 'TODOS' && aviso.encuadra !== encuadraFiltro) return false; return true; }); currentAvisosSearchResult = filteredDocs; allDataCache[tableId] = filteredDocs; paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE }; renderPaginatedTable(tableId); }
        function exportAvisosToXLS() { if (currentAvisosSearchResult.length === 0) { showToast("Sin datos.", 'warning'); return; } const data = currentAvisosSearchResult.map(a => ({ 'Afiliado': a.afiliado, 'Empleado': a.empleado, 'Unidad': a.unidad, 'Fecha': a.fecha, 'Estado': a.status, 'Diagnóstico': a.diagnostico, 'Encuadre': a.encuadra })); const ws = XLSX.utils.json_to_sheet(data), wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Avisos"); XLSX.writeFile(wb, `Reporte.xlsx`); }
        async function synchronizeAndListenProfesionales() { if (isSyncingProfesionales) return; isSyncingProfesionales = true; try { const q = query(collection(db, "incidentes"), where("estado", "==", "Completado")); const snap = await getDocs(q); const pros = new Map(); snap.forEach(doc => { const r = doc.data().reconocimiento; if (r && r.medicoMatricula && r.medicoNombre) { const m = r.medicoMatricula.trim().replace(/\//g, '_'); if (!pros.has(m)) pros.set(m, { matricula: m, nombre: r.medicoNombre.trim() }); } }); if (pros.size > 0) { const batch = writeBatch(db); pros.forEach((p, m) => batch.set(doc(db, "profesionales", m), p, { merge: true })); await batch.commit(); } listenToProfesionalesCollection(); } catch (e) { console.error(e); } finally { isSyncingProfesionales = false; } }
        function listenToProfesionalesCollection() { const tableId = 'profesionales-table', viewHeader = document.querySelector('#profesionales-view h2'); unsubscribeProfesionales = onSnapshot(collection(db, "profesionales"), (snapshot) => { viewHeader.textContent = `Gestión de Profesionales (${snapshot.size})`; allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (!paginationState[tableId]) paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE }; renderPaginatedTable(tableId); }); }
        async function updateProfesionalObservaciones(matricula, obs) { try { await updateDoc(doc(db, "profesionales", matricula), { observaciones: obs }); } catch (e) { console.error(e); } }
        function handleObsTextareaKeydown(e, m, v) { if (e.key === 'Enter') { e.preventDefault(); updateProfesionalObservaciones(m, v); e.target.blur(); } }
        async function toggleVerificado(matricula) { try { const ref = doc(db, "profesionales", matricula), snap = await getDoc(ref); if (snap.exists()) await updateDoc(ref, { verificado: !snap.data().verificado }); } catch (e) { console.error(e); } }
        function listenToActivityLog() { const tableId = 'registro-table'; unsubscribeRegistro = onSnapshot(query(collection(db, "activityLog"), orderBy("timestamp", "desc")), (snapshot) => { allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (!paginationState[tableId]) paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE }; renderPaginatedTable(tableId); }); }
        
        // --- FILTRADO, PAGINACIÓN Y ORDENAMIENTO (Omitido para brevedad, pero presente) ---
        function filterTable(tableId) { if (paginationState[tableId]) { paginationState[tableId].currentPage = 1; } renderPaginatedTable(tableId); }
        function changePage(tableId, direction) {
            const state = paginationState[tableId]; if (!state) return;
            const newPage = state.currentPage + direction; const totalRows = (allDataCache[tableId] || []).length; const totalPages = Math.ceil(totalRows / state.rowsPerPage);
            if (newPage >= 1 && newPage <= totalPages) { state.currentPage = newPage; renderPaginatedTable(tableId); }
        }
        function renderPaginatedTable(tableId) {
            const tableBody = document.getElementById(tableId), controlsContainer = document.getElementById(`${tableId}-pagination`);
            if (!tableBody || !controlsContainer) return;
            const allData = allDataCache[tableId] || []; const state = paginationState[tableId]; if (!state) return;

            let searchInputId, columnsToSearch, rowRenderer, emptyMessage, colspan;
            switch (tableId) {
                case 'usuarios-table': searchInputId = 'search-usuarios'; columnsToSearch = [ (item) => item.afiliado, (item) => item.nombreCompleto ]; rowRenderer = getUsuarioRowHtml; emptyMessage = 'No hay usuarios.'; colspan = 4; break;
                case 'avisos-pendientes-table': searchInputId = 'search-avisos-pendientes'; columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado, (item) => item.unidad ]; rowRenderer = (item) => getAvisoRowHtml(item, true); emptyMessage = 'No hay avisos pendientes.'; colspan = 6; break;
                case 'avisos-visados-table': searchInputId = 'search-avisos-visados'; columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado, (item) => item.unidad, (item) => item.diagnostico ]; rowRenderer = (item) => getAvisoRowHtml(item, false); emptyMessage = 'No hay avisos visados.'; colspan = 7; break;
                case 'pendientes-table': searchInputId = 'search-pendientes'; columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado ]; rowRenderer = (item) => getIncidenteRowHtml(item, true); emptyMessage = 'No hay incidentes pendientes.'; colspan = 6; break;
                case 'completados-table': searchInputId = 'search-completados'; columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado ]; rowRenderer = (item) => getIncidenteRowHtml(item, false); emptyMessage = 'No hay incidentes completados.'; colspan = 6; break;
                case 'evaluados-table': searchInputId = 'search-evaluados'; columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado, (item) => item.reconocimiento?.encuadra ]; rowRenderer = getEvaluadoRowHtml; emptyMessage = 'No hay evaluados para esta fecha.'; colspan = 7; break;
                case 'antecedentes-table': searchInputId = 'search-antecedentes'; columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado, (item) => item.reconocimiento?.diagnostico, (item) => item.reconocimiento?.medicoNombre ]; rowRenderer = getAntecedenteRowHtml; emptyMessage = 'No se encontraron antecedentes.'; colspan = 7; break;
                case 'profesionales-table': searchInputId = 'search-profesionales'; columnsToSearch = [ (item) => item.matricula, (item) => item.nombre, (item) => item.observaciones ]; rowRenderer = getProfesionalRowHtml; emptyMessage = 'No hay profesionales.'; colspan = 4; break;
                case 'registro-table': searchInputId = 'search-registro'; columnsToSearch = [ (item) => item.userAfiliado, (item) => item.userName, (item) => item.action, (item) => item.description ]; rowRenderer = getActivityLogRowHtml; emptyMessage = 'No hay actividad registrada.'; colspan = 6; break;
                case 'presentarse-table': searchInputId = 'search-presentarse'; columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado, (item) => item.unidad ]; rowRenderer = (item) => getPresentarseRowHtml(item); emptyMessage = 'No hay personal a presentarse.'; colspan = 8; break;
                case 'avisos-fecha-table': searchInputId = null; columnsToSearch = []; rowRenderer = getAvisoFechaRowHtml; emptyMessage = 'No se encontraron avisos.'; colspan = 7; break;
                default: return;
            }

            const filterInput = searchInputId ? document.getElementById(searchInputId) : null; const filter = filterInput ? filterInput.value.toUpperCase() : '';
            const filteredData = allData.filter(item => { if (filter === '') return true; return columnsToSearch.some(getter => { const value = getter(item); return value && value.toString().toUpperCase().includes(filter); }); });

            const totalRows = filteredData.length; const totalPages = Math.ceil(totalRows / state.rowsPerPage);
            if (state.currentPage > totalPages && totalPages > 0) state.currentPage = totalPages; if (state.currentPage === 0 && totalPages > 0) state.currentPage = 1;
            const startIndex = (state.currentPage - 1) * state.rowsPerPage; const endIndex = startIndex + state.rowsPerPage; const pageData = filteredData.slice(startIndex, endIndex);

            tableBody.innerHTML = '';
            if (pageData.length === 0) tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-4">${emptyMessage}</td></tr>`; else pageData.forEach(item => { 
                let rowHtml = rowRenderer(item);
                if (tableId.includes('avisos') || tableId.includes('pendientes') || tableId.includes('completados') || tableId.includes('evaluados') || tableId.includes('antecedentes') || tableId.includes('presentarse') || tableId.includes('usuarios')) {
                    const afiliado = item.afiliado;
                    if (afiliado && pageData.filter(i => i.afiliado === afiliado).length > 1) {
                        const duplicateClass = 'class="bg-red-200 dark:bg-red-900/50 border-b dark:border-gray-700 hover:bg-red-300 dark:hover:bg-red-800/50"';
                        rowHtml = rowHtml.replace(/class="[^"]*border-b[^"]*"/, duplicateClass);
                    }
                }
                tableBody.innerHTML += rowHtml; 
            });

            controlsContainer.innerHTML = '';
            if (totalPages > 1) { controlsContainer.innerHTML = `<button onclick="changePage('${tableId}', -1)" ${state.currentPage === 1 ? 'disabled' : ''}><i class="fas fa-arrow-left"></i></button><span>Página ${state.currentPage} de ${totalPages} (${totalRows} registros)</span><button onclick="changePage('${tableId}', 1)" ${state.currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-arrow-right"></i></button>`; } else { controlsContainer.innerHTML = `<span>${totalRows} registros</span>`; }
        }
        
        function getUsuarioRowHtml(user) { const roles = Array.isArray(user.roles) ? user.roles.join(', ') : (user.role || 'N/A'); return `<tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"><td class="px-6 py-4 text-gray-900 dark:text-white">${user.afiliado}</td><td class="px-6 py-4 text-gray-900 dark:text-white">${user.nombreCompleto}</td><td class="px-6 py-4 capitalize text-gray-900 dark:text-white">${roles}</td><td class="px-6 py-4 space-x-2"><button onclick="openUsuarioModal('${user.afiliado}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300" title="Editar"><i class="fas fa-edit"></i></button><button onclick="resetPassword('${user.afiliado}')" class="text-yellow-600 dark:text-yellow-400 hover:text-yellow-800 dark:hover:text-yellow-300" title="Blanquear Contraseña"><i class="fas fa-key"></i></button><button onclick="deleteUser('${user.afiliado}')" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300" title="Eliminar"><i class="fas fa-trash"></i></button></td></tr>`; }
        function getAvisoRowHtml(aviso, isPending) { 
            let actionsHtml = '<td class="px-6 py-4 space-x-2 text-right">'; 
            if (isPending) { 
                const canEdit = (selectedRole === 'administrador') || (selectedRole === 'personal'); 
                const canDelete = selectedRole === 'administrador'; 
                if (canEdit) actionsHtml += `<button onclick="openAvisoModal('${aviso.id}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800" title="Editar"><i class="fas fa-edit"></i></button>`; 
                if (canDelete) actionsHtml += `<button onclick="deleteAviso('${aviso.id}')" class="text-red-600 dark:text-red-400 hover:text-red-800" title="Eliminar"><i class="fas fa-trash"></i></button>`; 
            } else { 
                if (aviso.incidenteId) actionsHtml += `<button onclick="openFormulario('${aviso.incidenteId}', 'avisos-visados', true)" class="text-gray-500 dark:text-gray-400 hover:text-blue-600" title="Ver Carta Médica"><i class="fas fa-eye"></i></button>`; 
                if (selectedRole === 'administrador') { 
                    actionsHtml += `<button onclick="openAvisoModal('${aviso.id}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800" title="Editar"><i class="fas fa-edit"></i></button>`; 
                    actionsHtml += `<button onclick="deleteAviso('${aviso.id}')" class="text-red-600 dark:text-red-400 hover:text-red-800" title="Eliminar"><i class="fas fa-trash"></i></button>`; 
                } 
            } 
            actionsHtml += '</td>'; 

            // --- PENDING (6 COLUMNS) ---
            if (isPending) {
                // Header: Afiliado, Empleado, Unidad, Fecha Aviso, Tipo Solicitud, Acciones (6)
                return `<tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4">${aviso.afiliado || 'N/A'}</td>
                    <td class="px-6 py-4">${aviso.empleado}</td>
                    <td class="px-6 py-4">${getUnidadTag(aviso.unidad)}</td>
                    <td class="px-6 py-4">${formatDate(aviso.fecha)}</td>
                    <td class="px-6 py-4">${aviso.status}</td> <!-- Muestra el Status como Tipo Solicitud (siempre Pendiente) para mantener la columna -->
                    ${actionsHtml}
                </tr>`;
            }
            // --- VISADO (7 COLUMNS) ---
            else {
                // Header: Afiliado, Empleado, Unidad, Fecha Aviso, Diagnóstico, Encuadre, Acciones (7)
                return `<tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4">${aviso.afiliado || 'N/A'}</td>
                    <td class="px-6 py-4">${aviso.empleado}</td>
                    <td class="px-6 py-4">${getUnidadTag(aviso.unidad)}</td>
                    <td class="px-6 py-4">${formatDate(aviso.fecha)}</td>
                    <td class="px-6 py-4 text-xs">${aviso.diagnostico || 'N/A'}</td>
                    <td class="px-6 py-4 text-xs">${aviso.encuadra || 'N/A'}</td>
                    ${actionsHtml}
                </tr>`;
            }
        }
        function getIncidenteRowHtml(incidente, isPending) { const dateField = formatDate(isPending ? incidente.solicitudFecha : (incidente.reconocimiento?.fechaEvaluacion)); const btnText = isPending ? 'Evaluar' : 'Ver/Editar'; const view = isPending ? 'pendientes' : 'completados'; let actionsHtml = `<button onclick="openFormulario('${incidente.id}', '${view}')" class="text-blue-600 dark:text-blue-400 hover:underline">${btnText}</button>`; if (selectedRole === 'administrador' && incidente.avisoId) { actionsHtml += `<button onclick="deleteAviso('${incidente.avisoId}')" class="text-red-600 dark:text-red-400 hover:text-red-800 ml-4" title="Eliminar Incidente y Aviso"><i class="fas fa-trash"></i></button>`; } return `<tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"><td class="px-6 py-4">${incidente.id || 'N/A'}</td><td class="px-6 py-4">${incidente.afiliado || 'N/A'}</td><td class="px-6 py-4">${incidente.empleado}</td><td class="px-6 py-4">${getUnidadTag(incidente.unidad)}</td><td class="px-6 py-4">${dateField}</td><td class="px-6 py-4">${actionsHtml}</td></tr>`; }
        function getEvaluadoRowHtml(inc) { return `<tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"><td class="px-6 py-4">${inc.id}</td><td class="px-6 py-4">${inc.afiliado}</td><td class="px-6 py-4">${inc.empleado}</td><td class="px-6 py-4">${getUnidadTag(inc.unidad)}</td><td class="px-6 py-4">${formatDate(inc.reconocimiento.fechaEvaluacion)}</td><td class="px-6 py-4">${inc.reconocimiento.encuadra}</td><td class="px-6 py-4"><button onclick="openFormulario('${inc.id}', 'evaluados')" class="text-blue-600 dark:text-blue-400 hover:underline">Ver</button></td></tr>`; }
        function getAntecedenteRowHtml(i) { const r = i.reconocimiento; return `<tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"><td class="px-6 py-4">${i.afiliado}</td><td class="px-6 py-4">${i.empleado}</td><td class="px-6 py-4">${getUnidadTag(i.unidad)}</td><td class="px-6 py-4">${formatDate(r.fechaEvaluacion)}</td><td class="px-6 py-4">${r.diagnostico||'N/A'}</td><td class="px-6 py-4">${r.medicoNombre||'N/A'} (Mat: ${r.medicoMatricula||'N/A'})</td><td class="px-6 py-4"><button onclick="openFormulario('${i.id}', 'antecedentes')" class="text-blue-600 dark:text-blue-400 hover:underline">Ver</button></td></tr>`; }
        function getPresentarseRowHtml(inc) { const finLicencia = inc.reconocimiento.altaDesde; const fechaPresentarse = new Date(finLicencia + 'T00:00:00'); fechaPresentarse.setDate(fechaPresentarse.getDate() + 1); const debePresentarse = fechaPresentarse.toISOString().slice(0, 10); const isEditable = selectedRole === 'personal' && currentUserUnidad !== 'TODAS' && inc.unidad === currentUserUnidad; const presento = isEditable ? `<input type="checkbox" onchange="updateAsistencia('${inc.id}','sePresento',this.checked)" ${inc.asistencia?.sePresento ? 'checked' : ''}>` : (inc.asistencia?.sePresento ? 'Sí' : 'No'); const comunico = isEditable ? `<input type="checkbox" onchange="updateAsistencia('${inc.id}','seComunico',this.checked)" ${inc.asistencia?.seComunico ? 'checked' : ''}>` : (inc.asistencia?.seComunico ? 'Sí' : 'No'); const obs = isEditable ? `<textarea oninput="updateAsistencia('${inc.id}','observaciones',this.value)" class="w-full bg-gray-50 dark:bg-gray-700 border p-1 dark:border-gray-600 dark:text-white text-xs">${inc.asistencia?.observaciones || ''}</textarea>` : `<p>${inc.asistencia?.observaciones || ''}</p>`; return `<tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"><td class="px-6 py-4">${inc.afiliado}</td><td class="px-6 py-4">${inc.empleado}</td><td class="px-6 py-4">${getUnidadTag(inc.unidad)}</td><td class="px-6 py-4">${formatDate(finLicencia)}</td><td class="px-6 py-4">${formatDate(debePresentarse)}</td><td class="px-6 py-4">${presento}</td><td class="px-6 py-4">${comunico}</td><td class="px-6 py-4">${obs}</td></tr>`; }
        function getProfesionalRowHtml(prof) { const rowClass = prof.verificado ? 'bg-green-100 text-green-900 dark:bg-green-900/30 dark:text-green-100' : 'bg-white dark:bg-gray-800'; const textClass = prof.verificado ? 'font-medium' : ''; return `<tr class="${rowClass} border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"><td class="px-6 py-4 ${textClass}">${prof.matricula}</td><td class="px-6 py-4 ${textClass}">${prof.nombre}</td><td class="px-6 py-4"><input type="checkbox" ${prof.verificado ? 'checked' : ''} onchange="toggleVerificado('${prof.matricula}')" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"></td><td class="px-6 py-4"><textarea onblur="updateProfesionalObservaciones('${prof.matricula}', this.value)" onkeydown="handleObsTextareaKeydown(event, '${prof.matricula}', this.value)" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-xs rounded-lg p-2" rows="2" placeholder="Añadir nota...">${prof.observaciones || ''}</textarea></td></tr>`; }
        function getActivityLogRowHtml(log) { const date = log.timestamp.toDate(); const formattedDate = date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + date.toLocaleTimeString('es-AR'); return `<tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"><td class="px-6 py-4 text-gray-500 dark:text-gray-400 text-xs">${formattedDate}</td><td class="px-6 py-4">${log.userAfiliado}</td><td class="px-6 py-4 font-medium">${log.userName}</td><td class="px-6 py-4">${log.action}</td><td class="px-6 py-4 capitalize">${log.userRole}</td><td class="px-6 py-4 text-sm">${log.description}</td></tr>`; }
        function getAvisoFechaRowHtml(aviso) { const statusClass = aviso.status === 'Completado' ? 'text-green-600 dark:text-green-400' : 'text-yellow-600 dark:text-yellow-400'; const encuadreHtml = aviso.encuadra || (aviso.status === 'Completado' ? 'N/A' : ''); return `<tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"><td class="px-4 py-2">${aviso.afiliado || 'N/A'}</td><td class="px-4 py-2">${aviso.empleado}</td><td class="px-4 py-2">${getUnidadTag(aviso.unidad)}</td><td class="px-4 py-2">${formatDate(aviso.fecha)}</td><td class="px-4 py-2 font-semibold ${statusClass}">${aviso.status}</td><td class="px-4 py-2">${encuadreHtml}</td><td class="px-4 py-2 space-x-2"><button onclick="openFormulario('${aviso.incidenteId}', 'avisos-fecha-modal', true)" class="text-gray-500 dark:text-gray-400 hover:text-blue-600" title="Ver Carta Médica"><i class="fas fa-eye"></i></button></td></tr>`; }
        
        function sortTable(tableId, colIndex) {
            const tbody = document.getElementById(tableId); if (!tbody) return; const tableElement = tbody.closest('table'); if (!tableElement) return;
            const rows = Array.from(tbody.rows); const key = `${tableId}-${colIndex}`; const currentDir = sortState[key] || 'asc'; const newDir = currentDir === 'asc' ? 'desc' : 'asc'; sortState[key] = newDir;
            tableElement.querySelectorAll('th i').forEach(icon => { if (icon.classList.contains('fa-sort-up') || icon.classList.contains('fa-sort-down')) { icon.classList.remove('fa-sort-up', 'fa-sort-down'); icon.classList.add('fa-sort'); } });
            const headerIcon = tableElement.querySelector(`thead th:nth-child(${colIndex + 1}) i`); if (headerIcon) { headerIcon.classList.remove('fa-sort'); headerIcon.classList.add(newDir === 'asc' ? 'fa-sort-up' : 'fa-sort-down'); }
            rows.sort((a, b) => { let valA, valB; if (!a.cells[colIndex] || !b.cells[colIndex]) return 0; if (tableId === 'profesionales-table' && colIndex === 2) { valA = a.cells[colIndex].querySelector('input[type="checkbox"]').checked; valB = b.cells[colIndex].querySelector('input[type="checkbox"]').checked; } else if (tableId === 'profesionales-table' && colIndex === 3) { valA = a.cells[colIndex].querySelector('textarea').value.toUpperCase(); valB = b.cells[colIndex].querySelector('textarea').value.toUpperCase(); } else { valA = a.cells[colIndex].textContent.trim(); valB = b.cells[colIndex].textContent.trim(); const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})/; if (dateRegex.test(valA) && dateRegex.test(valB)) { try { const [dayA, monthA, yearA] = valA.match(dateRegex).slice(1); const [dayB, monthB, yearB] = valB.match(dateRegex).slice(1); valA = `${yearA}-${monthA}-${dayA}`; valB = `${yearB}-${monthB}-${dayB}`; } catch(e) {} } else if (valA && valB && !isNaN(valA) && !isNaN(valB)) { valA = parseFloat(valA); valB = parseFloat(valB); } else { valA = valA.toUpperCase(); valB = valB.toUpperCase(); } } if (valA < valB) return newDir === 'asc' ? -1 : 1; if (valA > valB) return newDir === 'asc' ? 1 : -1; return 0; });
            rows.forEach(row => tbody.appendChild(row));
        }

        window.onload = () => { 
            const today = new Date().toISOString().slice(0, 10);
            const setDateValue = (id) => { const el = document.getElementById(id); if (el) el.value = today; };
            setDateValue('solicitud-fecha'); setDateValue('search-fecha-aviso-desde'); setDateValue('search-fecha-aviso-hasta'); setDateValue('fecha-evaluados'); setDateValue('fecha-presentarse');
            document.getElementById('confirm-modal-cancel-btn').addEventListener('click', closeConfirmModal);
            document.getElementById('confirm-modal-confirm-btn').addEventListener('click', () => { if (typeof _onConfirmCallback === 'function') { _onConfirmCallback(); } closeConfirmModal(); });
            if (localStorage.getItem('theme') === 'dark') { document.documentElement.classList.add('dark'); }
            Object.assign(window, { 
                selectRole, goBackToRoleSelection, continueLoginPersonal, goBackToLogin, logout, 
                showView, openUsuarioModal, closeUsuarioModal, precargarDatosUsuario, resetPassword, deleteUser, 
                handleFileUpload, openAvisoModal, closeAvisoModal, precargarDatosAfiliado, deleteAviso, __internalDeleteAviso, openConfirmModal, closeConfirmModal, checkAvisoSuperposicion, openFormulario, updateAsistencia, filtrarEvaluadosPorFecha, filtrarPresentarse, searchAntecedentes, openChangePasswordModal, closeChangePasswordModal, filterTable, changePage, openAvisosFechaModal, closeAvisosFechaModal, searchAvisosPorFecha, exportAvisosToXLS, toggleVerificado, sortTable, synchronizeAndListenProfesionales, listenToProfesionalesCollection, fetchMedicoInfo, updateProfesionalObservaciones, handleObsTextareaKeydown, calculateAndRenderMetrics, showToast, toggleDarkMode,
                generateAntecedentesReport
            }); 
        };
    </script>
</body>
</html>
