<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Control Médico de Ausentismos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilos personalizados y para impresión */
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-form, #printable-form * {
                visibility: visible;
            }
            #printable-form {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @media print {
            .no-print { display: none; }
            #sidebar, #main-portal > header { display: none; }
            body, #main-portal, .flex-1, main {
                display: block; padding: 0; margin: 0; width: 100%; height: auto;
                overflow: visible; background-color: #fff;
            }
            main > .view-content:not(#form-view) { display: none; }
            #form-view { display: block !important; visibility: visible !important; }
            #printable-form { border: none !important; box-shadow: none !important; padding: 0; margin: 0; width: 100%; }
            textarea[readonly].signature-field {
                border-color: transparent;
                background-color: transparent;
                resize: none;
            }
        }
        /* Estilos para la paginación */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
        }
        .pagination-controls button {
            background-color: #d1d5db; /* bg-gray-300 */
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem; /* rounded-lg */
            transition: background-color 0.2s;
        }
        .pagination-controls button:hover:not(:disabled) {
            background-color: #9ca3af; /* bg-gray-400 */
        }
        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-controls span {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* text-gray-600 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Pantalla de Login -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg text-center">
            <img src="https://raw.githubusercontent.com/gutierrezruarte/BibliotecaSPC/main/Escudo-1-279x300-removebg-preview.png" alt="Escudo Institucional" class="w-24 h-auto mx-auto mb-4">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Portal de Gestión Médica</h1>
            <p class="text-gray-600 mb-6">Ingrese sus credenciales</p>
            <form id="login-form">
                <div class="space-y-4">
                    <input type="text" id="login-afiliado" placeholder="Número de Afiliado" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" required>
                    <input type="password" id="login-password" placeholder="Contraseña" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" required>
                     <p id="login-error" class="text-red-500 text-sm hidden"></p>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                        Ingresar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Pantalla de Selección de Rol -->
    <div id="role-selection-screen" class="hidden items-center justify-center min-h-screen">
        <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg text-center">
             <i class="fas fa-user-shield text-5xl text-amber-500 mb-4"></i>
             <h1 class="text-2xl font-bold text-gray-800 mb-2">Seleccionar Rol</h1>
             <p class="text-gray-600 mb-6">Usted tiene múltiples roles. Por favor, elija con cuál desea ingresar.</p>
             <div id="role-buttons-container" class="space-y-3">
                <!-- Botones de rol se cargarán dinámicamente -->
             </div>
             <button onclick="goBackToLogin()" class="w-full text-gray-600 py-2 px-4 rounded-lg hover:bg-gray-200 transition duration-300 mt-4">
                Volver
            </button>
        </div>
    </div>

    <!-- Pantalla de Selección de Unidad para Personal -->
    <div id="unidad-selection-screen" class="hidden items-center justify-center min-h-screen">
        <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg text-center">
             <i class="fas fa-building text-5xl text-green-600 mb-4"></i>
             <h1 class="text-2xl font-bold text-gray-800 mb-2">Seleccionar Unidad</h1>
             <p class="text-gray-600 mb-6">Por favor, elija su unidad para continuar.</p>
             <div class="space-y-4">
                <select id="login-unidad-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    <!-- Opciones se cargarán dinámicamente -->
                </select>
                <button onclick="continueLoginPersonal()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300">
                    Continuar
                </button>
                <button onclick="goBackToLogin()" class="w-full text-gray-600 py-2 px-4 rounded-lg hover:bg-gray-200 transition duration-300">
                    Volver
                </button>
             </div>
        </div>
    </div>


    <!-- Portal Principal (oculto por defecto) -->
    <div id="main-portal" class="hidden">
        <div class="flex h-screen bg-gray-200">
            <!-- Sidebar -->
            <div id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col no-print">
                <div class="px-8 py-6 border-b border-gray-700">
                    <h2 class="text-2xl font-semibold">Control de Ausentismo</h2>
                    <p id="user-role" class="text-sm text-gray-400 capitalize"></p>
                </div>
                <nav class="flex-1 px-6 py-4 space-y-2">
                    <!-- Links para Administrador -->
                    <div id="admin-links" class="hidden">
                        <a href="#" onclick="showView('inicio')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-home w-6"></i> Inicio</a>
                        <a href="#" onclick="showView('usuarios')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-users-cog w-6"></i> Gestionar Usuarios</a>
                        <a href="#" onclick="showView('importar')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-file-excel w-6"></i> Importar Personal</a>
                        <a href="#" onclick="showView('avisos-pendientes')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-folder-open w-6"></i> Avisos Pendientes</a>
                        <a href="#" onclick="showView('avisos-visados')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-folder-check w-6"></i> Avisos Visados</a>
                        <a href="#" onclick="showView('presentarse')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-calendar-check w-6"></i> Presentarse a Trabajar</a>
                        <a href="#" onclick="showView('registro')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-clipboard-list w-6"></i> Registro de Actividad</a>
                    </div>
                    <!-- Links para Personal -->
                    <div id="personal-links" class="hidden">
                         <a href="#" onclick="showView('inicio')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-home w-6"></i> Inicio</a>
                         <a href="#" onclick="showView('avisos-pendientes')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-folder-open w-6"></i> Avisos Pendientes</a>
                         <a href="#" onclick="showView('avisos-visados')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-folder-check w-6"></i> Avisos Visados</a>
                         <a href="#" onclick="showView('presentarse')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-calendar-check w-6"></i> Presentarse a Trabajar</a>
                    </div>
                    <!-- Links para Reconocimientos Médicos -->
                    <div id="reconocimientos-links" class="hidden">
                        <a href="#" onclick="showView('inicio')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-home w-6"></i> Inicio</a>
                        <a href="#" onclick="showView('pendientes')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-hourglass-half w-6"></i> Pendientes</a>
                        <a href="#" onclick="showView('completados')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-check-double w-6"></i> Completados</a>
                        <a href="#" onclick="showView('evaluados')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-history w-6"></i> Evaluados por Fecha</a>
                        <a href="#" onclick="showView('antecedentes')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-search-plus w-6"></i> Buscar Antecedentes</a>
                        <a href="#" onclick="showView('profesionales')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-user-md w-6"></i> Profesionales</a>
                        <a href="#" onclick="showView('presentarse')" class="flex items-center px-4 py-2 text-gray-300 rounded-md hover:bg-gray-700 hover:text-white"><i class="fas fa-calendar-check w-6"></i> Presentarse a Trabajar</a>
                    </div>
                </nav>
                 <div class="px-8 py-4 mt-auto border-t border-gray-700">
                    <button id="change-role-btn" onclick="goBackToRoleSelection()" class="hidden w-full bg-amber-500 text-white py-2 px-4 rounded-lg hover:bg-amber-600 transition duration-300 flex items-center justify-center space-x-2 mb-2">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Cambiar Rol</span>
                    </button>
                    <button onclick="openChangePasswordModal()" class="w-full bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-300 flex items-center justify-center space-x-2 mb-2">
                        <i class="fas fa-lock"></i>
                        <span>Cambiar Contraseña</span>
                    </button>
                    <button onclick="logout()" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300 flex items-center justify-center space-x-2">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Cerrar Sesión</span>
                    </button>
                </div>
            </div>

            <!-- Contenido Principal -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="flex justify-between items-center p-6 bg-white border-b border-gray-200 no-print">
                    <h1 id="view-title" class="text-2xl font-semibold text-gray-800">Bienvenido</h1>
                </header>
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                    
                    <!-- Vistas -->
                     <div id="inicio-view" class="view-content hidden fade-in">
                        <!-- El contenido se generará dinámicamente -->
                    </div>

                    <div id="usuarios-view" class="view-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-700">Gestión de Usuarios</h2>
                            <button onclick="openUsuarioModal()" class="bg-blue-600 text-white py-2 px-5 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center space-x-2">
                                <i class="fas fa-user-plus"></i>
                                <span>Nuevo Usuario</span>
                            </button>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                             <div class="mb-4">
                                <input type="text" id="search-usuarios" onkeyup="filterTable('usuarios-table')" placeholder="Buscar por Afiliado o Nombre..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                             </div>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Afiliado</th>
                                            <th scope="col" class="px-6 py-3">Nombre</th>
                                            <th scope="col" class.="px-6 py-3">Roles</th>
                                            <th scope="col" class="px-6 py-3">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usuarios-table">
                                        <!-- Filas se insertarán dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="usuarios-table-pagination" class="pagination-controls mt-4"></div>
                        </div>
                    </div>

                     <div id="importar-view" class="view-content hidden fade-in">
                        <h2 class="text-3xl font-bold mb-4 text-gray-700">Importar Personal desde Excel</h2>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <p class="mb-4 text-gray-600">Seleccione un archivo Excel (.xlsx, .xls) con los datos del personal. La primera fila debe contener los encabezados de las columnas.</p>
                            <p class="mb-4 text-sm text-gray-500">Columnas requeridas: <strong>Matricula, Apellido y Nombre, Jerarquia, Dom_actua, Funcion</strong>.</p>
                            <div class="flex items-center space-x-4">
                                <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                                <button onclick="handleFileUpload()" class="bg-green-600 text-white py-2 px-5 rounded-lg hover:bg-green-700 transition duration-300 flex-shrink-0">
                                    <i class="fas fa-upload mr-2"></i>Cargar
                                </button>
                            </div>
                            <div id="import-status" class="mt-4"></div>
                        </div>
                    </div>

                    <div id="avisos-pendientes-view" class="view-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-700">Avisos de Carpetas Pendientes</h2>
                            <div class="flex items-center space-x-2">
                                <button onclick="openAvisosFechaModal()" class="bg-teal-500 text-white py-2 px-5 rounded-lg hover:bg-teal-600 transition duration-300 flex items-center space-x-2">
                                    <i class="fas fa-calendar-day"></i>
                                    <span>Avisos por Período</span>
                                </button>
                                <button id="nuevo-aviso-btn" onclick="openAvisoModal()" class="bg-blue-600 text-white py-2 px-5 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center space-x-2">
                                    <i class="fas fa-plus"></i>
                                    <span>Nuevo Aviso</span>
                                </button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <div class="mb-4">
                                <input type="text" id="search-avisos-pendientes" onkeyup="filterTable('avisos-pendientes-table')" placeholder="Buscar por Afiliado, Empleado o Unidad..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Afiliado</th>
                                            <th scope="col" class="px-6 py-3">Empleado</th>
                                            <th scope="col" class="px-6 py-3">Dep.</th>
                                            <th scope="col" class="px-6 py-3">Fecha Aviso</th>
                                            <th scope="col" class="px-6 py-3">Unidad</th>
                                            <th scope="col" class="px-6 py-3" id="avisos-pendientes-actions-header">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="avisos-pendientes-table"></tbody>
                                </table>
                            </div>
                            <div id="avisos-pendientes-table-pagination" class="pagination-controls mt-4"></div>
                        </div>
                    </div>
                    
                    <div id="avisos-visados-view" class="view-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-700">Avisos de Carpetas Visados</h2>
                             <button onclick="openAvisosFechaModal()" class="bg-teal-500 text-white py-2 px-5 rounded-lg hover:bg-teal-600 transition duration-300 flex items-center space-x-2">
                                <i class="fas fa-calendar-day"></i>
                                <span>Avisos por Período</span>
                            </button>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <input type="text" id="search-avisos-visados" onkeyup="filterTable('avisos-visados-table')" placeholder="Buscar por Afiliado, Empleado, Unidad o Diagnóstico..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                <select id="filtro-encuadra" onchange="showView('avisos-visados')" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                    <option value="TODOS">Filtrar por Encuadre (Todos)</option>
                                    <option value="ART. 14">ART. 14</option>
                                    <option value="ART. 19">ART. 19</option>
                                    <option value="ART. 20">ART. 20</option>
                                    <option value="ART. 29">ART. 29</option>
                                    <option value="ART. 30">ART. 30</option>
                                    <option value="ART. 30 BIS">ART. 30 BIS</option>
                                    <option value="SIN JUSTIFICAR">SIN JUSTIFICAR</option>
                                </select>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Afiliado</th>
                                            <th scope="col" class="px-6 py-3">Empleado</th>
                                            <th scope="col" class="px-6 py-3">Dep.</th>
                                            <th scope="col" class="px-6 py-3">Fecha Aviso</th>
                                            <th scope="col" class="px-6 py-3">Unidad</th>
                                            <th scope="col" class="px-6 py-3">Diagnóstico</th>
                                            <th scope="col" class="px-6 py-3">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="avisos-visados-table"></tbody>
                                </table>
                            </div>
                            <div id="avisos-visados-table-pagination" class="pagination-controls mt-4"></div>
                        </div>
                    </div>

                    <div id="pendientes-view" class="view-content hidden fade-in">
                         <h2 class="text-3xl font-bold mb-6 text-gray-700">Incidentes Pendientes</h2>
                         <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <div class="mb-4">
                                <input type="text" id="search-pendientes" onkeyup="filterTable('pendientes-table')" placeholder="Buscar por Afiliado o Empleado..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">N° Incidente</th>
                                            <th scope="col" class="px-6 py-3">Afiliado</th>
                                            <th scope="col" class="px-6 py-3">Empleado</th>
                                            <th scope="col" class="px-6 py-3">Dep.</th>
                                            <th scope="col" class="px-6 py-3">Fecha Solicitud</th>
                                            <th scope="col" class="px-6 py-3">Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pendientes-table"></tbody>
                                </table>
                            </div>
                            <div id="pendientes-table-pagination" class="pagination-controls mt-4"></div>
                        </div>
                    </div>
                    
                    <div id="completados-view" class="view-content hidden fade-in">
                         <h2 class="text-3xl font-bold mb-6 text-gray-700">Incidentes Completados</h2>
                         <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <div class="mb-4">
                                <input type="text" id="search-completados" onkeyup="filterTable('completados-table')" placeholder="Buscar por Afiliado o Empleado..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">N° Incidente</th>
                                            <th scope="col" class="px-6 py-3">Afiliado</th>
                                            <th scope="col" class="px-6 py-3">Empleado</th>
                                            <th scope="col" class="px-6 py-3">Dep.</th>
                                            <th scope="col" class="px-6 py-3">Fecha Evaluación</th>
                                            <th scope="col" class="px-6 py-3">Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="completados-table"></tbody>
                                </table>
                            </div>
                            <div id="completados-table-pagination" class="pagination-controls mt-4"></div>
                        </div>
                    </div>
                    
                    <div id="evaluados-view" class="view-content hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-700">Consultar Evaluados por Fecha</h2>
                        <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="fecha-evaluados" class="block mb-2 text-sm font-medium text-gray-900">Fecha de Evaluación</label>
                                    <input type="date" id="fecha-evaluados" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                </div>
                                <button onclick="filtrarEvaluadosPorFecha()" class="bg-blue-600 text-white py-2.5 px-5 rounded-lg hover:bg-blue-700 transition duration-300">Buscar</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <div class="mb-4">
                                <input type="text" id="search-evaluados" onkeyup="filterTable('evaluados-table')" placeholder="Buscar por Afiliado, Empleado o Encuadre..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">N° Incidente</th>
                                            <th scope="col" class="px-6 py-3">Afiliado</th>
                                            <th scope="col" class="px-6 py-3">Empleado</th>
                                            <th scope="col" class="px-6 py-3">Dep.</th>
                                            <th scope="col" class="px-6 py-3">Fecha Evaluación</th>
                                            <th scope="col" class="px-6 py-3">Encuadra</th>
                                            <th scope="col" class="px-6 py-3">Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="evaluados-table">
                                       <tr><td colspan="7" class="text-center p-4">Seleccione una fecha para buscar.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="evaluados-table-pagination" class="pagination-controls mt-4"></div>
                        </div>
                    </div>
                    
                    <div id="antecedentes-view" class="view-content hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-700">Buscar Antecedentes Médicos</h2>
                        <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="search-antecedentes-afiliado" class="block mb-2 text-sm font-medium text-gray-900">N° de Afiliado</label>
                                    <input type="text" id="search-antecedentes-afiliado" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                </div>
                                <div>
                                    <label for="search-antecedentes-matricula" class="block mb-2 text-sm font-medium text-gray-900">Matrícula Profesional</label>
                                    <input type="text" id="search-antecedentes-matricula" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                </div>
                                <button onclick="searchAntecedentes()" class="bg-blue-600 text-white py-2.5 px-5 rounded-lg hover:bg-blue-700 transition duration-300">Buscar</button>
                            </div>
                             <p class="text-xs text-gray-500 mt-2">Ingrese al menos un campo para buscar.</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Resultados</h3>
                             <div class="mb-4">
                                <input type="text" id="search-antecedentes" onkeyup="filterTable('antecedentes-table')" placeholder="Filtrar resultados..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                            <div id="antecedentes-table-container">
                               <p class="text-center p-4">Ingrese un criterio de búsqueda para ver los resultados.</p>
                            </div>
                            <div id="antecedentes-table-pagination" class="pagination-controls mt-4"></div>
                        </div>
                    </div>

                    <div id="profesionales-view" class="view-content hidden fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-700">Gestión de Profesionales</h2>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                             <div class="mb-4">
                                <!-- CAMBIO: Se añade la columna 3 (observaciones) a la búsqueda -->
                                <input type="text" id="search-profesionales" onkeyup="filterTable('profesionales-table')" placeholder="Buscar por Matrícula, Nombre u Observación..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                             </div>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('profesionales-table', 0)">Matrícula <i class="fas fa-sort"></i></th>
                                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('profesionales-table', 1)">Nombre y Apellido <i class="fas fa-sort"></i></th>
                                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('profesionales-table', 2)">Verificado <i class="fas fa-sort"></i></th>
                                            <!-- NUEVA COLUMNA -->
                                            <th scope="col" class="px-6 py-3 cursor-pointer" onclick="sortTable('profesionales-table', 3)">Observaciones <i class="fas fa-sort"></i></th>
                                        </tr>
                                    </thead>
                                    <tbody id="profesionales-table">
                                        <!-- Filas se insertarán dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="profesionales-table-pagination" class="pagination-controls mt-4"></div>
                        </div>
                    </div>

                    <div id="registro-view" class="view-content hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-700">Registro de Actividad del Sistema</h2>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <div class="mb-4">
                                <input type="text" id="search-registro" onkeyup="filterTable('registro-table')" placeholder="Buscar por afiliado, usuario, acción o descripción..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Fecha y Hora</th>
                                            <th scope="col" class="px-6 py-3">Afiliado</th>
                                            <th scope="col" class="px-6 py-3">Usuario</th>
                                            <th scope="col" class="px-6 py-3">Acción</th>
                                            <th scope="col" class="px-6 py-3">Rol</th>
                                            <th scope="col" class="px-6 py-3">Descripción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="registro-table"></tbody>
                                </table>
                            </div>
                            <div id="registro-table-pagination" class="pagination-controls mt-4"></div>
                        </div>
                    </div>

                    <div id="form-view" class="view-content hidden fade-in">
                        <!-- El formulario se renderizará aquí -->
                    </div>

                    <div id="presentarse-view" class="view-content hidden fade-in">
                        <h2 class="text-3xl font-bold mb-6 text-gray-700">Consultar Personal a Presentarse</h2>
                        <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="fecha-presentarse" class="block mb-2 text-sm font-medium text-gray-900">Fecha de Presentación</label>
                                    <input type="date" id="fecha-presentarse" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                </div>
                                <div>
                                    <label for="unidad-presentarse" class="block mb-2 text-sm font-medium text-gray-900">Unidad</label>
                                    <select id="unidad-presentarse" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                        <option value="TODAS">TODAS</option>
                                        <option>CC1</option>
                                        <option>CC2</option>
                                        <option>EP3</option>
                                        <option>EP4</option>
                                        <option>EP5</option>
                                        <option>EP6</option>
                                        <option>EP7</option>
                                        <option>EP8</option>
                                        <option>EP9</option>
                                        <option>JEFATURA</option>
                                        <option>EDIFICIO LAPRIDA</option>
                                        <option>ESCUELA DE CADETES</option>
                                        <option>ESCUELA DE SUBOFICIALES</option>
                                    </select>
                                </div>
                                <button onclick="filtrarPresentarse()" class="bg-blue-600 text-white py-2.5 px-5 rounded-lg hover:bg-blue-700 transition duration-300">Filtrar</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                             <div class="mb-4">
                                <input type="text" id="search-presentarse" onkeyup="filterTable('presentarse-table')" placeholder="Buscar por Afiliado, Empleado o Unidad..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                             </div>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Afiliado</th>
                                            <th scope="col" class="px-6 py-3">Empleado</th>
                                            <th scope="col" class="px-6 py-3">Dep.</th>
                                            <th scope="col" class="px-6 py-3">Unidad</th>
                                            <th scope="col" class="px-6 py-3">Fin Licencia</th>
                                            <th scope="col" class="px-6 py-3">Debe Presentarse</th>
                                            <th scope="col" class="px-6 py-3">Se Presentó</th>
                                            <th scope="col" class="px-6 py-3">Se Comunicó</th>
                                            <th scope="col" class="px-6 py-3">Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="presentarse-table">
                                       <tr><td colspan="9" class="text-center p-4">Seleccione una fecha y unidad para buscar.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="presentarse-table-pagination" class="pagination-controls mt-4"></div>
                        </div>
                    </div>

                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="aviso-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print z-40">
        <!-- Contenido del modal de aviso -->
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-8 max-h-[95vh] overflow-y-auto">
            <h2 id="aviso-modal-title" class="text-2xl font-bold mb-6"></h2>
            <form id="aviso-form">
                <input type="hidden" id="aviso-mode" value="create">
                <input type="hidden" id="aviso-id">
                <input type="hidden" id="incidente-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="md:col-span-2">
                        <label for="empleado-afiliado" class="block mb-2 text-sm font-medium text-gray-900">Número de Afiliado (Matrícula)</label>
                        <input type="text" id="empleado-afiliado" onblur="precargarDatosAfiliado()" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Buscar por Matrícula" required>
                    </div>
                     <div>
                        <label for="empleado-grado" class="block mb-2 text-sm font-medium text-gray-900">Grado (Jerarquía)</label>
                        <input type="text" id="empleado-grado" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Ej: Sargento" required>
                    </div>
                     <div>
                        <label for="empleado-funcion" class="block mb-2 text-sm font-medium text-gray-900">Función</label>
                        <input type="text" id="empleado-funcion" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Función del agente" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="empleado-nombre" class="block mb-2 text-sm font-medium text-gray-900">Apellido y Nombres</label>
                        <input type="text" id="empleado-nombre" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Ej: Pérez, Juan" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="empleado-direccion" class="block mb-2 text-sm font-medium text-gray-900">Dirección (Dom_actua)</label>
                        <input type="text" id="empleado-direccion" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Ej: Av. Siempre Viva 123" required>
                    </div>
                    <div>
                        <label for="solicitud-fecha" class="block mb-2 text-sm font-medium text-gray-900">Fecha de Solicitud</label>
                        <input type="date" id="solicitud-fecha" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="solicitud-hora" class="block mb-2 text-sm font-medium text-gray-900">Hora de Solicitud</label>
                        <input type="time" id="solicitud-hora" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                     <div>
                        <label for="empleado-unidad" class="block mb-2 text-sm font-medium text-gray-900">Unidad</label>
                        <select id="empleado-unidad" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required></select>
                    </div>
                    <div>
                        <label for="solicitud-tipo" class="block mb-2 text-sm font-medium text-gray-900">Tipo</label>
                        <select id="solicitud-tipo" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                           <option>A DOMICILIO</option>
                           <option>CONSULTORIO</option>
                        </select>
                    </div>
                     <div class="md:col-span-2">
                        <label for="solicitud-motivo" class="block mb-2 text-sm font-medium text-gray-900">Motivo de la Solicitud</label>
                        <select id="solicitud-motivo" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                           <option value="" disabled selected>-- Seleccione un motivo --</option>
                           <option value="ENFERMEDAD DEL AGENTE">ENFERMEDAD DEL AGENTE</option>
                           <option value="PERSONA A CARGO / FAMILIAR">PERSONA A CARGO / FAMILIAR</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="solicitud-observaciones" class="block mb-2 text-sm font-medium text-gray-900">Observaciones (del aviso)</label>
                        <textarea id="solicitud-observaciones" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Añadir observaciones sobre la solicitud..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 pt-6 mt-4 border-t">
                    <button type="button" onclick="closeAvisoModal()" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                    <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Guardar Aviso</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="avisos-fecha-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-5xl p-8 max-h-[95vh] flex flex-col">
             <h2 class="text-2xl font-bold mb-6">Buscar Avisos por Período</h2>
             <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-4">
                 <div>
                     <label for="search-fecha-aviso-desde" class="block mb-2 text-sm font-medium text-gray-900">Fecha Desde</label>
                     <input type="date" id="search-fecha-aviso-desde" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                 </div>
                 <div>
                    <label for="search-fecha-aviso-hasta" class="block mb-2 text-sm font-medium text-gray-900">Fecha Hasta</label>
                    <input type="date" id="search-fecha-aviso-hasta" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                <div>
                    <label for="search-encuadra-aviso" class="block mb-2 text-sm font-medium text-gray-900">Encuadre</label>
                    <select id="search-encuadra-aviso" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option value="TODOS">Todos</option>
                        <option value="ART. 14">ART. 14</option>
                        <option value="ART. 19">ART. 19</option>
                        <option value="ART. 20">ART. 20</option>
                        <option value="ART. 29">ART. 29</option>
                        <option value="ART. 30">ART. 30</option>
                        <option value="ART. 30 BIS">ART. 30 BIS</option>
                        <option value="SIN JUSTIFICAR">SIN JUSTIFICAR</option>
                    </select>
                </div>
                 <button onclick="searchAvisosPorFecha()" class="bg-blue-600 text-white py-2.5 px-6 rounded-lg hover:bg-blue-700 transition">Buscar</button>
             </div>
             <div id="avisos-fecha-results" class="flex-grow overflow-y-auto border-t pt-4">
                <p class="text-center text-gray-500">Seleccione un período de fechas para ver los avisos.</p>
                 <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-4 py-2">Afiliado</th>
                                <th class="px-4 py-2">Empleado</th>
                                <th class="px-4 py-2">Dep.</th>
                                <th class="px-4 py-2">Unidad</th>
                                <th class="px-4 py-2">Fecha</th>
                                <th class="px-4 py-2">Estado</th>
                                <th class="px-4 py-2">Encuadre</th>
                            </tr>
                        </thead>
                        <tbody id="avisos-fecha-table">
                            <!-- Contenido se generará aquí -->
                        </tbody>
                    </table>
                </div>
             </div>
             <div id="avisos-fecha-table-pagination" class="pagination-controls mt-4 flex-shrink-0"></div>
             <div class="flex justify-between items-center mt-6 flex-shrink-0">
                <button type="button" onclick="exportAvisosToXLS()" class="py-2 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center space-x-2">
                    <i class="fas fa-file-excel"></i>
                    <span>Exportar a XLS</span>
                </button>
                <button type="button" onclick="closeAvisosFechaModal()" class="py-2 px-6 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Cerrar</button>
            </div>
        </div>
    </div>
    
    <div id="usuario-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-8 max-h-[95vh] overflow-y-auto">
             <h2 id="usuario-modal-title" class="text-2xl font-bold mb-6"></h2>
             <form id="usuario-form">
                <input type="hidden" id="usuario-mode">
                <div class="space-y-4">
                    <div>
                        <label for="usuario-afiliado" class="block mb-2 text-sm font-medium text-gray-900">Número de Afiliado</label>
                        <input type="text" id="usuario-afiliado" onblur="precargarDatosUsuario()" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="usuario-nombre" class="block mb-2 text-sm font-medium text-gray-900">Nombre Completo</label>
                        <input type="text" id="usuario-nombre" class="bg-gray-200 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" readonly>
                    </div>
                    <div>
                        <label for="usuario-password" class="block mb-2 text-sm font-medium text-gray-900">Contraseña</label>
                        <input type="password" id="usuario-password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <p class="text-xs text-gray-500 mt-1">Dejar en blanco para no cambiarla al editar.</p>
                    </div>
                     <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900">Roles</label>
                        <div id="usuario-roles-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-4 border rounded-lg">
                            <!-- Role checkboxes will be generated here -->
                        </div>
                    </div>
                    <div id="usuario-unidades-container" class="hidden">
                        <label class="block mb-2 text-sm font-medium text-gray-900">Establecimientos Permitidos</label>
                        <div id="usuario-unidades-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-4 border rounded-lg">
                            <!-- Checkboxes se generarán dinámicamente -->
                        </div>
                    </div>
                </div>
                 <div class="flex justify-end space-x-4 pt-6 mt-4 border-t">
                    <button type="button" onclick="closeUsuarioModal()" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                    <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Guardar</button>
                </div>
             </form>
        </div>
    </div>
    
    <div id="change-password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 no-print z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
             <h2 class="text-2xl font-bold mb-6">Cambiar Contraseña</h2>
             <form id="change-password-form">
                <div class="space-y-4">
                    <div>
                        <label for="current-password" class="block mb-2 text-sm font-medium text-gray-900">Contraseña Actual</label>
                        <input type="password" id="current-password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="new-password" class="block mb-2 text-sm font-medium text-gray-900">Nueva Contraseña</label>
                        <input type="password" id="new-password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="confirm-password" class="block mb-2 text-sm font-medium text-gray-900">Confirmar Nueva Contraseña</label>
                        <input type="password" id="confirm-password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <p id="password-error" class="text-red-500 text-sm hidden"></p>
                </div>
                 <div class="flex justify-end space-x-4 pt-6 mt-4 border-t">
                    <button type="button" onclick="closeChangePasswordModal()" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                    <button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Guardar Cambios</button>
                </div>
             </form>
        </div>
    </div>


    <!-- Scripts de Firebase -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, onSnapshot, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKLAIAtWhsV0CfWVv5ntcpx2Sj1e2_XLA",
            authDomain: "reconocimientosspc.firebaseapp.com",
            projectId: "reconocimientosspc",
            storageBucket: "reconocimientosspc.appspot.com",
            messagingSenderId: "500258238765",
            appId: "1:500258238765:web:d48fbe6c10818d0def23a4",
            measurementId: "G-X33KN1HCS8"
        };
        
        let db;
        try {
            if (!firebaseConfig.projectId) throw new Error("Configuración de Firebase no proporcionada.");
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (error) {
            console.error(error.message);
            document.getElementById('login-screen').innerHTML = `<div class="text-red-500 p-4">Error: ${error.message}</div>`;
        }

        // --- ESTADO GLOBAL ---
        let currentUser = null;
        let selectedRole = null;
        let currentUserUnidad = null;
        let currentAvisosSearchResult = []; // Se mantiene para la exportación
        const unidadesDisponibles = ['TODAS', 'CC1', 'CC2', 'EP3', 'EP4', 'EP5', 'EP6', 'EP7', 'EP8', 'EP9', 'JEFATURA', 'EDIFICIO LAPRIDA', 'ESCUELA DE CADETES', 'ESCUELA DE SUBOFICIALES'];
        let sortState = {}; // Para rastrear el estado de ordenamiento de las tablas
        let isSyncingProfesionales = false; // Declarada en el ámbito global

        // --- INICIO: NUEVOS ESTADOS GLOBALES PARA PAGINACIÓN ---
        let paginationState = {}; // { tableId: { currentPage: 1, rowsPerPage: 100 } }
        let allDataCache = {};   // { tableId: [...] }
        const ROWS_PER_PAGE = 100;
        // --- FIN: NUEVOS ESTADOS GLOBALES ---

        // Listeners
        let unsubscribeAvisosPendientes = null;
        let unsubscribeAvisosVisados = null;
        let unsubscribePendientes = null;
        let unsubscribeCompletados = null;
        let unsubscribeUsers = null;
        let unsubscribeRegistro = null;
        let unsubscribeProfesionales = null;

        // --- HELPER FUNCTIONS ---
        function formatDate(dateString) {
            if (!dateString || !dateString.includes('-')) return dateString || 'N/A';
            const parts = dateString.split('-');
            if (parts.length !== 3) return dateString;
            const [year, month, day] = parts;
            return `${day}/${month}/${year}`;
        }
        
        // --- LOGGING DE ACTIVIDAD ---
        async function logActivity(action, description) {
            if (!currentUser) return; 
            try {
                await addDoc(collection(db, "activityLog"), {
                    timestamp: new Date(),
                    userAfiliado: currentUser.afiliado,
                    userName: currentUser.nombreCompleto,
                    userRole: selectedRole,
                    action: action,
                    description: description
                });
            } catch (error) {
                console.error("Error logging activity: ", error);
            }
        }

        function getUnidadTag(unidad) {
            if (!unidad) return '';
            const abreviaturas = {
                'JEFATURA': 'JEF.',
                'EDIFICIO LAPRIDA': 'LAPRID.',
                'ESCUELA DE CADETES': 'ESC. CAD.',
                'ESCUELA DE SUBOFICIALES': 'ESC. SUBOF'
            };
            const colores = {
                'CC1': 'green', 'CC2': 'red', 'EP3': 'green', 'EP4': 'green', 'EP5': 'red',
                'EP6': 'red', 'EP7': 'red', 'EP8': 'red', 'EP9': 'green', 'JEFATURA': 'green',
                'EDIFICIO LAPRIDA': 'green', 'ESCUELA DE CADETES': 'green', 'ESCUELA DE SUBOFICIALES': 'green'
            };
            const color = colores[unidad] || 'gray';
            const colorClasses = {
                green: 'bg-green-100 text-green-800',
                red: 'bg-red-100 text-red-800',
                gray: 'bg-gray-100 text-gray-800'
            }[color];
            const text = abreviaturas[unidad] || unidad;
            return `<span class="px-2 py-1 text-xs font-medium rounded-full ${colorClasses}">${text}</span>`;
        }
        
        // --- LÓGICA DE LOGIN Y AUTENTICACIÓN ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const afiliado = document.getElementById('login-afiliado').value;
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('login-error');
            errorP.classList.add('hidden');

            if (afiliado === '136219951' && password === 'Marquitos123') {
                currentUser = { afiliado: '136219951', nombreCompleto: 'Superusuario', roles: ['administrador', 'personal', 'reconocimientos'], unidades: unidadesDisponibles };
                showRoleSelection(currentUser.roles);
                return;
            }

            const userDocRef = doc(db, "users", afiliado);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists() && userDocSnap.data().password === password) {
                currentUser = userDocSnap.data();
                const userRoles = Array.isArray(currentUser.roles) ? currentUser.roles : (currentUser.role ? [currentUser.role] : []);
                
                if (userRoles.length > 1) {
                    showRoleSelection(userRoles);
                } else if (userRoles.length === 1) {
                    selectRole(userRoles[0]);
                } else {
                    errorP.textContent = 'El usuario no tiene roles asignados.'; errorP.classList.remove('hidden');
                }
            } else {
                errorP.textContent = 'Afiliado o contraseña incorrectos.'; errorP.classList.remove('hidden');
            }
        });
        
        function showRoleSelection(roles) {
            const buttonsContainer = document.getElementById('role-buttons-container');
            buttonsContainer.innerHTML = '';
            roles.forEach(role => {
                buttonsContainer.innerHTML += `<button onclick="selectRole('${role}')" class="w-full bg-amber-500 text-white py-3 px-4 rounded-lg hover:bg-amber-600 transition duration-300 capitalize">${role.replace('reconocimientos', 'Reconocimientos Médicos')}</button>`;
            });
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('role-selection-screen').classList.remove('hidden');
            document.getElementById('role-selection-screen').classList.add('flex');
        }

        async function selectRole(role) {
            selectedRole = role;
            await logActivity('LOGIN', `Inició sesión con el rol: ${role}.`);
            document.getElementById('role-selection-screen').classList.add('hidden');
            document.getElementById('role-selection-screen').classList.remove('flex');
            if (selectedRole === 'personal') {
                if (currentUser.unidades && currentUser.unidades.length > 0) {
                     showUnidadSelection(currentUser.unidades);
                } else {
                     logout(); alert('No tiene unidades asignadas para el rol de Personal.');
                }
            } else {
                showPortal();
            }
        }

        function showUnidadSelection(unidades) {
            const select = document.getElementById('login-unidad-select');
            select.innerHTML = '<option value="" disabled selected>-- Elija una unidad --</option>';
            unidades.forEach(u => { select.innerHTML += `<option value="${u}">${u}</option>`; });
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('role-selection-screen').classList.add('hidden');
            document.getElementById('unidad-selection-screen').classList.remove('hidden');
            document.getElementById('unidad-selection-screen').classList.add('flex');
        }

        async function continueLoginPersonal(){
            const selectedUnidad = document.getElementById('login-unidad-select').value;
            if(!selectedUnidad) { alert('Por favor, seleccione una unidad.'); return; }
            currentUserUnidad = selectedUnidad;
            await logActivity('SELECT_UNIDAD', `Seleccionó la unidad: ${selectedUnidad}.`);
            showPortal();
        }

        function showPortal() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('role-selection-screen').classList.add('hidden');
            document.getElementById('unidad-selection-screen').classList.add('hidden');
            document.getElementById('main-portal').classList.remove('hidden');
            setupPortalForRole();
        }

        function goBackToLogin(){
            document.getElementById('unidad-selection-screen').classList.add('hidden');
            document.getElementById('role-selection-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        async function logout() {
            await logActivity('LOGOUT', 'Cerró sesión.');
            currentUser = null; selectedRole = null; currentUserUnidad = null;
            document.getElementById('main-portal').classList.add('hidden');
            goBackToLogin();
            document.getElementById('login-form').reset();
        }
        
        function goBackToRoleSelection() {
            document.getElementById('main-portal').classList.add('hidden');
            selectedRole = null; currentUserUnidad = null;
            showRoleSelection(currentUser.roles);
        }

        function setupPortalForRole() {
            document.getElementById('user-role').textContent = `${currentUser.nombreCompleto} (${selectedRole})`;
            ['admin-links', 'personal-links', 'reconocimientos-links'].forEach(id => { document.getElementById(id).classList.add('hidden'); });
            
            const userRoles = Array.isArray(currentUser.roles) ? currentUser.roles : [];
            document.getElementById('change-role-btn').classList.toggle('hidden', userRoles.length <= 1);

            if (selectedRole === 'administrador') {
                document.getElementById('admin-links').classList.remove('hidden');
            } else if (selectedRole === 'personal') {
                document.getElementById('personal-links').classList.remove('hidden');
            } else if (selectedRole === 'reconocimientos') {
                document.getElementById('reconocimientos-links').classList.remove('hidden');
            }
            showView('inicio');
        }

        function showView(viewId) {
            if (unsubscribeAvisosPendientes) unsubscribeAvisosPendientes();
            if (unsubscribeAvisosVisados) unsubscribeAvisosVisados();
            if (unsubscribePendientes) unsubscribePendientes();
            if (unsubscribeCompletados) unsubscribeCompletados();
            if (unsubscribeUsers) unsubscribeUsers();
            if (unsubscribeRegistro) unsubscribeRegistro();
            if (unsubscribeProfesionales) unsubscribeProfesionales();

            document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
            document.getElementById(`${viewId}-view`).classList.remove('hidden');
            
            const titles = {
                'inicio': 'Inicio', 'usuarios': 'Gestión de Usuarios', 'importar': 'Importar Personal',
                'avisos-pendientes': 'Avisos de Carpetas Pendientes', 'avisos-visados': 'Avisos de Carpetas Visados',
                'pendientes': 'Incidentes Pendientes', 'completados': 'Incidentes Completados',
                'form': 'Formulario de Reconocimiento Médico', 'presentarse': 'Consultar Personal a Presentarse',
                'evaluados': 'Consultar Evaluados por Fecha', 'antecedentes': 'Buscar Antecedentes', 'registro': 'Registro de Actividad',
                'profesionales': 'Gestión de Profesionales'
            };
            // Resetea el título principal. El listener de snapshot lo actualizará con el conteo.
            document.getElementById('view-title').textContent = titles[viewId] || 'Bienvenido';
            
            // Inicializa el estado de paginación para la vista
            const tableId = getTableIdForView(viewId);
            if (tableId) {
                paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE };
                allDataCache[tableId] = []; // Limpia el caché al cambiar de vista
                // Limpia la tabla y la paginación al cambiar de vista
                const tableBody = document.getElementById(tableId);
                const paginationControls = document.getElementById(`${tableId}-pagination`);
                if(tableBody) tableBody.innerHTML = '';
                if(paginationControls) paginationControls.innerHTML = '';
            }

            if (viewId === 'inicio') renderInicioView();
            if (viewId === 'avisos-pendientes') listenToAvisos('Pendiente');
            if (viewId === 'avisos-visados') listenToAvisos('Completado');
            if (viewId === 'pendientes') listenToIncidentes('Pendiente');
            if (viewId === 'completados') listenToIncidentes('Completado');
            if (viewId === 'usuarios') listenToUsers();
            if (viewId === 'registro') listenToActivityLog();
            if (viewId === 'profesionales') {
                synchronizeAndListenProfesionales(); // Nueva función de carga
            }
            
            if (viewId === 'presentarse') {
                const unidadSelect = document.getElementById('unidad-presentarse');
                unidadSelect.innerHTML = unidadesDisponibles.map(u => `<option value="${u}">${u}</option>`).join('');
                unidadSelect.disabled = selectedRole === 'personal';
                if (selectedRole === 'personal') unidadSelect.value = currentUserUnidad;
                document.getElementById('presentarse-table').innerHTML = '<tr><td colspan="9" class="text-center p-4">Seleccione una fecha y unidad para buscar.</td></tr>';
            }
        }
        
        // --- INICIO: NUEVA FUNCIÓN ---
        // Mapea un viewId al tableId principal de esa vista
        function getTableIdForView(viewId) {
            const map = {
                'usuarios': 'usuarios-table',
                'avisos-pendientes': 'avisos-pendientes-table',
                'avisos-visados': 'avisos-visados-table',
                'pendientes': 'pendientes-table',
                'completados': 'completados-table',
                'evaluados': 'evaluados-table',
                'antecedentes': 'antecedentes-table',
                'profesionales': 'profesionales-table',
                'registro': 'registro-table',
                'presentarse': 'presentarse-table'
            };
            return map[viewId] || null;
        }
        // --- FIN: NUEVA FUNCIÓN ---

        function renderInicioView() {
            const container = document.getElementById('inicio-view');
            let content = `<h2 class="text-3xl font-bold mb-6 text-gray-700">Bienvenido, ${currentUser.nombreCompleto}</h2>`;

            function createInfoCard(icon, title, text) {
                return `<div class="bg-white p-6 rounded-2xl shadow-lg flex items-start space-x-4"><div class="bg-blue-100 text-blue-600 p-3 rounded-full flex-shrink-0"><i class="${icon} text-xl w-6 text-center"></i></div><div><h3 class="font-bold text-lg text-gray-800 mb-1">${title}</h3><p class="text-gray-600 text-sm">${text}</p></div></div>`;
            }

            switch(selectedRole) {
                case 'administrador':
                    content += `<p class="text-gray-600 mb-8">Desde este panel de administrador, tiene acceso completo al sistema. A continuación se detallan las secciones disponibles:</p><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                    content += createInfoCard('fas fa-users-cog', 'Gestionar Usuarios', 'Cree, modifique, blanquee contraseñas o elimine cuentas de usuario. Asigne roles y permisos de acceso a las unidades.');
                    content += createInfoCard('fas fa-file-excel', 'Importar Personal', 'Cargue la base de datos completa del personal mediante un archivo Excel para mantener el sistema actualizado.');
                    content += createInfoCard('fas fa-folder-open', 'Avisos Pendientes', 'Visualice y gestione los avisos de ausentismo que aún no han sido evaluados por el personal médico. Puede editar y eliminar avisos desde aquí.');
                    content += createInfoCard('fas fa-folder-check', 'Avisos Visados', 'Consulte el historial de avisos que ya han sido completados y visados por Reconocimientos Médicos.');
                    content += createInfoCard('fas fa-user-md', 'Profesionales', 'Gestione y verifique la lista de profesionales médicos que han sido cargados en las cartas médicas.');
                    content += createInfoCard('fas fa-calendar-check', 'Presentarse a Trabajar', 'Filtre y visualice qué personal debe reintegrarse al servicio en una fecha determinada tras finalizar su licencia.');
                    content += createInfoCard('fas fa-clipboard-list', 'Registro de Actividad', 'Audite todas las acciones importantes realizadas en el sistema: quién hizo qué y cuándo, para un control total.');
                    content += `</div>`;
                    break;
                case 'personal':
                    content += `<p class="text-gray-600 mb-8">Bienvenido al portal de su unidad. Desde aquí podrá gestionar el ausentismo del personal a su cargo:</p><div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;
                    content += createInfoCard('fas fa-folder-open', 'Avisos Pendientes', 'Cree nuevos avisos de ausentismo y edite los existentes mientras se encuentren pendientes de evaluación médica.');
                    content += createInfoCard('fas fa-folder-check', 'Avisos Visados', 'Consulte el historial de avisos de su unidad que ya han sido completados y visados por Reconocimientos Médicos.');
                    content += createInfoCard('fas fa-calendar-check', 'Presentarse a Trabajar', 'Verifique qué agentes de su unidad deben presentarse a trabajar en una fecha específica y registre si se presentaron o comunicaron.');
                    content += `</div>`;
                    break;
                case 'reconocimientos':
                     content += `<p class="text-gray-600 mb-8">Este es su panel de gestión médica. A continuación se detallan sus herramientas de trabajo:</p><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                    content += createInfoCard('fas fa-hourglass-half', 'Pendientes', 'Acceda a la lista de todos los incidentes médicos que requieren su evaluación para determinar la licencia correspondiente.');
                    content += createInfoCard('fas fa-check-double', 'Completados', 'Revise y edite los reconocimientos que ya ha completado. Puede corregir o añadir información si es necesario.');
                    content += createInfoCard('fas fa-history', 'Evaluados por Fecha', 'Busque y filtre todos los reconocimientos médicos que se realizaron en una fecha específica.');
                    content += createInfoCard('fas fa-search-plus', 'Buscar Antecedentes', 'Consulte el historial médico completo de un agente buscando por su número de afiliado o por la matrícula de un profesional tratante.');
                    content += createInfoCard('fas fa-user-md', 'Profesionales', 'Gestione y verifique la lista de profesionales médicos que han sido cargados en las cartas médicas.');
                    content += createInfoCard('fas fa-calendar-check', 'Presentarse a Trabajar', 'Consulte el listado general de personal de todas las unidades que debe reintegrarse al servicio en una fecha determinada.');
                    content += `</div>`;
                    break;
            }
            container.innerHTML = content;
        }

        // --- GESTIÓN DE USUARIOS (ADMIN) ---
        function listenToUsers() {
            const tableId = 'usuarios-table';
            const baseTitle = 'Gestión de Usuarios';
            const viewHeader = document.querySelector('#usuarios-view h2');

            unsubscribeUsers = onSnapshot(collection(db, "users"), (snapshot) => {
                const totalCount = snapshot.size;
                const titleWithCount = `${baseTitle} (${totalCount})`;
                viewHeader.textContent = titleWithCount;
                if (!document.getElementById('usuarios-view').classList.contains('hidden')) {
                    document.getElementById('view-title').textContent = titleWithCount;
                }

                allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!paginationState[tableId]) {
                    paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE };
                }
                renderPaginatedTable(tableId);
            });
        }
        
        async function openUsuarioModal(afiliado = null) {
            const form = document.getElementById('usuario-form');
            form.reset();
            document.getElementById('usuario-unidades-container').classList.add('hidden');
            const mode = afiliado ? 'edit' : 'create';
            document.getElementById('usuario-mode').value = mode;
            document.getElementById('usuario-modal-title').textContent = mode === 'create' ? 'Crear Nuevo Usuario' : 'Editar Usuario';
            document.getElementById('usuario-afiliado').readOnly = (mode === 'edit');
            document.getElementById('usuario-password').required = (mode === 'create');
            
            const rolesContainer = document.getElementById('usuario-roles-checkboxes');
            rolesContainer.innerHTML = ['administrador', 'personal', 'reconocimientos'].map(role => `<label class="flex items-center space-x-2"><input type="checkbox" name="roles" value="${role}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span class="capitalize">${role.replace('reconocimientos', 'Rec. Médicos')}</span></label>`).join('');
            rolesContainer.querySelectorAll('input[name="roles"]').forEach(cb => cb.addEventListener('change', () => document.getElementById('usuario-unidades-container').classList.toggle('hidden', !rolesContainer.querySelector('input[value="personal"]').checked)));
            
            const unidadesContainer = document.getElementById('usuario-unidades-checkboxes');
            unidadesContainer.innerHTML = unidadesDisponibles.filter(u => u !== 'TODAS').map(u => `<label class="flex items-center space-x-2"><input type="checkbox" name="unidades" value="${u}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span>${u}</span></label>`).join('');

            if (mode === 'edit') {
                const userDoc = await getDoc(doc(db, "users", afiliado));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    document.getElementById('usuario-afiliado').value = data.afiliado; document.getElementById('usuario-nombre').value = data.nombreCompleto;
                    const userRoles = Array.isArray(data.roles) ? data.roles : (data.role ? [data.role] : []);
                    form.querySelectorAll('input[name="roles"]').forEach(check => { if (userRoles.includes(check.value)) check.checked = true; });
                    const personalIsChecked = userRoles.includes('personal');
                    document.getElementById('usuario-unidades-container').classList.toggle('hidden', !personalIsChecked);
                    if (personalIsChecked && data.unidades) { form.querySelectorAll('input[name="unidades"]').forEach(check => { if (data.unidades.includes(check.value)) check.checked = true; }); }
                }
            }
            document.getElementById('usuario-modal').classList.add('flex'); document.getElementById('usuario-modal').classList.remove('hidden');
        }
        
        function closeUsuarioModal() { document.getElementById('usuario-modal').classList.add('hidden'); document.getElementById('usuario-modal').classList.remove('flex'); }
        async function precargarDatosUsuario() { const afiliado = document.getElementById('usuario-afiliado').value; if (document.getElementById('usuario-mode').value === 'edit' || !afiliado) return; const personalDoc = await getDoc(doc(db, "personal", afiliado)); document.getElementById('usuario-nombre').value = personalDoc.exists() ? personalDoc.data().nombreCompleto : 'Afiliado no encontrado.'; }
        
        document.getElementById('usuario-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const mode = document.getElementById('usuario-mode').value, afiliado = document.getElementById('usuario-afiliado').value, nombre = document.getElementById('usuario-nombre').value, password = document.getElementById('usuario-password').value;
            const roles = Array.from(document.querySelectorAll('input[name="roles"]:checked')).map(cb => cb.value);
            if (roles.length === 0 || nombre === 'Afiliado no encontrado.') { alert('Complete todos los campos correctamente.'); return; }
            const userData = { afiliado, nombreCompleto: nombre, roles };
            if (password) userData.password = password;
            if (roles.includes('personal')) { userData.unidades = Array.from(document.querySelectorAll('input[name="unidades"]:checked')).map(cb => cb.value); if (userData.unidades.length === 0) { alert('Seleccione al menos un establecimiento para Personal.'); return; } } else { userData.unidades = []; }
            try { await setDoc(doc(db, "users", afiliado), userData, { merge: true }); await logActivity(mode === 'create' ? 'CREATE_USER' : 'UPDATE_USER', `Usuario: ${nombre} (${afiliado})`); closeUsuarioModal(); } catch(error) { console.error("Error guardando usuario: ", error); }
        });

        async function resetPassword(afiliado) { const newPassword = prompt(`Ingrese la nueva contraseña para el afiliado ${afiliado}:`); if (newPassword) { await updateDoc(doc(db, "users", afiliado), { password: newPassword.trim() }); await logActivity('RESET_PASSWORD', `Contraseña blanqueada para usuario ${afiliado}.`); alert("Contraseña actualizada."); } }
        async function deleteUser(afiliado) { if (confirm(`¿Seguro que desea eliminar al usuario ${afiliado}?`)) { await deleteDoc(doc(db, "users", afiliado)); await logActivity('DELETE_USER', `Usuario eliminado: ${afiliado}.`); alert("Usuario eliminado."); } }
        
        // --- CAMBIO DE CONTRASEÑA ---
        function openChangePasswordModal() { if (currentUser.afiliado === '136219951') { alert('La contraseña del Superusuario no se puede modificar.'); return; } document.getElementById('change-password-modal').classList.add('flex'); document.getElementById('change-password-modal').classList.remove('hidden'); }
        function closeChangePasswordModal() { document.getElementById('change-password-form').reset(); document.getElementById('password-error').classList.add('hidden'); document.getElementById('change-password-modal').classList.add('hidden'); document.getElementById('change-password-modal').classList.remove('flex'); }
        document.getElementById('change-password-form').addEventListener('submit', async function(e) { e.preventDefault(); const currentPass = document.getElementById('current-password').value, newPass = document.getElementById('new-password').value, confirmPass = document.getElementById('confirm-password').value, errorP = document.getElementById('password-error'); errorP.classList.add('hidden'); if (newPass !== confirmPass) { errorP.textContent = 'Las contraseñas no coinciden.'; errorP.classList.remove('hidden'); return; } const userDocRef = doc(db, "users", currentUser.afiliado), userDocSnap = await getDoc(userDocRef); if (userDocSnap.exists() && userDocSnap.data().password === currentPass) { await updateDoc(userDocRef, { password: newPass }); await logActivity('CHANGE_PASSWORD', 'Usuario cambió su propia contraseña.'); alert('Contraseña actualizada.'); closeChangePasswordModal(); } else { errorP.textContent = 'Contraseña actual incorrecta.'; errorP.classList.remove('hidden'); } });
        
        // --- IMPORTACIÓN Y AVISOS ---
        async function handleFileUpload() { 
            const fileInput = document.getElementById('excel-file-input'), statusDiv = document.getElementById('import-status'); 
            if (fileInput.files.length === 0) { statusDiv.innerHTML = `<p class="text-red-500">Seleccione un archivo.</p>`; return; } 
            const file = fileInput.files[0], reader = new FileReader(); 
            statusDiv.innerHTML = `<p class="text-blue-500">Procesando...</p>`; 
            reader.onload = async function(e) { 
                try { 
                    const data = new Uint8Array(e.target.result), workbook = XLSX.read(data, {type: 'array'}), ws = workbook.Sheets[workbook.SheetNames[0]], json_data = XLSX.utils.sheet_to_json(ws, {header: 1}); 
                    if (json_data.length < 2) throw new Error("Excel vacío."); 
                    const headers = json_data[0].map(h => String(h).trim()); 
                    if (['Matricula', 'Apellido y Nombre', 'Funcion'].some(rh => !headers.includes(rh))) throw new Error(`Faltan columnas requeridas (Matricula, Apellido y Nombre, Funcion).`); 
                    const batch = writeBatch(db), personalData = json_data.slice(1); 
                    personalData.forEach(row => { 
                        const matricula = String(row[headers.indexOf('Matricula')]).trim(); 
                        if (matricula) { 
                            const record = { 
                                afiliado: matricula, 
                                nombreCompleto: row[headers.indexOf('Apellido y Nombre')], 
                                grado: row[headers.indexOf('Jerarquia')] || '', 
                                direccion: row[headers.indexOf('Dom_actua')] || '',
                                funcion: row[headers.indexOf('Funcion')] || '' // Asegura que el campo funcion exista
                            }; 
                            // Utiliza merge: true para actualizar sin borrar otros campos
                            batch.set(doc(db, "personal", matricula), record, { merge: true }); 
                        } 
                    }); 
                    await batch.commit(); 
                    await logActivity('IMPORT_PERSONNEL', `Importó/Actualizó ${personalData.length} registros.`); 
                    statusDiv.innerHTML = `<p class="text-green-500">Éxito: ${personalData.length} registros procesados (nuevos o actualizados).</p>`; 
                } catch (error) { 
                    statusDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`; 
                } 
            }; 
            reader.readAsArrayBuffer(file); 
        }
        async function precargarDatosAfiliado() { 
            const afiliadoNumero = document.getElementById('empleado-afiliado').value.trim(); 
            if (!afiliadoNumero) return; 
            const docSnap = await getDoc(doc(db, "personal", afiliadoNumero)); 
            if (docSnap.exists()) { 
                const e = docSnap.data(); 
                document.getElementById('empleado-nombre').value = e.nombreCompleto || ''; 
                document.getElementById('empleado-grado').value = e.grado || ''; 
                document.getElementById('empleado-direccion').value = e.direccion || ''; 
                document.getElementById('empleado-funcion').value = e.funcion || ''; // Precarga editable
            } else {
                 document.getElementById('empleado-nombre').value = ''; 
                 document.getElementById('empleado-grado').value = ''; 
                 document.getElementById('empleado-direccion').value = ''; 
                 document.getElementById('empleado-funcion').value = ''; // Limpia si no existe
            }
        }
        
        // --- GESTIÓN DE AVISOS (PERSONAL/ADMIN) ---
        function listenToAvisos(status) {
            const isPending = status === 'Pendiente';
            const tableId = isPending ? 'avisos-pendientes-table' : 'avisos-visados-table';
            const viewId = isPending ? 'avisos-pendientes-view' : 'avisos-visados-view';
            const viewHeader = document.querySelector(`#${viewId} h2`);
            const baseTitle = isPending ? 'Avisos de Carpetas Pendientes' : 'Avisos de Carpetas Visados';

            let baseConditions = [where("status", "==", status)];
            if (selectedRole === 'personal' && currentUserUnidad !== 'TODAS') {
                baseConditions.push(where("unidad", "==", currentUserUnidad));
            }
            
            if (status === 'Completado') {
                const encuadraFiltro = document.getElementById('filtro-encuadra').value;
                if (encuadraFiltro && encuadraFiltro !== 'TODOS') {
                    baseConditions.push(where("encuadra", "==", encuadraFiltro));
                }
            }
            
            const q = query(collection(db, "avisos"), ...baseConditions);

            const listener = onSnapshot(q, (snapshot) => {
                const totalCount = snapshot.size;
                const titleWithCount = `${baseTitle} (${totalCount})`;
                viewHeader.textContent = titleWithCount;
                if (!document.getElementById(viewId).classList.contains('hidden')) {
                    document.getElementById('view-title').textContent = titleWithCount;
                }

                allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!paginationState[tableId]) {
                    paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE };
                }
                renderPaginatedTable(tableId);
            });

            if(isPending) unsubscribeAvisosPendientes = listener; else unsubscribeAvisosVisados = listener;
        }
        
        async function openAvisoModal(avisoId = null) {
            const form = document.getElementById('aviso-form');
            form.reset();
            const mode = avisoId ? 'edit' : 'create';
            document.getElementById('aviso-modal-title').textContent = mode === 'create' ? 'Agregar Aviso' : 'Editar Aviso';
            document.getElementById('aviso-mode').value = mode;
            document.getElementById('aviso-id').value = avisoId || '';
            document.getElementById('incidente-id').value = '';

            const canEditUnidad = selectedRole === 'administrador' || (selectedRole === 'personal' && currentUserUnidad === 'TODAS');
            const unidadSelect = document.getElementById('empleado-unidad');
            unidadSelect.innerHTML = '';
            unidadesDisponibles.filter(u => u !== 'TODAS').forEach(u => {
                const option = document.createElement('option');
                option.value = u;
                option.textContent = u;
                unidadSelect.appendChild(option);
            });

            if (mode === 'edit') {
                const q = query(collection(db, "incidentes"), where("avisoId", "==", avisoId));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    const incidenteDoc = snap.docs[0],
                        incidente = incidenteDoc.data();
                    document.getElementById('incidente-id').value = incidenteDoc.id;
                    document.getElementById('empleado-afiliado').value = incidente.afiliado;
                    document.getElementById('empleado-grado').value = incidente.grado;
                    document.getElementById('empleado-funcion').value = incidente.funcion || ''; // Precarga campo funcion
                    document.getElementById('empleado-nombre').value = incidente.empleado;
                    document.getElementById('empleado-direccion').value = incidente.direccion;
                    document.getElementById('solicitud-fecha').value = incidente.solicitudFecha;
                    document.getElementById('solicitud-hora').value = incidente.solicitudHora;
                    unidadSelect.value = incidente.unidad;
                    document.getElementById('solicitud-tipo').value = incidente.solicitudTipo;
                    document.getElementById('solicitud-motivo').value = incidente.motivo;
                    document.getElementById('solicitud-observaciones').value = incidente.observacionesAviso;
                }
            } else { // create mode
                if (canEditUnidad) {
                    unidadSelect.insertAdjacentHTML('afterbegin', '<option value="" disabled selected>-- Seleccione una unidad --</option>');
                    unidadSelect.value = '';
                } else {
                    unidadSelect.value = currentUserUnidad;
                }
            }

            unidadSelect.disabled = !canEditUnidad;
            unidadSelect.classList.toggle('bg-gray-200', !canEditUnidad);
            unidadSelect.classList.toggle('bg-gray-50', canEditUnidad);

            document.getElementById('aviso-modal').classList.add('flex');
            document.getElementById('aviso-modal').classList.remove('hidden');
        }
        function closeAvisoModal() { document.getElementById('aviso-modal').classList.add('hidden'); document.getElementById('aviso-modal').classList.remove('flex'); document.getElementById('aviso-form').reset(); }
        
        document.getElementById('aviso-form').addEventListener('submit', async function(e) { 
            e.preventDefault(); 
            if (!document.getElementById('empleado-unidad').value) {
                alert("Debe seleccionar una unidad.");
                return;
            }
            const mode = document.getElementById('aviso-mode').value, avisoId = document.getElementById('aviso-id').value, incidenteId = document.getElementById('incidente-id').value; 
            const avisoData = { afiliado: document.getElementById('empleado-afiliado').value, empleado: document.getElementById('empleado-nombre').value, fecha: document.getElementById('solicitud-fecha').value, unidad: document.getElementById('empleado-unidad').value }; 
            // Incluir el campo funcion al guardar/actualizar
            const incidenteData = { empleado: avisoData.empleado, afiliado: avisoData.afiliado, grado: document.getElementById('empleado-grado').value, funcion: document.getElementById('empleado-funcion').value, direccion: document.getElementById('empleado-direccion').value, solicitudFecha: document.getElementById('solicitud-fecha').value, solicitudHora: document.getElementById('solicitud-hora').value, solicitudTipo: document.getElementById('solicitud-tipo').value, motivo: document.getElementById('solicitud-motivo').value, observacionesAviso: document.getElementById('solicitud-observaciones').value, unidad: avisoData.unidad }; 
            try { if (mode === 'edit') { await updateDoc(doc(db, "avisos", avisoId), avisoData); await updateDoc(doc(db, "incidentes", incidenteId), incidenteData); await logActivity('UPDATE_AVISO', `Aviso para ${avisoData.empleado}`); } else { avisoData.status = 'Pendiente'; const avisoDocRef = await addDoc(collection(db, "avisos"), avisoData); incidenteData.avisoId = avisoDocRef.id; incidenteData.estado = 'Pendiente'; incidenteData.reconocimiento = null; incidenteData.asistencia = { sePresento: false, seComunico: false, observaciones: '' }; const incidenteDocRef = await addDoc(collection(db, "incidentes"), incidenteData); await updateDoc(incidenteDocRef, { id: incidenteDocRef.id }); await logActivity('CREATE_AVISO', `Aviso para ${avisoData.empleado}`); } closeAvisoModal(); } catch (error) { console.error(error); } });
        async function deleteAviso(avisoId) { if (confirm('¿Eliminar este aviso y su incidente asociado?')) { try { const q = query(collection(db, "incidentes"), where("avisoId", "==", avisoId)), snap = await getDocs(q), batch = writeBatch(db); snap.forEach(d => batch.delete(d.ref)); batch.delete(doc(db, "avisos", avisoId)); await batch.commit(); await logActivity('DELETE_AVISO', `Aviso ID: ${avisoId}`); alert('Aviso eliminado.'); } catch (error) { console.error(error); } } }
        
        // --- GESTIÓN DE INCIDENTES ---
        function listenToIncidentes(status) {
            const isPending = status === 'Pendiente';
            const tableId = isPending ? 'pendientes-table' : 'completados-table';
            const viewId = isPending ? 'pendientes-view' : 'completados-view';
            const viewHeader = document.querySelector(`#${viewId} h2`);
            const baseTitle = isPending ? 'Incidentes Pendientes' : 'Incidentes Completados';

            const q = query(collection(db, "incidentes"), where("estado", "==", status));
            
            const listener = onSnapshot(q, (snapshot) => {
                const totalCount = snapshot.size;
                const titleWithCount = `${baseTitle} (${totalCount})`;
                viewHeader.textContent = titleWithCount;
                if (!document.getElementById(viewId).classList.contains('hidden')) {
                    document.getElementById('view-title').textContent = titleWithCount;
                }

                allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!paginationState[tableId]) {
                    paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE };
                }
                renderPaginatedTable(tableId);
            });

            if (isPending) unsubscribePendientes = listener; else unsubscribeCompletados = listener;
        }
        
        async function openFormulario(incidenteId, originView, isReadOnly = false) {
            const docRef = doc(db, "incidentes", incidenteId);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) {
                alert("Incidente no encontrado.");
                return;
            }
            const incidente = docSnap.data();
            const formContainer = document.getElementById('form-view');
            const isEditable = (selectedRole === 'reconocimientos' || selectedRole === 'administrador') && !isReadOnly;
            const isCompleted = incidente.estado === 'Completado';

            formContainer.innerHTML = `
                <div class="flex justify-end mb-4 space-x-2 no-print">
                    <button onclick="window.print()" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600"><i class="fas fa-print mr-2"></i>Imprimir</button>
                    <button onclick="showView('${originView}')" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">Volver</button>
                </div>
                <div id="printable-form" class="bg-white p-4 sm:p-6 border-2 border-black">
                    <form id="reconocimiento-form" data-incidente-id="${incidenteId}" data-aviso-id="${incidente.avisoId}">
                        <div class="flex items-center justify-between mb-2">
                            <img src="https://raw.githubusercontent.com/gutierrezruarte/BibliotecaSPC/main/Escudo-1-279x300-removebg-preview.png" alt="Escudo" class="w-16 h-auto">
                            <div class="text-center">
                                <h2 class="font-bold text-base">CARTA MÉDICA</h2>
                                <p class="text-xs">SERVICIO PENITENCIARIO DE CÓRDOBA</p>
                            </div>
                            <div class="w-16"></div>
                        </div>
                        
                        <div class="border-2 border-black p-2 mb-2">
                            <h3 class="font-bold text-center text-sm mb-2 bg-gray-200 p-1">DIVISIÓN PERSONAL</h3>
                            <div class="flex justify-between text-xs break-words px-1">
                                <div class="w-1/3">
                                    <p><span class="font-semibold">UNIDAD:</span> ${incidente.unidad}</p>
                                    <p><span class="font-semibold">AFILIADO N°:</span> ${incidente.afiliado}</p>
                                    <p><span class="font-semibold">GRADO:</span> ${incidente.grado}</p>
                                    <p><span class="font-semibold">FUNCIÓN:</span> ${incidente.funcion || 'N/A'}</p> 
                                </div>
                                <div class="w-1/3">
                                    <p><span class="font-semibold">TIPO:</span> ${incidente.solicitudTipo}</p>
                                </div>
                                <div class="w-1/3 text-right">
                                     <p><span class="font-semibold">APELLIDO Y NOMBRES:</span> <span class="text-base font-bold">${incidente.empleado}</span></p>
                                     <p><span class="font-semibold">DIRECCIÓN:</span> ${incidente.direccion}</p>
                                </div>
                            </div>
                             <div class="flex justify-between text-xs break-words px-1 mt-2 border-t pt-1">
                                <div class="flex items-center space-x-4">
                                ${isEditable ? `
                                    <label class="flex items-center"><input type="radio" name="motivo_reconocimiento" value="ENFERMEDAD DEL AGENTE" ${incidente.motivo === 'ENFERMEDAD DEL AGENTE' ? 'checked' : ''}>ENF. AGENTE</label>
                                    <label class="flex items-center"><input type="radio" name="motivo_reconocimiento" value="PERSONA A CARGO / FAMILIAR" ${incidente.motivo === 'PERSONA A CARGO / FAMILIAR' || incidente.motivo === 'ENFERMEDAD DE PARIENTE' ? 'checked' : ''}>PERS. A CARGO / FAM.</label>
                                ` : `<p>${incidente.motivo}</p>`}
                                </div>
                                <div><span class="font-semibold">SOLICITUD:</span> ${formatDate(incidente.solicitudFecha)}, ${incidente.solicitudHora}</div>
                            </div>
                        </div>

                        <div class="border-2 border-black p-2">
                            <h3 class="font-bold text-center text-sm mb-2 bg-gray-200 p-1">DEPARTAMENTO RECONOCIMIENTO MÉDICO</h3>
                            <div class="grid grid-cols-1 gap-y-2 text-xs">
                                <div><label class="font-semibold">SÍNTOMAS Y SIGNOS:</label><textarea name="sintomas" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 h-12 bg-gray-50 text-xs">${incidente.reconocimiento?.sintomas || ''}</textarea></div>
                                <div><label class="font-semibold">DIAGNÓSTICO:</label><textarea name="diagnostico" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 h-12 bg-gray-50 text-xs">${incidente.reconocimiento?.diagnostico || ''}</textarea></div>
                                
                                <div class="flex justify-between items-center border-t border-b py-2 my-1">
                                    <div class="flex items-center space-x-4">
                                        <span class="font-semibold">Cumple tratamiento:</span>
                                        <label><input type="radio" name="cumpleTratamiento" value="SI" ${!isEditable ? 'disabled' : ''} ${incidente.reconocimiento?.cumpleTratamiento === 'SI' ? 'checked' : ''}>SI</label>
                                        <label><input type="radio" name="cumpleTratamiento" value="NO" ${!isEditable ? 'disabled' : ''} ${incidente.reconocimiento?.cumpleTratamiento === 'NO' ? 'checked' : ''}>NO</label>
                                    </div>
                                    <div class="font-bold text-center text-sm">MÉDICO TRATANTE</div>
                                    <div></div>
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    <div>
                                        <label class="font-semibold">MATRÍCULA:</label>
                                        <input type="text" name="medicoMatricula" value="${incidente.reconocimiento?.medicoMatricula || ''}" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 bg-gray-50 text-xs" onblur="if(this.value && ${isEditable}) fetchMedicoInfo(this.value)">
                                        <div id="medico-status-container" class="h-4 mt-1"></div> <!-- Contenedor para estado y spinner -->
                                    </div>
                                    <div><label class="font-semibold">NOMBRE Y APELLIDO:</label><input type="text" name="medicoNombre" value="${incidente.reconocimiento?.medicoNombre || ''}" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 bg-gray-50 text-xs"></div>
                                </div>
                                
                                <div class="border-t pt-2 mt-2">
                                     <p class="font-bold text-center text-sm mb-1">LICENCIA OTORGADA</p>
                                    <div class="grid grid-cols-4 gap-2 items-end">
                                        <div><label class="font-semibold">DESDE:</label><input type="date" name="licenciaDesde" value="${incidente.reconocimiento?.licenciaDesde || ''}" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 bg-gray-50 text-xs" required></div>
                                        <div><label class="font-semibold">DÍAS:</label><input type="number" name="dias" value="${incidente.reconocimiento?.dias || ''}" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 bg-gray-50 text-xs" required></div>
                                        <div><label class="font-semibold">HASTA:</label><input type="date" name="altaDesde" value="${incidente.reconocimiento?.altaDesde || ''}" readonly class="w-full border p-1 mt-1 bg-gray-200 text-xs"></div>
                                        <div><label class="font-semibold">ENCUADRA:</label><select name="encuadra" ${!isEditable ? 'disabled' : ''} class="w-full border p-1 mt-1 bg-gray-50 text-xs" required>
                                            <option value="" disabled selected>-- Sel --</option>
                                            <option value="ART. 14" ${incidente.reconocimiento?.encuadra === 'ART. 14' ? 'selected' : ''}>ART. 14</option>
                                            <option value="ART. 19" ${incidente.reconocimiento?.encuadra === 'ART. 19' ? 'selected' : ''}>ART. 19</option>
                                            <option value="ART. 20" ${incidente.reconocimiento?.encuadra === 'ART. 20' ? 'selected' : ''}>ART. 20</option>
                                            <option value="ART. 29" ${incidente.reconocimiento?.encuadra === 'ART. 29' ? 'selected' : ''}>ART. 29</option>
                                            <option value="ART. 30" ${incidente.reconocimiento?.encuadra === 'ART. 30' ? 'selected' : ''}>ART. 30</option>
                                            <option value="ART. 30 BIS" ${incidente.reconocimiento?.encuadra === 'ART. 30 BIS' ? 'selected' : ''}>ART. 30 BIS</option>
                                            <option value="SIN JUSTIFICAR" ${incidente.reconocimiento?.encuadra === 'SIN JUSTIFICAR' ? 'selected' : ''}>SIN JUSTIFICAR</option>
                                        </select></div>
                                    </div>
                                    <div class="mt-2"><label class="font-semibold">OBSERVACIONES:</label><textarea name="observaciones" ${!isEditable ? 'readonly' : ''} class="w-full border p-1 mt-1 h-12 bg-gray-50 text-xs">${incidente.reconocimiento?.observaciones || ''}</textarea></div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-12 text-right text-xs">
                             <input name="firma_linea_1" ${!isEditable ? 'readonly' : ''} class="w-1/2 ml-auto text-center border-b-2 border-black p-1 ${!isEditable ? 'border-transparent bg-transparent' : 'bg-gray-50'}" value="${incidente.reconocimiento?.firma_linea_1 || 'ALC. MY. DRA. MARÍA LAURA BARRERA'}">
                             <input name="firma_linea_2" ${!isEditable ? 'readonly' : ''} class="w-1/2 ml-auto text-center p-1 ${!isEditable ? 'border-transparent bg-transparent' : 'bg-gray-50'}" value="${incidente.reconocimiento?.firma_linea_2 || 'JEFA DPTO. REC. MÉDICOS'}">
                        </div>

                        ${isEditable ? `<div class="flex justify-end mt-4 no-print"><button type="submit" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700">${isCompleted ? 'Guardar Cambios' : 'Completar'}</button></div>` : ''}
                    </form>
                </div>`;
            showView('form');
            const form = document.getElementById('reconocimiento-form');
            if (isEditable) {
                const licenciaDesdeInput = form.querySelector('input[name="licenciaDesde"]'), diasInput = form.querySelector('input[name="dias"]'), altaDesdeInput = form.querySelector('input[name="altaDesde"]');
                function calcularAlta() { if (licenciaDesdeInput.value && diasInput.value) { const startDate = new Date(licenciaDesdeInput.value + 'T00:00:00'), days = parseInt(diasInput.value, 10); if (!isNaN(days) && days > 0) { startDate.setDate(startDate.getDate() + days - 1); altaDesdeInput.value = startDate.toISOString().slice(0, 10); } else { altaDesdeInput.value = ''; } } }
                licenciaDesdeInput.addEventListener('change', calcularAlta); diasInput.addEventListener('input', calcularAlta);
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    if (!this.elements.licenciaDesde.value || !this.elements.dias.value || !this.elements.encuadra.value) { alert('Complete los campos de Licencia.'); return; }
                    
                    const medicoMatricula = this.elements.medicoMatricula.value.trim().replace(/\//g, '_'); // SANITIZE
                    const medicoNombre = this.elements.medicoNombre.value.trim();
                    
                    const incidenteDocRef = doc(db, "incidentes", this.dataset.incidenteId); const avisoDocRef = doc(db, "avisos", this.dataset.avisoId);
                    const updatedData = { 
                        motivo: this.elements.motivo_reconocimiento.value, 
                        estado: 'Completado', 
                        reconocimiento: { 
                            observaciones: this.elements.observaciones.value, 
                            licenciaDesde: this.elements.licenciaDesde.value, 
                            dias: this.elements.dias.value, 
                            altaDesde: this.elements.altaDesde.value, 
                            encuadra: this.elements.encuadra.value, 
                            fechaEvaluacion: new Date().toISOString().slice(0, 10), 
                            sintomas: this.elements.sintomas.value, 
                            diagnostico: this.elements.diagnostico.value, 
                            cumpleTratamiento: this.elements.cumpleTratamiento.value, 
                            medicoMatricula: medicoMatricula, // SANITIZED
                            medicoNombre: medicoNombre,
                            firma_linea_1: this.elements.firma_linea_1.value,
                            firma_linea_2: this.elements.firma_linea_2.value
                        } 
                    };
                    try {
                        // Guardar/Actualizar profesional en su propia colección
                        if (medicoMatricula && medicoNombre) {
                            const profDocRef = doc(db, "profesionales", medicoMatricula); // SANITIZED
                            // Primero, verificar si existe para no sobreescribir 'verificado'
                            const profDocSnap = await getDoc(profDocRef);
                            
                            const profData = {
                                matricula: medicoMatricula, // SANITIZED
                                nombre: medicoNombre
                            };

                            if (!profDocSnap.exists()) {
                                profData.verificado = false; // Poner false solo si es nuevo
                            }
                            
                            await setDoc(profDocRef, profData, { merge: true });
                        }

                        await updateDoc(incidenteDocRef, updatedData);
                        await updateDoc(avisoDocRef, {
                            status: 'Completado',
                            diagnostico: this.elements.diagnostico.value,
                            incidenteId: this.dataset.incidenteId,
                            encuadra: this.elements.encuadra.value
                        });
                        await logActivity(isCompleted ? 'UPDATE_INCIDENTE' : 'COMPLETE_INCIDENTE', `Incidente de ${incidente.empleado}`);
                        alert('Guardado.');
                        showView('completados');
                    } catch (error) {
                        console.error(error);
                    }
                });
            }
        }
        
        async function updateAsistencia(incidenteId, field, value) { const docRef = doc(db, "incidentes", incidenteId); try { await updateDoc(docRef, { [`asistencia.${field}`]: value }); await logActivity('UPDATE_ASISTENCIA', `Actualizó asistencia para incidente ${incidenteId}.`); } catch (error) { console.error(error); } }
        
        async function fetchMedicoInfo(matricula) {
            const nombreInput = document.querySelector('input[name="medicoNombre"]');
            const statusContainer = document.getElementById('medico-status-container');
            if (!nombreInput || !statusContainer) return;

            statusContainer.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i> <span class="text-xs text-gray-500">Verificando...</span>';
            nombreInput.value = ''; // Limpiar nombre previo

            // CAMBIO: El proxy 'cors.eu.org' falla intermitentemente. 
            // Se cambia a 'api.allorigins.win'.
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            
            // La URL de destino DEBE ser codificada para este proxy.
            const targetUrl = `http://181.13.90.212:8080/consulta_matriculados.php?documento=&matricula=${matricula}`;


            try {
                // La URL final es la concatenación del proxy y la URL de destino codificada.
                const response = await fetch(`${proxyUrl}${encodeURIComponent(targetUrl)}`);
                if (!response.ok) throw new Error('Error en la red al consultar matrícula.');
                
                const html = await response.text();
                console.log("Respuesta HTML de la matrícula:", html); // <-- Para depuración
                const doc = new DOMParser().parseFromString(html, "text/html");

                // --- NUEVA ESTRATEGIA DE BÚSQUEDA ---
                // Buscamos en todas estas etiquetas, AÑADIENDO DIV y SPAN
                const elements = doc.querySelectorAll('p, h2, h3, h4, strong, b, font, div, span');
                let nombre = null;
                let status = null;

                for (let el of elements) {
                    const text = el.textContent.trim();
                    
                    // Buscar el estado (ej: "Matrícula Habilitada")
                    // CAMBIO: Usar startsWith() para ser más precisos y evitar el texto legal.
                    if (!status && text.toLowerCase().startsWith("matrícula") && text.length < 50) {
                        status = text;
                    }

                    // Buscar el nombre (ej: "Dr. LUIS ORLANDO CHANCAY")
                    if (!nombre && (text.startsWith("Dr. ") || text.startsWith("Dra. "))) {
                        nombre = text;
                    }

                    // Si ya encontramos ambos, salimos del bucle
                    if (nombre && status) break; 
                }
                // --- FIN DE LA NUEVA ESTRATEGIA ---

                // 1. Llenar el nombre SIEMPRE que se encuentre
                if (nombre) {
                    nombreInput.value = nombre;
                }

                // 2. Mostrar el estado
                if (status) {
                    // Encontramos un string de estado.
                    // Verificamos que sea "Habilitada" y no "NO Habilitada"
                    const isHabilitada = status.includes('Habilitada') && !status.includes('NO Habilitada');
                    
                    if (isHabilitada) {
                        // Estado BUENO - Solo ícono verde
                        statusContainer.innerHTML = `
                            <span class="flex items-center text-green-600" title="${status}">
                                <i class="fas fa-check-circle text-lg"></i>
                            </span>`;
                    } else {
                        // Estado MALO (NO Habilitada, etc.) - Solo ícono de alerta
                        statusContainer.innerHTML = `
                            <span class="flex items-center text-red-600">
                                <!-- Icono de alerta con tooltip que muestra el estado real -->
                                <i class="fas fa-exclamation-triangle text-lg" title="${status}"></i> 
                            </span>`;
                    }
                } else if (doc.body.textContent.includes("LA CONSULTA NO ARROJO RESULTADOS")) {
                    // Error: Matrícula no existe
                    statusContainer.innerHTML = '<p class="text-xs text-red-500">Matrícula no encontrada.</p>';
                } else {
                    // Error: No se pudo parsear (ni nombre ni estado, o uno de ellos)
                    let errorMsg = "No se pudo verificar. ";
                    if (nombre && !status) errorMsg = "(Estado no encontrado)";
                    if (!nombre && status) errorMsg = "(Nombre no encontrado)";
                    if (!nombre && !status) errorMsg = "(Nombre y Estado no encontrados)";
                    
                    statusContainer.innerHTML = `<p class="text-xs text-yellow-600">${errorMsg}</p>`;
                }
            } catch (error) {
                console.error("Error fetching medico info:", error);
                // CAMBIO: Mensaje de error mejorado para indicar la carga manual.
                statusContainer.innerHTML = '<p class="text-xs text-orange-500">Error de red. Cargue el nombre manualmente.</p>';
            }
        }

        // --- BÚSQUEDAS Y FILTROS ---
        async function filtrarEvaluadosPorFecha() { 
            const tableId = 'evaluados-table';
            const fecha = document.getElementById('fecha-evaluados').value, tableBody = document.getElementById(tableId); 
            if (!fecha) { 
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-red-500">Seleccione una fecha.</td></tr>'; 
                allDataCache[tableId] = [];
                renderPaginatedTable(tableId); // Renderiza para mostrar 0 registros
                return; 
            } 
            const q = query(collection(db, "incidentes"), where("estado", "==", "Completado"), where("reconocimiento.fechaEvaluacion", "==", fecha)); 
            const snapshot = await getDocs(q); 
            
            allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE };
            renderPaginatedTable(tableId);
        }
        
        async function searchAntecedentes() { 
            const tableId = 'antecedentes-table';
            const afiliado = document.getElementById('search-antecedentes-afiliado').value.trim();
            const matriculaInput = document.getElementById('search-antecedentes-matricula').value.trim();
            const container = document.getElementById('antecedentes-table-container'); 
            
            if (!afiliado && !matriculaInput) { 
                container.innerHTML = '<p class="text-center p-4 text-red-500">Ingrese un criterio.</p>'; 
                allDataCache[tableId] = [];
                renderPaginatedTable(tableId);
                return; 
            } 
            container.innerHTML = '<p class="text-center p-4">Buscando...</p>'; 
            
            let conditions = [where("estado", "==", "Completado")]; 
            if (afiliado) conditions.push(where("afiliado", "==", afiliado)); 
            if (matriculaInput) {
                const matriculaSanitized = matriculaInput.replace(/\//g, '_'); // SANITIZE SEARCH
                conditions.push(where("reconocimiento.medicoMatricula", "==", matriculaSanitized)); 
            }
            const q = query(collection(db, "incidentes"), ...conditions), snapshot = await getDocs(q); 
            
            if (snapshot.empty) { 
                container.innerHTML = '<p class="text-center p-4">No se encontraron antecedentes.</p>'; 
                allDataCache[tableId] = [];
            } else { 
                // Prepara el HTML de la tabla, pero la data se guarda en el caché
                container.innerHTML = `<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="text-xs text-gray-700 uppercase bg-gray-50"><th class="px-6 py-3">Afiliado</th><th class="px-6 py-3">Empleado</th><th class="px-6 py-3">Dep.</th><th class="px-6 py-3">Fecha Ev.</th><th class="px-6 py-3">Diagnóstico</th><th class="px-6 py-3">Médico</th><th class="px-6 py-3">Acción</th></tr></thead><tbody id="antecedentes-table"></tbody></table></div>`;
                allDataCache[tableId] = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            }
            paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE };
            renderPaginatedTable(tableId);
        }

        async function filtrarPresentarse() {
            const tableId = 'presentarse-table';
            const fecha = document.getElementById('fecha-presentarse').value,
                unidad = document.getElementById('unidad-presentarse').value,
                tableBody = document.getElementById(tableId);
            if (!fecha) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-red-500">Seleccione una fecha.</td></tr>';
                allDataCache[tableId] = [];
                renderPaginatedTable(tableId);
                return;
            }

            const fechaPresentarse = new Date(fecha + 'T00:00:00');
            fechaPresentarse.setDate(fechaPresentarse.getDate() - 1);
            const fechaAltaQuery = fechaPresentarse.toISOString().slice(0, 10);

            let conditions = [where("reconocimiento.altaDesde", "==", fechaAltaQuery)];
            if (unidad !== 'TODAS') {
                conditions.push(where("unidad", "==", unidad));
            }

            const q = query(collection(db, "incidentes"), ...conditions),
                snapshot = await getDocs(q);
            
            allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE };
            renderPaginatedTable(tableId);
        }
        
        function openAvisosFechaModal() { document.getElementById('avisos-fecha-modal').classList.add('flex'); document.getElementById('avisos-fecha-modal').classList.remove('hidden'); }
        function closeAvisosFechaModal() { document.getElementById('avisos-fecha-modal').classList.add('hidden'); document.getElementById('avisos-fecha-modal').classList.remove('flex'); }
        
        // --- INICIO DE LA CORRECCIÓN ---
        async function searchAvisosPorFecha() { 
            const tableId = 'avisos-fecha-table'; // ID de la tbody
            currentAvisosSearchResult = []; // Mantener para exportar
            const fechaDesde = document.getElementById('search-fecha-aviso-desde').value;
            const fechaHasta = document.getElementById('search-fecha-aviso-hasta').value;
            const encuadraFiltro = document.getElementById('search-encuadra-aviso').value;
            const resultsDiv = document.getElementById('avisos-fecha-results');
            const tableBody = document.getElementById(tableId);
            if (!tableBody) return; // Salir si la tabla no está

            if (!fechaDesde || !fechaHasta) {
                resultsDiv.querySelector('p.text-center').textContent = 'Por favor, seleccione un período de fechas completo.';
                tableBody.innerHTML = '';
                allDataCache[tableId] = [];
                renderPaginatedTable(tableId);
                return;
            }
             if (fechaDesde > fechaHasta) {
                resultsDiv.querySelector('p.text-center').textContent = 'La fecha "Desde" no puede ser posterior a la fecha "Hasta".';
                tableBody.innerHTML = '';
                allDataCache[tableId] = [];
                renderPaginatedTable(tableId);
                return;
            }
            resultsDiv.querySelector('p.text-center').textContent = 'Buscando...';
            tableBody.innerHTML = '';
            
            let conditions = [];
            
            if (selectedRole === 'personal' && currentUserUnidad !== 'TODAS') {
                conditions.push(where("unidad", "==", currentUserUnidad));
            } else {
                conditions.push(where("fecha", ">=", fechaDesde));
                conditions.push(where("fecha", "<=", fechaHasta));
            }

            const q = query(collection(db, "avisos"), ...conditions);
            const snapshot = await getDocs(q); 
            
            // Obtenemos los documentos Y SUS IDs
            const allDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // 2. Filtramos los resultados en JavaScript
            const filteredDocs = allDocs.filter(aviso => {
                const isPersonal = selectedRole === 'personal' && currentUserUnidad !== 'TODAS';
                
                if (isPersonal) {
                    if (aviso.fecha < fechaDesde || aviso.fecha > fechaHasta) {
                        return false;
                    }
                }
                
                if (encuadraFiltro && encuadraFiltro !== 'TODOS') {
                    if (aviso.encuadra !== encuadraFiltro) {
                        return false;
                    }
                }
                
                return true;
            });
            
            if (filteredDocs.length === 0) { 
                resultsDiv.querySelector('p.text-center').textContent = 'No se encontraron avisos para este período y filtro.';
                currentAvisosSearchResult = []; 
                allDataCache[tableId] = [];
            } else {
                resultsDiv.querySelector('p.text-center').textContent = ''; // Ocultar mensaje
                currentAvisosSearchResult = filteredDocs; // Guardar para exportar
                allDataCache[tableId] = filteredDocs; // Guardar para paginación
            }
            
            paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE };
            renderPaginatedTable(tableId);
        }
        // --- FIN DE LA CORRECCIÓN ---

        function exportAvisosToXLS() {
            if (currentAvisosSearchResult.length === 0) {
                alert("No hay datos para exportar. Por favor, realice una búsqueda primero.");
                return;
            }

            const dataToExport = currentAvisosSearchResult.map(aviso => ({
                'Afiliado': aviso.afiliado,
                'Empleado': aviso.empleado,
                'Unidad': aviso.unidad,
                'Fecha Aviso': aviso.fecha,
                'Estado': aviso.status,
                'Diagnóstico': aviso.diagnostico || 'N/A',
                'Encuadre': aviso.encuadre || 'N/A' // La exportación usará el dato 'encuadre' del aviso (podría no estar actualizado si es antiguo)
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Avisos");
            const fechaDesde = document.getElementById('search-fecha-aviso-desde').value;
            const fechaHasta = document.getElementById('search-fecha-aviso-hasta').value;
            const fileName = `Reporte_Avisos_${fechaDesde}_a_${fechaHasta}.xlsx`;
            XLSX.writeFile(wb, fileName);
            logActivity('EXPORT_XLS', `Exportó ${currentAvisosSearchResult.length} avisos a Excel.`);
        }

        // Nueva función para sincronizar y luego escuchar
        async function synchronizeAndListenProfesionales() {
            if (isSyncingProfesionales) return; // Evita ejecuciones múltiples
            isSyncingProfesionales = true;
            
            const tableBody = document.getElementById('profesionales-table');
            // CAMBIO: Colspan actualizado a 4
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Sincronizando profesionales desde cartas médicas...</td></tr>';

            try {
                // 1. Obtener todos los profesionales de las cartas médicas (incidentes)
                const incidentesQuery = query(collection(db, "incidentes"), where("estado", "==", "Completado"));
                const incidentesSnap = await getDocs(incidentesQuery);
                
                const profesionalesEnIncidentes = new Map();
                incidentesSnap.forEach(doc => {
                    const rec = doc.data().reconocimiento;
                    if (rec && rec.medicoMatricula && rec.medicoNombre) {
                        const matricula = rec.medicoMatricula.trim().replace(/\//g, '_'); // SANITIZE
                        if (matricula && !profesionalesEnIncidentes.has(matricula)) {
                            profesionalesEnIncidentes.set(matricula, {
                                matricula: matricula,
                                nombre: rec.medicoNombre.trim()
                            });
                        }
                    }
                });

                // 2. Sincronizar con la colección 'profesionales' (añadir los que falten)
                if (profesionalesEnIncidentes.size > 0) {
                    const batch = writeBatch(db);
                    profesionalesEnIncidentes.forEach((prof, matricula) => {
                        const docRef = doc(db, "profesionales", matricula);
                        // Usamos merge: true para no sobrescribir el estado 'verificado' si ya existe
                        // y solo añadimos el nombre (la matricula es el ID)
                        batch.set(docRef, {
                            matricula: prof.matricula,
                            nombre: prof.nombre
                        }, { merge: true });
                    });
                    await batch.commit();
                }

                // 3. Ahora que está sincronizado, escuchar la colección 'profesionales'
                listenToProfesionalesCollection();

            } catch (error) {
                console.error("Error sincronizando profesionales: ", error);
                // CAMBIO: Colspan actualizado a 4
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">Error al cargar profesionales.</td></tr>';
            } finally {
                isSyncingProfesionales = false;
            }
        }

        function listenToProfesionalesCollection() {
            const tableId = 'profesionales-table';
            const baseTitle = 'Gestión de Profesionales';
            const viewHeader = document.querySelector('#profesionales-view h2');

            unsubscribeProfesionales = onSnapshot(collection(db, "profesionales"), (snapshot) => {
                const totalCount = snapshot.size;
                const titleWithCount = `${baseTitle} (${totalCount})`;
                viewHeader.textContent = titleWithCount;
                if (!document.getElementById('profesionales-view').classList.contains('hidden')) {
                    document.getElementById('view-title').textContent = titleWithCount;
                }

                allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!paginationState[tableId]) {
                    paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE };
                }
                renderPaginatedTable(tableId);
            });
        }

        // --- NUEVA FUNCIÓN ---
        async function updateProfesionalObservaciones(matricula, observaciones) {
            const docRef = doc(db, "profesionales", matricula);
            try {
                await updateDoc(docRef, { observaciones: observaciones });
                await logActivity('UPDATE_PROFESIONAL_OBS', `Observación para ${matricula}: ${observaciones}`);
            } catch (error) {
                console.error("Error al actualizar observación: ", error);
                alert("Error al guardar la observación.");
            }
        }
        // --- FIN NUEVA FUNCIÓN ---
        
        // --- NUEVA FUNCIÓN AUXILIAR PARA TEXTAREA ---
        function handleObsTextareaKeydown(event, matricula, value) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Evita el salto de línea
                updateProfesionalObservaciones(matricula, value);
                event.target.blur(); // Quita el foco
            }
        }
        // --- FIN FUNCIÓN AUXILIAR ---

        async function toggleVerificado(matricula) {
            const docRef = doc(db, "profesionales", matricula);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const newState = !docSnap.data().verificado; // Invierte el estado actual
                    await updateDoc(docRef, { verificado: newState });
                    await logActivity('VERIFY_PROFESIONAL', `Verificación de ${matricula} cambiada a ${newState}.`);
                }
            } catch (error) {
                console.error("Error al actualizar verificación: ", error);
            }
        }

        function listenToActivityLog() {
            const tableId = 'registro-table';
            const baseTitle = 'Registro de Actividad del Sistema';
            const viewHeader = document.querySelector('#registro-view h2');
            
            const q = query(collection(db, "activityLog"), orderBy("timestamp", "desc"));
            unsubscribeRegistro = onSnapshot(q, (snapshot) => {
                const totalCount = snapshot.size;
                const titleWithCount = `${baseTitle} (${totalCount})`;
                viewHeader.textContent = titleWithCount;
                if (!document.getElementById('registro-view').classList.contains('hidden')) {
                    document.getElementById('view-title').textContent = titleWithCount;
                }

                allDataCache[tableId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!paginationState[tableId]) {
                    paginationState[tableId] = { currentPage: 1, rowsPerPage: ROWS_PER_PAGE };
                }
                renderPaginatedTable(tableId);
            });
        }
        
        // --- INICIO: FUNCIONES DE PAGINACIÓN Y RENDERIZADO ---

        // El 'filterTable' ahora solo necesita saber qué tabla re-renderizar
        function filterTable(tableId) {
            if (paginationState[tableId]) {
                paginationState[tableId].currentPage = 1; // Resetea a la página 1 al filtrar
            }
            renderPaginatedTable(tableId);
        }
        
        function changePage(tableId, direction) {
            const state = paginationState[tableId];
            if (!state) return;
            
            const newPage = state.currentPage + direction;
            const totalRows = (allDataCache[tableId] || []).length; // Usa el caché completo
            const totalPages = Math.ceil(totalRows / state.rowsPerPage);

            if (newPage >= 1 && newPage <= totalPages) {
                state.currentPage = newPage;
                renderPaginatedTable(tableId);
            }
        }

        function renderPaginatedTable(tableId) {
            const tableBody = document.getElementById(tableId);
            const controlsContainer = document.getElementById(`${tableId}-pagination`);
            if (!tableBody || !controlsContainer) return;

            // 1. Obtener la data y el estado
            const allData = allDataCache[tableId] || [];
            const state = paginationState[tableId];
            if (!state) return;

            // 2. Definir los parámetros de filtrado y renderizado (específicos de cada tabla)
            let searchInputId, columnsToSearch, rowRenderer, emptyMessage, colspan;
            switch (tableId) {
                case 'usuarios-table':
                    searchInputId = 'search-usuarios';
                    columnsToSearch = [ (item) => item.afiliado, (item) => item.nombreCompleto ];
                    rowRenderer = getUsuarioRowHtml;
                    emptyMessage = 'No hay usuarios.'; colspan = 4;
                    break;
                case 'avisos-pendientes-table':
                    searchInputId = 'search-avisos-pendientes';
                    columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado, (item) => item.unidad ];
                    rowRenderer = (item) => getAvisoRowHtml(item, true);
                    emptyMessage = 'No hay avisos pendientes.'; colspan = 6;
                    break;
                case 'avisos-visados-table':
                    searchInputId = 'search-avisos-visados';
                    columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado, (item) => item.unidad, (item) => item.diagnostico ];
                    rowRenderer = (item) => getAvisoRowHtml(item, false);
                    emptyMessage = 'No hay avisos visados.'; colspan = 7;
                    break;
                case 'pendientes-table':
                    searchInputId = 'search-pendientes';
                    columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado ];
                    rowRenderer = (item) => getIncidenteRowHtml(item, true);
                    emptyMessage = 'No hay incidentes pendientes.'; colspan = 6;
                    break;
                case 'completados-table':
                    searchInputId = 'search-completados';
                    columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado ];
                    rowRenderer = (item) => getIncidenteRowHtml(item, false);
                    emptyMessage = 'No hay incidentes completados.'; colspan = 6;
                    break;
                case 'evaluados-table':
                    searchInputId = 'search-evaluados';
                    columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado, (item) => item.reconocimiento?.encuadra ];
                    rowRenderer = getEvaluadoRowHtml;
                    emptyMessage = 'No hay evaluados para esta fecha.'; colspan = 7;
                    break;
                case 'antecedentes-table':
                    searchInputId = 'search-antecedentes';
                    columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado, (item) => item.reconocimiento?.diagnostico, (item) => item.reconocimiento?.medicoNombre ];
                    rowRenderer = getAntecedenteRowHtml;
                    emptyMessage = 'No se encontraron antecedentes.'; colspan = 7;
                    break;
                case 'profesionales-table':
                    searchInputId = 'search-profesionales';
                    columnsToSearch = [ (item) => item.matricula, (item) => item.nombre, (item) => item.observaciones ];
                    rowRenderer = getProfesionalRowHtml;
                    emptyMessage = 'No hay profesionales.'; colspan = 4;
                    break;
                case 'registro-table':
                    searchInputId = 'search-registro';
                    columnsToSearch = [ (item) => item.userAfiliado, (item) => item.userName, (item) => item.action, (item) => item.description ];
                    rowRenderer = getActivityLogRowHtml;
                    emptyMessage = 'No hay actividad registrada.'; colspan = 6;
                    break;
                case 'presentarse-table':
                    searchInputId = 'search-presentarse';
                    columnsToSearch = [ (item) => item.afiliado, (item) => item.empleado, (item) => item.unidad ];
                    rowRenderer = (item) => getPresentarseRowHtml(item); // getPresentarseRowHtml se encargará de la lógica de 'isEditable'
                    emptyMessage = 'No hay personal a presentarse.'; colspan = 9;
                    break;
                case 'avisos-fecha-table': // Modal de búsqueda por fecha
                    searchInputId = null; // No hay filtro en este modal
                    columnsToSearch = [];
                    rowRenderer = getAvisoFechaRowHtml;
                    emptyMessage = 'No se encontraron avisos.'; colspan = 7;
                    break;
                default:
                    return; // No renderizar si la tabla no está configurada
            }

            // 3. Aplicar filtro
            const filterInput = searchInputId ? document.getElementById(searchInputId) : null;
            const filter = filterInput ? filterInput.value.toUpperCase() : '';
            
            const filteredData = allData.filter(item => {
                if (filter === '') return true;
                return columnsToSearch.some(getter => {
                    const value = getter(item);
                    return value && value.toString().toUpperCase().includes(filter);
                });
            });

            // 4. Calcular paginación
            const totalRows = filteredData.length;
            const totalPages = Math.ceil(totalRows / state.rowsPerPage);
            if (state.currentPage > totalPages && totalPages > 0) {
                state.currentPage = totalPages; // Ajusta si la página actual es inválida
            }
            if (state.currentPage === 0 && totalPages > 0) {
                state.currentPage = 1; // Asegura que la página sea al menos 1
            }

            const startIndex = (state.currentPage - 1) * state.rowsPerPage;
            const endIndex = startIndex + state.rowsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            // 5. Renderizar filas
            tableBody.innerHTML = '';
            if (pageData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-4">${emptyMessage}</td></tr>`;
            } else {
                pageData.forEach(item => {
                    tableBody.innerHTML += rowRenderer(item);
                });
            }

            // 6. Renderizar controles de paginación
            controlsContainer.innerHTML = '';
            if (totalPages > 1) {
                controlsContainer.innerHTML = `
                    <button onclick="changePage('${tableId}', -1)" ${state.currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <span>Página ${state.currentPage} de ${totalPages} (${totalRows} registros)</span>
                    <button onclick="changePage('${tableId}', 1)" ${state.currentPage === totalPages ? 'disabled' : ''}>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                `;
            } else {
                controlsContainer.innerHTML = `<span>${totalRows} registros</span>`;
            }
        }

        // --- Funciones de renderizado de filas ---

        function getUsuarioRowHtml(user) {
            const roles = Array.isArray(user.roles) ? user.roles.join(', ') : (user.role || 'N/A');
            return `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4">${user.afiliado}</td><td class="px-6 py-4">${user.nombreCompleto}</td><td class="px-6 py-4 capitalize">${roles}</td><td class="px-6 py-4 space-x-2"><button onclick="openUsuarioModal('${user.afiliado}')" class="text-blue-600 hover:text-blue-800" title="Editar"><i class="fas fa-edit"></i></button><button onclick="resetPassword('${user.afiliado}')" class="text-yellow-600 hover:text-yellow-800" title="Blanquear Contraseña"><i class="fas fa-key"></i></button><button onclick="deleteUser('${user.afiliado}')" class="text-red-600 hover:text-red-800" title="Eliminar"><i class="fas fa-trash"></i></button></td></tr>`;
        }

        function getAvisoRowHtml(aviso, isPending) {
            let actionsHtml = '<td class="px-6 py-4 space-x-2 text-right">';
            if (isPending) {
                const canEdit = (selectedRole === 'administrador') || (selectedRole === 'personal');
                const canDelete = selectedRole === 'administrador';
                if (canEdit) actionsHtml += `<button onclick="openAvisoModal('${aviso.id}')" class="text-blue-600 hover:text-blue-800" title="Editar"><i class="fas fa-edit"></i></button>`;
                if (canDelete) actionsHtml += `<button onclick="deleteAviso('${aviso.id}')" class="text-red-600 hover:text-red-800" title="Eliminar"><i class="fas fa-trash"></i></button>`;
            } else { // Visados
                if (aviso.incidenteId) {
                    actionsHtml += `<button onclick="openFormulario('${aviso.incidenteId}', 'avisos-visados', true)" class="text-gray-500 hover:text-blue-600" title="Ver Carta Médica"><i class="fas fa-eye"></i></button>`;
                }
                if (selectedRole === 'administrador') {
                    actionsHtml += `<button onclick="openAvisoModal('${aviso.id}')" class="text-blue-600 hover:text-blue-800" title="Editar"><i class="fas fa-edit"></i></button>`;
                    actionsHtml += `<button onclick="deleteAviso('${aviso.id}')" class="text-red-600 hover:text-red-800" title="Eliminar"><i class="fas fa-trash"></i></button>`;
                }
            }
            actionsHtml += '</td>';
            const diagnosticoColumn = isPending ? '' : `<td class="px-6 py-4 text-xs">${aviso.diagnostico || 'N/A'}</td>`;
            return `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4">${aviso.afiliado || 'N/A'}</td><td class="px-6 py-4">${aviso.empleado}</td><td class="px-6 py-4">${getUnidadTag(aviso.unidad)}</td><td class="px-6 py-4">${formatDate(aviso.fecha)}</td><td class="px-6 py-4">${aviso.unidad}</td>${diagnosticoColumn}${actionsHtml}</tr>`;
        }

        function getIncidenteRowHtml(incidente, isPending) {
            const dateField = formatDate(isPending ? incidente.solicitudFecha : (incidente.reconocimiento?.fechaEvaluacion));
            const btnText = isPending ? 'Evaluar' : 'Ver/Editar';
            const view = isPending ? 'pendientes' : 'completados';
            return `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4">${incidente.id || 'N/A'}</td><td class="px-6 py-4">${incidente.afiliado || 'N/A'}</td><td class="px-6 py-4">${incidente.empleado}</td><td class="px-6 py-4">${getUnidadTag(incidente.unidad)}</td><td class="px-6 py-4">${dateField}</td><td class="px-6 py-4"><button onclick="openFormulario('${incidente.id}', '${view}')" class="text-blue-600 hover:underline">${btnText}</button></td></tr>`;
        }

        function getEvaluadoRowHtml(inc) {
            return `<tr class="bg-white border-b"><td class="px-6 py-4">${inc.id}</td><td class="px-6 py-4">${inc.afiliado}</td><td class="px-6 py-4">${inc.empleado}</td><td class="px-6 py-4">${getUnidadTag(inc.unidad)}</td><td class="px-6 py-4">${formatDate(inc.reconocimiento.fechaEvaluacion)}</td><td class="px-6 py-4">${inc.reconocimiento.encuadra}</td><td class="px-6 py-4"><button onclick="openFormulario('${inc.id}', 'evaluados')" class="text-blue-600 hover:underline">Ver</button></td></tr>`;
        }
        
        function getAntecedenteRowHtml(i) {
            const r = i.reconocimiento;
            return `<tr class="bg-white border-b"><td class="px-6 py-4">${i.afiliado}</td><td class="px-6 py-4">${i.empleado}</td><td class="px-6 py-4">${getUnidadTag(i.unidad)}</td><td class="px-6 py-4">${formatDate(r.fechaEvaluacion)}</td><td class="px-6 py-4">${r.diagnostico||'N/A'}</td><td class="px-6 py-4">${r.medicoNombre||'N/A'} (Mat: ${r.medicoMatricula||'N/A'})</td><td classD="px-6 py-4"><button onclick="openFormulario('${i.id}', 'antecedentes')" class="text-blue-600 hover:underline">Ver</button></td></tr>`;
        }
        
        function getPresentarseRowHtml(inc) {
            const finLicencia = inc.reconocimiento.altaDesde;
            const fechaPresentarse = new Date(finLicencia + 'T00:00:00');
            fechaPresentarse.setDate(fechaPresentarse.getDate() + 1);
            const debePresentarse = fechaPresentarse.toISOString().slice(0, 10);

            const isEditable = selectedRole === 'personal' && currentUserUnidad !== 'TODAS' && inc.unidad === currentUserUnidad;
            const presento = isEditable ? `<input type="checkbox" onchange="updateAsistencia('${inc.id}','sePresento',this.checked)" ${inc.asistencia?.sePresento ? 'checked' : ''}>` : (inc.asistencia?.sePresento ? 'Sí' : 'No');
            const comunico = isEditable ? `<input type="checkbox" onchange="updateAsistencia('${inc.id}','seComunico',this.checked)" ${inc.asistencia?.seComunico ? 'checked' : ''}>` : (inc.asistencia?.seComunico ? 'Sí' : 'No');
            const obs = isEditable ? `<textarea oninput="updateAsistencia('${inc.id}','observaciones',this.value)" class="w-full border p-1">${inc.asistencia?.observaciones || ''}</textarea>` : `<p>${inc.asistencia?.observaciones || ''}</p>`;
            return `<tr class="bg-white border-b"><td class="px-6 py-4">${inc.afiliado}</td><td class="px-6 py-4">${inc.empleado}</td><td class="px-6 py-4">${getUnidadTag(inc.unidad)}</td><td class="px-6 py-4">${inc.unidad}</td><td class="px-6 py-4">${formatDate(finLicencia)}</td><td class="px-6 py-4">${formatDate(debePresentarse)}</td><td class="px-6 py-4">${presento}</td><td class="px-6 py-4">${comunico}</td><td class="px-6 py-4">${obs}</td></tr>`;
        }

        function getProfesionalRowHtml(prof) {
            const rowClass = prof.verificado ? 'bg-green-100 text-green-900' : 'bg-white';
            const textClass = prof.verificado ? 'font-medium' : '';
            return `
                <tr class="${rowClass} border-b hover:bg-gray-50">
                    <td class="px-6 py-4 ${textClass}">${prof.matricula}</td>
                    <td class="px-6 py-4 ${textClass}">${prof.nombre}</td>
                    <td class="px-6 py-4">
                        <input type="checkbox" ${prof.verificado ? 'checked' : ''} onchange="toggleVerificado('${prof.matricula}')" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    </td>
                    <td class="px-6 py-4">
                        <textarea
                            onblur="updateProfesionalObservaciones('${prof.matricula}', this.value)"
                            onkeydown="handleObsTextareaKeydown(event, '${prof.matricula}', this.value)"
                            class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg p-2"
                            rows="2"
                            placeholder="Añadir nota...">${prof.observaciones || ''}</textarea>
                    </td>
                </tr>`;
        }

        function getActivityLogRowHtml(log) {
            const date = log.timestamp.toDate(); 
            const formattedDate = date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + date.toLocaleTimeString('es-AR');
            return `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 text-gray-500 text-xs">${formattedDate}</td><td class="px-6 py-4">${log.userAfiliado}</td><td class="px-6 py-4 font-medium">${log.userName}</td><td class="px-6 py-4">${log.action}</td><td class="px-6 py-4 capitalize">${log.userRole}</td><td class="px-6 py-4 text-sm">${log.description}</td></tr>`; 
        }

        function getAvisoFechaRowHtml(aviso) {
            const statusClass = aviso.status === 'Completado' ? 'text-green-600' : 'text-yellow-600';
            // Nota: La lógica para obtener 'encuadre' si falta ya no se puede hacer aquí sin async
            // Se asume que la data está como está en el caché.
            const encuadreHtml = aviso.encuadre || (aviso.status === 'Completado' ? 'N/A' : '');
            return `<tr class="bg-white border-b"><td class="px-4 py-2">${aviso.afiliado || 'N/A'}</td><td class="px-4 py-2">${aviso.empleado}</td><td class="px-4 py-2">${getUnidadTag(aviso.unidad)}</td><td class="px-4 py-2">${aviso.unidad}</td><td class="px-4 py-2">${formatDate(aviso.fecha)}</td><td class="px-4 py-2 font-semibold ${statusClass}">${aviso.status}</td><td class="px-4 py-2">${encuadreHtml}</td></tr>`;
        }

        // --- FIN: FUNCIONES DE PAGINACIÓN ---
        
        // CAMBIO: filterTable ahora puede leer el valor de inputs de texto o textareas
        /*
        function filterTable(inputId, tableId, columnsToSearch) { 
            const input = document.getElementById(inputId), filter = input.value.toUpperCase(), table = document.getElementById(tableId), tr = table.getElementsByTagName("tr"); 
            for (let i = 0; i < tr.length; i++) { 
                let found = false; 
                const tds = tr[i].getElementsByTagName("td"); 
                if (tds.length > 0) { 
                    for (const colIndex of columnsToSearch) { 
                        if(tds[colIndex]) { 
                            let cellText = '';
                            const inputEl = tds[colIndex].querySelector('input[type="text"], textarea'); // Revisa input o textarea
                            if (inputEl) {
                                cellText = inputEl.value; // Usa el valor del input/textarea
                            } else {
                                cellText = (tds[colIndex].textContent || tds[colIndex].innerText); // Usa el texto normal
                            }
                            
                            if (cellText.toUpperCase().indexOf(filter) > -1) { 
                                found = true; 
                                break; 
                            } 
                        } 
                    } 
                    tr[i].style.display = found ? "" : "none"; 
                } 
            } 
        }
        */
        
        function sortTable(tableId, colIndex) {
            const table = document.getElementById(tableId);
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);
            const key = `${tableId}-${colIndex}`;
            const currentDir = sortState[key] || 'asc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            sortState[key] = newDir;

            // Reset sort icons
            table.querySelectorAll('th i.fa-sort').forEach(icon => {
                icon.classList.remove('fa-sort-up', 'fa-sort-down');
                icon.classList.add('fa-sort');
            });
            const headerIcon = table.querySelector(`th:nth-child(${colIndex + 1}) i`);
            headerIcon.classList.remove('fa-sort');
            headerIcon.classList.add(newDir === 'asc' ? 'fa-sort-up' : 'fa-sort-down');

            rows.sort((a, b) => {
                let valA, valB;
                
                // Si es la columna de 'Verificado', compara el estado del checkbox
                if (tableId === 'profesionales-table' && colIndex === 2) {
                    valA = a.cells[colIndex].querySelector('input[type="checkbox"]').checked;
                    valB = b.cells[colIndex].querySelector('input[type="checkbox"]').checked;
                // CAMBIO: Si es la columna de 'Observaciones', compara el valor del textarea
                } else if (tableId === 'profesionales-table' && colIndex === 3) {
                    valA = a.cells[colIndex].querySelector('textarea').value.toUpperCase();
                    valB = b.cells[colIndex].querySelector('textarea').value.toUpperCase();
                } else {
                    valA = a.cells[colIndex].textContent.trim();
                    valB = b.cells[colIndex].textContent.trim();
                    if (!isNaN(valA) && !isNaN(valB)) {
                        // Trata como número si es numérico
                        valA = parseFloat(valA);
                        valB = parseFloat(valB);
                    } else {
                        // Trata como texto
                        valA = valA.toUpperCase();
                        valB = valB.toUpperCase();
                    }
                }

                if (valA < valB) return newDir === 'asc' ? -1 : 1;
                if (valA > valB) return newDir === 'asc' ? 1 : -1;
                return 0;
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        window.onload = () => { 
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('solicitud-fecha').value = today;
            document.getElementById('search-fecha-aviso-desde').value = today;
            document.getElementById('search-fecha-aviso-hasta').value = today;
            // CAMBIO: Añadidas las nuevas funciones al objeto window
            Object.assign(window, { 
                selectRole, goBackToRoleSelection, continueLoginPersonal, goBackToLogin, logout, 
                showView, openUsuarioModal, closeUsuarioModal, precargarDatosUsuario, resetPassword, deleteUser, 
                handleFileUpload, openAvisoModal, closeAvisoModal, precargarDatosAfiliado, deleteAviso, 
                openFormulario, updateAsistencia, filtrarEvaluadosPorFecha, filtrarPresentarse, searchAntecedentes, 
                openChangePasswordModal, closeChangePasswordModal, 
                filterTable, // Ahora es el trigger de repaginado
                changePage, // Nueva función de paginación
                openAvisosFechaModal, closeAvisosFechaModal, searchAvisosPorFecha, exportAvisosToXLS, 
                toggleVerificado, sortTable, synchronizeAndListenProfesionales, listenToProfesionalesCollection, 
                fetchMedicoInfo, updateProfesionalObservaciones, handleObsTextareaKeydown 
            }); 
        };
    </script>
</body>
</html>
